<!doctype html>
<html lang="tr">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOF Ana Liste</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Calibri', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .table-container {
            overflow-x: auto;
            max-width: 100%;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 2000px;
        }
        
        th, td {
            border: 1px solid #d1d5db;
            padding: 8px;
            text-align: left;
            font-size: 12px;
            white-space: nowrap;
        }
        
        th {
            background-color: #2459a0;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        tr:nth-child(odd) {
            background-color: white;
        }
        
        input[type="text"], input[type="number"], input[type="date"], select {
            width: 100%;
            padding: 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .total-row {
            background-color: #fef3c7 !important;
            font-weight: bold;
        }
        
        .selected-row {
            background-color: #dbeafe !important;
        }
        
        .btn {
            padding: 8px 16px;
            margin: 4px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: #2459a0;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1e40af;
        }
        
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        
        .btn-success {
            background-color: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #047857;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="bg-gray-100 min-h-full">
  <div class="container mx-auto p-6 bg-white shadow-lg rounded-lg my-4">
   <header class="mb-6 text-center">
    <h1 id="system-title" class="text-3xl font-bold text-gray-800 mb-2">SOF Ana Liste</h1>
    <p id="company-name" class="text-lg text-gray-600">Malzeme Talep Yönetim Sistemi</p>
   </header>
   <div class="mb-6 flex flex-wrap gap-2 justify-center"><button id="yeni-talep-btn" class="btn btn-primary"> 📝 Yeni Talep Başlat </button> <button id="alt-satir-btn" class="btn btn-secondary"> ➕ Alt Satır Ekle </button> <button id="satir-sil-btn" class="btn btn-danger"> 🗑️ Satır Sil </button> <button id="kaydet-btn" class="btn btn-success"> 💾 Kaydet </button>
   </div>
   <div id="loading-indicator" class="hidden text-center py-4">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
    <p class="mt-2 text-gray-600">İşlem yapılıyor...</p>
   </div>
   <div class="table-container">
    <table id="sof-table">
     <thead>
      <tr>
       <th>Seç</th>
       <th>SIRA NO</th>
       <th>SOF FORM NO</th>
       <th>PROJE KODU</th>
       <th>TALEP NO</th>
       <th>MALZEME TİPİ</th>
       <th>TALEP EDEN</th>
       <th>TALEP TARİHİ</th>
       <th>İSTENEN TESLİM TARİHİ</th>
       <th>TALEP EDİLEN MALZEME</th>
       <th>DETAY 1 (MARKA, MODEL VB)</th>
       <th>DETAY 2 (PROJE, STANDART VB KODLAR)</th>
       <th>BİRİM</th>
       <th>TALEP MİKTARI</th>
       <th>SİPARİŞ MİKTARI</th>
       <th>BİRİM FİYAT (₽ RUB)</th>
       <th>TOPLAM FİYAT (₽ RUB)</th>
       <th>TEDARİKÇİ</th>
       <th>SATINALMA SORUMLUSU</th>
       <th>PLANLANAN TESLİM TARİHİ</th>
       <th>TESLİMAT MİKTARI</th>
       <th>TESLİMAT TARİHİ</th>
       <th>KALAN MİKTAR</th>
       <th>ONAY DURUMU</th>
       <th>AÇIKLAMA</th>
      </tr>
     </thead>
     <tbody id="table-body">
     </tbody>
     <tfoot>
      <tr class="total-row">
       <td colspan="16" class="text-right font-bold">GENEL TOPLAM (₽ RUB):</td>
       <td id="genel-toplam" class="font-bold">0.00</td>
       <td colspan="8"></td>
      </tr>
     </tfoot>
    </table>
   </div>
  </div>
  <script>
        let currentData = [];
        let selectedRowIndex = -1;
        let nextSiraNo = 1;
        let nextFormNo = 1;
        let currentFormNo = '';
        let isLoading = false;

        const defaultConfig = {
            system_title: "SOF Ana Liste",
            company_name: "Malzeme Talep Yönetim Sistemi"
        };

        const dataHandler = {
            onDataChanged(data) {
                currentData = data.sort((a, b) => a.sira_no - b.sira_no);
                updateNextNumbers();
                renderTable();
                calculateTotal();
            }
        };

        function updateNextNumbers() {
            if (currentData.length > 0) {
                nextSiraNo = Math.max(...currentData.map(item => item.sira_no)) + 1;
                const formNumbers = currentData.map(item => {
                    const match = item.sof_form_no.match(/RF100\.SOF-(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                });
                nextFormNo = Math.max(...formNumbers, 0) + 1;
            }
        }

        function showLoading() {
            isLoading = true;
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.querySelectorAll('.btn').forEach(btn => btn.disabled = true);
        }

        function hideLoading() {
            isLoading = false;
            document.getElementById('loading-indicator').classList.add('hidden');
            document.querySelectorAll('.btn').forEach(btn => btn.disabled = false);
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function createNewRow(formNo = null) {
            const today = formatDate(new Date());
            
            if (!formNo) {
                currentFormNo = `RF100.SOF-${String(nextFormNo).padStart(4, '0')}`;
                nextFormNo++;
            } else {
                currentFormNo = formNo;
            }

            return {
                sira_no: nextSiraNo++,
                sof_form_no: currentFormNo,
                proje_kodu: '',
                talep_no: '',
                malzeme_tipi: '',
                talep_eden: '',
                talep_tarihi: today,
                istenen_teslim_tarihi: '',
                talep_edilen_malzeme: '',
                detay_1: '',
                detay_2: '',
                birim: '',
                talep_miktari: 0,
                siparis_miktari: 0,
                birim_fiyat: 0,
                toplam_fiyat: 0,
                tedarikci: '',
                satinalma_sorumlusu: '',
                planlanan_teslim_tarihi: '',
                teslimat_miktari: 0,
                teslimat_tarihi: '',
                kalan_miktar: 0,
                onay_durumu: 'Beklemede',
                aciklama: ''
            };
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            currentData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="radio" name="selectedRow" value="${index}" onchange="selectRow(${index})"></td>
                    <td>${row.sira_no}</td>
                    <td>${row.sof_form_no}</td>
                    <td><input type="text" value="${row.proje_kodu}" onchange="updateField(${index}, 'proje_kodu', this.value)"></td>
                    <td><input type="text" value="${row.talep_no}" onchange="updateField(${index}, 'talep_no', this.value)"></td>
                    <td><input type="text" value="${row.malzeme_tipi}" onchange="updateField(${index}, 'malzeme_tipi', this.value)"></td>
                    <td><input type="text" value="${row.talep_eden}" onchange="updateField(${index}, 'talep_eden', this.value)"></td>
                    <td><input type="date" value="${row.talep_tarihi}" onchange="updateField(${index}, 'talep_tarihi', this.value)"></td>
                    <td><input type="date" value="${row.istenen_teslim_tarihi}" onchange="updateField(${index}, 'istenen_teslim_tarihi', this.value)"></td>
                    <td><input type="text" value="${row.talep_edilen_malzeme}" onchange="updateField(${index}, 'talep_edilen_malzeme', this.value)"></td>
                    <td><input type="text" value="${row.detay_1}" onchange="updateField(${index}, 'detay_1', this.value)"></td>
                    <td><input type="text" value="${row.detay_2}" onchange="updateField(${index}, 'detay_2', this.value)"></td>
                    <td><input type="text" value="${row.birim}" onchange="updateField(${index}, 'birim', this.value)"></td>
                    <td><input type="number" value="${row.talep_miktari}" onchange="updateField(${index}, 'talep_miktari', parseFloat(this.value) || 0)"></td>
                    <td><input type="number" value="${row.siparis_miktari}" onchange="updateField(${index}, 'siparis_miktari', parseFloat(this.value) || 0)"></td>
                    <td><input type="number" step="0.01" value="${row.birim_fiyat}" onchange="updateField(${index}, 'birim_fiyat', parseFloat(this.value) || 0)"></td>
                    <td class="font-bold">${row.toplam_fiyat.toFixed(2)}</td>
                    <td><input type="text" value="${row.tedarikci}" onchange="updateField(${index}, 'tedarikci', this.value)"></td>
                    <td><input type="text" value="${row.satinalma_sorumlusu}" onchange="updateField(${index}, 'satinalma_sorumlusu', this.value)"></td>
                    <td><input type="date" value="${row.planlanan_teslim_tarihi}" onchange="updateField(${index}, 'planlanan_teslim_tarihi', this.value)"></td>
                    <td><input type="number" value="${row.teslimat_miktari}" onchange="updateField(${index}, 'teslimat_miktari', parseFloat(this.value) || 0)"></td>
                    <td><input type="date" value="${row.teslimat_tarihi}" onchange="updateField(${index}, 'teslimat_tarihi', this.value)"></td>
                    <td><input type="number" value="${row.kalan_miktar}" onchange="updateField(${index}, 'kalan_miktar', parseFloat(this.value) || 0)"></td>
                    <td>
                        <select onchange="updateField(${index}, 'onay_durumu', this.value)">
                            <option value="Beklemede" ${row.onay_durumu === 'Beklemede' ? 'selected' : ''}>Beklemede</option>
                            <option value="Onaylandı" ${row.onay_durumu === 'Onaylandı' ? 'selected' : ''}>Onaylandı</option>
                            <option value="Reddedildi" ${row.onay_durumu === 'Reddedildi' ? 'selected' : ''}>Reddedildi</option>
                            <option value="Tamamlandı" ${row.onay_durumu === 'Tamamlandı' ? 'selected' : ''}>Tamamlandı</option>
                        </select>
                    </td>
                    <td><input type="text" value="${row.aciklama}" onchange="updateField(${index}, 'aciklama', this.value)"></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function selectRow(index) {
            selectedRowIndex = index;
            document.querySelectorAll('#table-body tr').forEach((tr, i) => {
                tr.classList.toggle('selected-row', i === index);
            });
        }

        async function updateField(index, field, value) {
            if (isLoading) return;
            
            const row = currentData[index];
            row[field] = value;
            
            if (field === 'talep_miktari' || field === 'birim_fiyat') {
                row.toplam_fiyat = row.talep_miktari * row.birim_fiyat;
            }
            
            showLoading();
            const result = await window.dataSdk.update(row);
            hideLoading();
            
            if (!result.isOk) {
                alert('Güncelleme sırasında hata oluştu: ' + result.error.message);
            }
        }

        function calculateTotal() {
            const total = currentData.reduce((sum, row) => sum + row.toplam_fiyat, 0);
            document.getElementById('genel-toplam').textContent = total.toFixed(2);
        }

        async function yeniTalepBaslat() {
            if (isLoading) return;
            if (currentData.length >= 999) {
                alert('Maksimum 999 kayıt sınırına ulaşıldı. Lütfen önce bazı kayıtları silin.');
                return;
            }
            
            showLoading();
            const newRow = createNewRow();
            const result = await window.dataSdk.create(newRow);
            hideLoading();
            
            if (!result.isOk) {
                alert('Yeni talep oluşturulurken hata oluştu: ' + result.error.message);
            }
        }

        async function altSatirEkle() {
            if (isLoading) return;
            if (currentData.length >= 999) {
                alert('Maksimum 999 kayıt sınırına ulaşıldı. Lütfen önce bazı kayıtları silin.');
                return;
            }
            
            if (currentData.length === 0) {
                alert('Önce "Yeni Talep Başlat" butonuna basarak bir form oluşturun.');
                return;
            }
            
            const lastFormNo = currentData[currentData.length - 1].sof_form_no;
            
            showLoading();
            const newRow = createNewRow(lastFormNo);
            const result = await window.dataSdk.create(newRow);
            hideLoading();
            
            if (!result.isOk) {
                alert('Alt satır eklenirken hata oluştu: ' + result.error.message);
            }
        }

        async function satirSil() {
            if (isLoading) return;
            if (selectedRowIndex === -1) {
                alert('Lütfen silmek istediğiniz satırı seçin.');
                return;
            }
            
            const selectedRow = currentData[selectedRowIndex];
            
            showLoading();
            const result = await window.dataSdk.delete(selectedRow);
            hideLoading();
            
            if (result.isOk) {
                selectedRowIndex = -1;
            } else {
                alert('Satır silinirken hata oluştu: ' + result.error.message);
            }
        }

        async function render(config) {
            document.getElementById('system-title').textContent = config.system_title || defaultConfig.system_title;
            document.getElementById('company-name').textContent = config.company_name || defaultConfig.company_name;
        }

        function mapToCapabilities(config) {
            return {
                recolorables: [],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            };
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ["system_title", config.system_title || defaultConfig.system_title],
                ["company_name", config.company_name || defaultConfig.company_name]
            ]);
        }

        // Event listeners
        document.getElementById('yeni-talep-btn').addEventListener('click', yeniTalepBaslat);
        document.getElementById('alt-satir-btn').addEventListener('click', altSatirEkle);
        document.getElementById('satir-sil-btn').addEventListener('click', satirSil);
        document.getElementById('kaydet-btn').addEventListener('click', () => {
            alert('Veriler otomatik olarak Canva Sheet\'te saklanmaktadır.');
        });

        // Initialize
        window.addEventListener('load', async () => {
            if (window.dataSdk) {
                const initResult = await window.dataSdk.init(dataHandler);
                if (!initResult.isOk) {
                    console.error('Data SDK başlatılamadı:', initResult.error);
                }
            }
            
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    render,
                    mapToCapabilities,
                    mapToEditPanelValues
                });
            }
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98fe579e645fd35d',t:'MTc2MDY4ODg2NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
