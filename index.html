<!DOCTYPE html>
<html lang="tr" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SOMTECH — SOF Sistemi (LocalStorage) v1.6.0</title>
  <style>
    :root{
      --bg:#0F1115;--panel:#141822;--muted:#1A1F2B;--text:#E5E7EB;--sub:#A5B4FC;--acc:#22D3EE;--ok:#10B981;--warn:#F59E0B;--err:#EF4444;--chip:#2A3142;--glass:12px;
      --shadow:0 8px 30px rgba(0,0,0,.35)
    }
    [data-theme="light"]{--bg:#F8FAFC;--panel:#FFFFFF;--muted:#E5E7EB;--text:#0F172A;--sub:#4F46E5;--acc:#06B6D4;--ok:#10B981;--warn:#D97706;--err:#DC2626;--chip:#E9EEF8}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial}
    .shell{display:grid;grid-template-columns:260px 1fr;height:100dvh}
    aside{backdrop-filter:blur(var(--glass));background:linear-gradient(180deg,rgba(34,211,238,.06),rgba(34,211,238,0)) , var(--panel);border-right:1px solid var(--muted);padding:18px;position:sticky;top:0}
    .logo{display:grid;place-items:center;height:84px;margin-bottom:12px}
    .logo a{display:inline-flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
    .logo img{width:56px;height:56px;border-radius:14px;box-shadow:var(--shadow)}
    nav{display:flex;flex-direction:column;gap:8px}
    .nav-btn{padding:10px 12px;border-radius:12px;background:transparent;border:1px solid transparent;color:var(--text);text-align:left;cursor:pointer}
    .nav-btn.active,.nav-btn:hover{background:var(--muted);border-color:#2b3243}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--muted);background:var(--panel);position:sticky;top:0;z-index:3}
    .title{font-weight:700}
    .controls{display:flex;align-items:center;gap:10px}
    .chip{background:var(--chip);padding:6px 10px;border-radius:999px;font-size:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid #2b3243;background:var(--panel);color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--acc),#60A5FA);border:0;color:#06202a}
    .btn.ghost{background:transparent;border:1px dashed #2b3243}
    main{padding:16px;overflow:auto}
    .card{background:var(--panel);border:1px solid var(--muted);border-radius:16px;box-shadow:var(--shadow)}
    .grid{display:grid;gap:12px}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .kpi{padding:14px}
    .kpi .label{opacity:.75}
    .kpi .value{font-size:24px;font-weight:700;margin-top:6px}
    .searchbar{display:flex;gap:8px;padding:12px;border-bottom:1px solid var(--muted)}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:linear-gradient(180deg,rgba(34,211,238,.06),rgba(34,211,238,0)),var(--panel);border-bottom:1px solid var(--muted);padding:10px 8px;text-align:left}
    tbody td{border-bottom:1px solid var(--muted);padding:10px 8px;vertical-align:top}
    tr:hover{background:rgba(34,211,238,.05)}
    .status{padding:4px 8px;border-radius:999px;font-size:12px;display:inline-flex;align-items:center;gap:6px}
    .s-draft{background:#374151}
    .s-onay{background:#1f4937}
    .s-teklif{background:#3b2f18}
    .s-odeme{background:#2d3647}
    .s-termin{background:#2a2b18}
    .s-geldi{background:#1e2a3a}
    .stack{display:flex;flex-wrap:wrap;gap:6px}
    .hidden{display:none !important}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.6);z-index:50}
    .modal.active{display:grid}
    .modal .content{width:min(900px,92vw);max-height:84vh;overflow:auto;padding:16px}
    .row-actions{display:flex;gap:6px}
    .role-tag{font-weight:600}
    .hint{opacity:.7;font-size:12px}
    .loader{height:88px;display:grid;place-items:center}
    .ring{width:54px;height:54px;border-radius:999px;border:3px solid rgba(34,211,238,.35);border-top-color:var(--acc);animation:spin 1s linear infinite;box-shadow:0 0 20px rgba(34,211,238,.3)}
    #banner{position:fixed;top:-60px;left:0;right:0;z-index:1000;padding:14px;text-align:center;font-weight:600;transition:top .4s}
    #banner.show{top:0}
    #banner.ok{background:#14532d;color:#bbf7d0}
    #banner.err{background:#450a0a;color:#fecaca}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:960px){.shell{grid-template-columns:1fr}aside{position:fixed;inset:0 40% 0 0;transform:translateX(-100%);transition:.25s}aside.open{transform:none}header .title{font-size:14px}}
  </style>
</head>
<body>
<div id="banner"></div>
<audio id="sound-ok" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3"></audio>
<audio id="sound-err" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

<div class="shell">
  <aside id="sidebar">
    <div class="logo">
      <a href="https://somtech.ru" target="_blank" rel="noopener">
        <img src="https://i.hizliresim.com/ot1wnpw.png" alt="SOMTECH"/>
        <strong>SOMTECH — SOF</strong>
      </a>
    </div>
    <nav>
      <button class="nav-btn active" data-page="dashboard">🏠 Özet</button>
      <button class="nav-btn" data-page="list">📄 Kayıt Tablosu</button>
      <button class="nav-btn" data-page="form">📎 Talep Formu</button>
      <button class="nav-btn" data-page="reports">📊 Raporlar</button>
      <button class="nav-btn" data-page="logs" id="logsMenu" style="display:none">🧾 İşlem Geçmişi</button>
      <button class="nav-btn" data-page="settings">⚙️ Ayarlar</button>
    </nav>
  </aside>
  <section class="right">
    <header>
      <div class="title">SOF Sistemi</div>
      <div class="controls">
        <span class="chip" id="roleChip">Rol: <span class="role-tag" id="roleName">-</span></span>
        <button class="btn" id="langBtn" title="Dil">🌐 TR</button>
        <button class="btn" id="themeBtn" title="Tema">🌙</button>
        <button class="btn" id="loginBtn" title="Giriş">👤 Giriş</button>
      </div>
    </header>
    <main id="main">
      <div class="card loader" id="loader">
        <div>
          <div class="ring" style="margin:auto"></div>
          <div style="text-align:center;margin-top:8px">Sisteme bağlanıyor…</div>
          <div style="text-align:center;margin-top:6px;font-style:italic;opacity:.7">System engineered with precision by Karslio ⚙️</div>
        </div>
      </div>

      <section id="dashboard" class="page hidden">
        <div class="grid cols-3">
          <div class="card kpi"><div class="label">Sarf Toplamı</div><div class="value" id="kpiSarf">0</div></div>
          <div class="card kpi"><div class="label">Demirbaş Toplamı</div><div class="value" id="kpiDemirbas">0</div></div>
          <div class="card kpi"><div class="label">Genel Toplam</div><div class="value" id="kpiGenel">0</div></div>
        </div>
        <div class="card" style="margin-top:12px">
          <div class="searchbar">
            <input id="qDash" class="btn" style="flex:1" placeholder="Hızlı arama (SOF No, isim, tedarikçi)"/>
            <button class="btn" id="newFromDash">+ Yeni Talep</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>SOF No</th>
                  <th>Talep Eden</th>
                  <th>Tip</th>
                  <th>Malzeme</th>
                  <th>Miktar</th>
                  <th class="col-fiyat">Fiyat/Toplam</th>
                  <th>Durum</th>
                  <th>Termin</th>
                  <th>Tedarikçi</th>
                  <th>İşlemler</th>
                </tr>
              </thead>
              <tbody id="sofTableBody"></tbody>
            </table>
          </div>
          <div class="hint" style="padding:10px">İpucu: Satıra çift tıkla → <strong>Talep Süreç Takip</strong> penceresi açılır.</div>
        </div>
      </section>

      <section id="list" class="page hidden">
        <div class="card">
          <div class="searchbar">
            <input id="q" class="btn" style="flex:1" placeholder="Ara…"/>
            <select id="fTip" class="btn"><option value="">Tip (Hepsi)</option><option>Sarf</option><option>Demirbaş</option><option>Genel</option></select>
            <select id="fDurum" class="btn"><option value="">Durum (Hepsi)</option><option>Taslak</option><option>Müdür Onayı</option><option>Fiyat Teklifi</option><option>Ödeme</option><option>Termin</option><option>Geldi</option></select>
            <button class="btn" id="exportJson">JSON Dışa Aktar</button>
            <button class="btn ghost" id="importJson">JSON İçe Aktar</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>SOF No</th><th>Talep Eden</th><th>Tip</th><th>Malzeme</th><th>Miktar</th><th class="col-fiyat">Fiyat/Toplam</th><th>Durum</th><th>Termin</th><th>Tedarikçi</th><th>İşlemler</th>
                </tr>
              </thead>
              <tbody id="sofTableBody2"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="form" class="page hidden">
        <div class="card" style="padding:16px">
          <h3>Yeni Talep</h3>
          <div class="grid" style="grid-template-columns:repeat(2,1fr)">
            <label>Talep Eden Birim<input id="fBirim" class="btn" placeholder="Birim adı"></label>
            <label>Malzeme Tipi<select id="fTip2" class="btn"><option>Sarf</option><option>Demirbaş</option><option>Genel</option></select></label>
            <label>Malzeme Adı<input id="fAd" class="btn" placeholder="Örn. Ethernet kablo"></label>
            <label>Miktar<input id="fMiktar" type="number" class="btn" value="1"></label>
            <label>Birim<input id="fBirim2" class="btn" placeholder="adet, m, kg"></label>
            <label>Tedarikçi<input id="fTedarikci" class="btn" placeholder="(isteğe bağlı)"></label>
            <label>Termin Tarihi<input id="fTermin" type="date" class="btn"></label>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn primary" id="saveTalep">Kaydet</button>
            <button class="btn" id="resetForm">Sıfırla</button>
          </div>
        </div>
        <div class="card" style="padding:16px;margin-top:12px">
          <h3>Toplu Veri Göm (Opsiyonel)</h3>
          <div class="hint">CSV/TSV yapıştır → Alan sırası: SOF No (isteğe bağlı), Birim, Tip, Malzeme, Miktar, Birim, Fiyat (ops), Tedarikçi (ops), Termin (YYYY-MM-DD)</div>
          <textarea id="bulkBox" class="btn" style="width:100%;height:140px"></textarea>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="btn" id="parseBulk">Yükle</button>
          </div>
        </div>
      </section>

      <section id="reports" class="page hidden">
        <div class="card" style="padding:16px">
          <h3>Raporlar</h3>
          <div class="grid cols-3">
            <div class="kpi"><div class="label">Bekleyen Müdür Onayı</div><div class="value" id="rOnay">0</div></div>
            <div class="kpi"><div class="label">Ödeme Bekleyen</div><div class="value" id="rOdeme">0</div></div>
            <div class="kpi"><div class="label">Termin Aşımı</div><div class="value" id="rOverdue">0</div></div>
          </div>
          <div style="margin-top:12px" class="hint">İleri raporlar için dışa aktarım planlandı.</div>
        </div>
      </section>

      <section id="logs" class="page hidden">
        <div class="card" style="padding:16px">
          <h3>🧾 İşlem Geçmişi</h3>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Tarih</th><th>Kullanıcı</th><th>İşlem</th></tr></thead>
              <tbody id="logTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="settings" class="page hidden">
        <div class="card" style="padding:16px">
          <h3>Ayarlar</h3>
          <div class="grid" style="grid-template-columns:repeat(2,1fr)">
            <div>
              <div class="label">Rol Seç</div>
              <select id="roleSelect" class="btn">
                <option value="Birim">Birim Kullanıcısı (fiyat gizli)</option>
                <option value="Müdür">Müdür</option>
                <option value="Muhasebe">Muhasebe</option>
                <option value="SatınAlma">Satın Alma</option>
                <option value="Admin">Admin (hepsi)</option>
              </select>
            </div>
            <div>
              <div class="label">Dil</div>
              <select id="langSelect" class="btn"><option value="tr">Türkçe</option><option value="en">English</option><option value="ru">Русский</option></select>
            </div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn" id="clearLS">LocalStorage Temizle</button>
            <button class="btn ghost" id="dumpLS">Veriyi Göster (JSON)</button>
          </div>
          <div class="hint" style="margin-top:10px">Giriş ekranı ileride eklenecek. Şimdilik rolü buradan seç.</div>
        </div>
      </section>
    </main>
  </section>
</div>

<!-- Timeline Modal -->
<div class="modal" id="timelineModal">
  <div class="card content">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Talep Süreç Takip — <span id="tlSof"></span></h3>
      <button class="btn" onclick="closeModal('timelineModal')">✖</button>
    </div>
    <div id="timelineWrap" style="margin-top:8px"></div>
  </div>
</div>

<!-- JSON Import Modal -->
<div class="modal" id="jsonModal">
  <div class="card content">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>JSON İçe Aktar</h3>
      <button class="btn" onclick="closeModal('jsonModal')">✖</button>
    </div>
    <textarea id="jsonBox" class="btn" style="width:100%;height:260px"></textarea>
    <div style="margin-top:8px"><button class="btn primary" id="confirmImport">İçe Aktar</button></div>
  </div>
</div>

<script>
const KEY = 'sof_records_v160';
const KEY_SETTINGS = 'sof_settings';
const LOG_KEY = 'sof_action_log';

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const ROLES = {
  Birim: {showPrice:false, canApprove:false, canPayment:false, canArrival:false},
  Müdür: {showPrice:true, canApprove:true, canPayment:false, canArrival:false},
  Muhasebe: {showPrice:true, canApprove:false, canPayment:true, canArrival:false},
  SatınAlma: {showPrice:true, canApprove:false, canPayment:false, canArrival:true},
  Admin: {showPrice:true, canApprove:true, canPayment:true, canArrival:true}
};

const DURUMLAR = ['Taslak','Müdür Onayı','Fiyat Teklifi','Ödeme','Termin','Geldi'];

function uid(){return Math.random().toString(36).slice(2,8)}
function now(){return new Date().toISOString()}
function load(){return JSON.parse(localStorage.getItem(KEY)||'[]')}
function save(arr){localStorage.setItem(KEY, JSON.stringify(arr))}
function loadSettings(){return JSON.parse(localStorage.getItem(KEY_SETTINGS)||'{"role":"Birim","lang":"tr","theme":"dark"}')}
function saveSettings(s){localStorage.setItem(KEY_SETTINGS, JSON.stringify(s))}

let settings = loadSettings();
applyTheme(settings.theme||'dark');

window.addEventListener('DOMContentLoaded', ()=>{
  setTimeout(()=>{
    $('#loader').classList.add('hidden');
    $('#dashboard').classList.remove('hidden');
    renderAll();
  }, 500);

  // Nav
  $$('#sidebar .nav-btn').forEach(b=>b.onclick=()=>switchPage(b.dataset.page,b));
  $('#newFromDash').onclick=()=>switchPage('form');

  // Search/Filters
  ['q','qDash','fTip','fDurum'].forEach(id=>{ const el=$('#'+id); if(el){ el.addEventListener('input', renderAll); el.addEventListener('change', renderAll); } });

  // Form
  $('#saveTalep').onclick=saveTalep;
  $('#resetForm').onclick=()=>$$('#form input').forEach(i=>i.value='');
  $('#parseBulk').onclick=parseBulk;

  // Export/Import
  $('#exportJson').onclick=()=>{
    const data = load();
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'sof_localstorage_export.json';
    a.click();
  };
  $('#importJson').onclick=()=>openModal('jsonModal');
  $('#confirmImport').onclick=()=>{
    try{
      const obj = JSON.parse($('#jsonBox').value||'[]');
      if(!Array.isArray(obj)) throw new Error('Array bekleniyor');
      save(obj); closeModal('jsonModal'); renderAll(); showBanner('JSON içe aktarıldı ✅','ok');
    }catch(e){ showBanner('Hata: '+e.message,'err'); }
  };

  // Settings / UI
  $('#clearLS').onclick=()=>{ if(confirm('Tüm LocalStorage verisi silinsin mi?')){ localStorage.removeItem(KEY); renderAll(); showBanner('Veri temizlendi','ok'); } };
  $('#dumpLS').onclick=()=>{ alert(localStorage.getItem(KEY)||'[]'); };
  $('#roleSelect').value = settings.role||'Birim';
  $('#langSelect').value = settings.lang||'tr';
  $('#roleSelect').onchange = e=>{ settings.role=e.target.value; saveSettings(settings); applyRole(); renderAll(); };
  $('#langSelect').onchange = e=>{ settings.lang=e.target.value; saveSettings(settings); $('#langBtn').textContent = settings.lang.toUpperCase(); };
  $('#loginBtn').onclick=()=>switchPage('settings');
  $('#themeBtn').onclick=toggleTheme;
  $('#langBtn').onclick=()=>switchLang();

  applyRole();
  $('#langBtn').textContent = (settings.lang||'tr').toUpperCase();
});

// UI helpers
function switchPage(page, btn){
  $$('.page').forEach(p=>p.classList.add('hidden'));
  $('#'+page).classList.remove('hidden');
  if(btn){ $$('#sidebar .nav-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
}
function switchLang(){
  const seq = ['tr','en','ru'];
  const i = seq.indexOf(settings.lang||'tr');
  settings.lang = seq[(i+1)%seq.length];
  saveSettings(settings);
  $('#langBtn').textContent = settings.lang.toUpperCase();
}
function toggleTheme(){
  const cur = document.documentElement.getAttribute('data-theme')||'dark';
  applyTheme(cur==='dark'?'light':'dark');
  settings.theme = document.documentElement.getAttribute('data-theme');
  saveSettings(settings);
}
function applyTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  $('#themeBtn').textContent = theme==='dark' ? '🌙' : '☀️';
}
function applyRole(){
  $('#roleName').textContent = settings.role||'Birim';
  const cfg = ROLES[settings.role||'Birim'];
  // Fiyat kolonlarını göster/gizle
  $$('.col-fiyat').forEach(th=> th.style.display = cfg.showPrice? 'table-cell' : 'none');
  // Log menüsünü sadece SatınAlma/Admin görsün
  $('#logsMenu').style.display = (settings.role==='SatınAlma' || settings.role==='Admin') ? 'block' : 'none';
}

// Banner + Ses
function playSound(type){ const id = type==='err'?'sound-err':'sound-ok'; const el = $('#'+id); if(el){ el.currentTime=0; el.play().catch(()=>{}); } }
function showBanner(msg,type='ok'){
  const b = $('#banner'); b.textContent = msg; b.className='show '+type; playSound(type); setTimeout(()=>b.classList.remove('show'),2500);
}

// Render
function renderAll(){
  applyRole();
  const data = load();
  // Filters
  const q = ($('#q')?.value||'').toLowerCase();
  const q2 = ($('#qDash')?.value||'').toLowerCase();
  const tip = $('#fTip')?.value||''; const durum = $('#fDurum')?.value||'';
  const filtered = data.filter(r=>{
    const hay = [r.sofNo,r.birim,r.tip,r.ad,r.tedarikci].join(' ').toLowerCase();
    const okQ = q? hay.includes(q) : true;
    const okQ2 = q2? hay.includes(q2) : true;
    const okTip = tip? r.tip===tip : true;
    const okDur = durum? r.durum===durum : true;
    return okQ && okQ2 && okTip && okDur;
  });

  // KPIs
  $('#kpiSarf').textContent = data.filter(r=>r.tip==='Sarf').length;
  $('#kpiDemirbas').textContent = data.filter(r=>r.tip==='Demirbaş').length;
  $('#kpiGenel').textContent = data.length;

  // Reports
  $('#rOnay').textContent = data.filter(r=>r.durum==='Müdür Onayı').length;
  $('#rOdeme').textContent = data.filter(r=>r.durum==='Ödeme').length;
  const today = new Date().toISOString().slice(0,10);
  $('#rOverdue').textContent = data.filter(r=>r.durum!=='Geldi' && r.termin && r.termin < today).length;

  // Tables
  const cfg = ROLES[settings.role||'Birim'];
  const renderRow = (r)=>{
    const priceCell = cfg.showPrice ? ('<div>'+fmtMoney(r.fiyat||0)+' / <strong>'+fmtMoney(r.toplam||0)+'</strong></div>') : '';
    const st = statusBadge(r.durum);
    return '<tr data-id="'+r.id+'">'
      + '<td>'+r.sofNo+'</td>'
      + '<td>'+r.birim+'</td>'
      + '<td>'+r.tip+'</td>'
      + '<td>'+r.ad+'</td>'
      + '<td>'+r.miktar+' '+(r.birim2||'')+'</td>'
      + (cfg.showPrice?('<td>'+priceCell+'</td>'):'')
      + '<td>'+st+'</td>'
      + '<td>'+(r.termin||'-')+'</td>'
      + '<td>'+(r.tedarikci||'-')+'</td>'
      + '<td class="row-actions">'+rowActions(r)+'</td>'
      + '</tr>';
  };

  $('#sofTableBody').innerHTML = filtered.map(renderRow).join('');
  $('#sofTableBody2').innerHTML = filtered.map(renderRow).join('');

  // dblclick → Timeline
  $$('#sofTableBody tr, #sofTableBody2 tr').forEach(tr=>{
    tr.ondblclick = ()=> openTimeline(tr.getAttribute('data-id'));
  });

  // attach action buttons
  $$('.btn-act').forEach(b=> b.onclick = ()=>handleAction(b.dataset.act, b.dataset.id));
}

function statusBadge(d){
  const m={'Taslak':'s-draft','Müdür Onayı':'s-onay','Fiyat Teklifi':'s-teklif','Ödeme':'s-odeme','Termin':'s-termin','Geldi':'s-geldi'};
  return '<span class="status '+(m[d]||'s-draft')+'">'+d+'</span>';
}
function rowActions(r){
  const cfg = ROLES[settings.role||'Birim'];
  const arr = [];
  if(cfg.canApprove && r.durum==='Taslak') arr.push(btn('Onayla','approve',r.id));
  if(cfg.canApprove && r.durum==='Müdür Onayı') arr.push(btn('Teklife Gönder','offer',r.id));
  if(cfg.canPayment && r.durum==='Fiyat Teklifi') arr.push(btn('Ödemeye Gönder','payment',r.id));
  if(cfg.canPayment && r.durum==='Ödeme') arr.push(btn('Ödeme Yapıldı','paid',r.id));
  if(cfg.canArrival && r.durum==='Termin') arr.push(btn('Geldi Onayı','arrived',r.id));
  if(settings.role==='Admin') arr.push(btn('Sil','delete',r.id));
  return arr.join('');
}
function btn(label, act, id){return '<button class="btn btn-act" data-act="'+act+'" data-id="'+id+'">'+label+'</button>'}

function roleCheck(role, act){
  const cfg = ROLES[role] || ROLES.Birim;
  if(act==='approve' && !cfg.canApprove) return false;
  if((act==='payment' || act==='paid') && !cfg.canPayment) return false;
  if(act==='arrived' && !cfg.canArrival) return false;
  if(act==='delete' && role!=='Admin') return false;
  return true;
}

function handleAction(act,id){
  const data = load();
  const ix = data.findIndex(x=>x.id===id);
  if(ix<0) return;
  const r = data[ix];
  if(!roleCheck(settings.role, act)){ showBanner('Bu işlemi yapma yetkiniz yok ❌','err'); return; }
  const pushTL = (ev)=>{ (r.timeline ||= []).push({ts:now(), ev}); };

  if(act==='approve'){ r.durum='Müdür Onayı'; pushTL('Müdür onayı verildi'); showBanner('Onay verildi ✅','ok'); }
  if(act==='offer'){ r.durum='Fiyat Teklifi'; pushTL('Fiyat teklifi talep edildi'); showBanner('Fiyat teklifi aşamasında 🔄','ok'); }
  if(act==='payment'){ r.durum='Ödeme'; pushTL('Ödeme sürecine aktarıldı'); showBanner('Ödeme aşamasına aktarıldı 💰','ok'); }
  if(act==='paid'){ r.durum='Termin'; pushTL('Ödeme yapıldı, termin bekleniyor'); showBanner('Ödeme yapıldı ⏳','ok'); }
  if(act==='arrived'){ r.durum='Geldi'; r.gelisOnayi=true; pushTL('Satın alma birimi ürünün geldiğini onayladı'); showBanner('Ürün geldi ✅','ok'); }
  if(act==='delete'){ data.splice(ix,1); showBanner('Kayıt silindi 🗑️','ok'); }

  data[ix]=r; save(data); renderAll();
  pushLog(settings.role, act, r.sofNo);
}

// Timeline
function openTimeline(id){
  const r = load().find(x=>x.id===id);
  if(!r) return;
  $('#tlSof').textContent = r.sofNo;
  const arr = (r.timeline||[]);
  let html = '<div class="stack">';
  for (const x of arr){ html += '<span class="chip">'+x.ts.slice(0,16).replace('T',' ')+' — '+x.ev+'</span>'; }
  html += '</div>';
  $('#timelineWrap').innerHTML = html || '<div class="hint">Henüz kayıt yok.</div>';
  openModal('timelineModal');
}
function openModal(id){ $('#'+id).classList.add('active'); }
function closeModal(id){ $('#'+id).classList.remove('active'); }

// Money
function fmtMoney(n){ try{ return new Intl.NumberFormat('tr-TR', {style:'currency', currency:'TRY', maximumFractionDigits:0}).format(n||0) }catch(e){ return (n||0)+' TL' } }
function nextSofNo(){
  const y = new Date().getFullYear();
  let seq = (parseInt(localStorage.getItem('sof_seq')||'0',10) + 1);
  localStorage.setItem('sof_seq', String(seq));
  return 'SOF-'+y+'-'+String(seq).padStart(4,'0');
}

// Save & Bulk
function saveTalep(){
  const rec = {
    id: uid(),
    sofNo: nextSofNo(),
    birim: $('#fBirim').value.trim()||'—',
    tip: $('#fTip2').value,
    ad: $('#fAd').value.trim(),
    miktar: Number($('#fMiktar').value||1),
    birim2: $('#fBirim2').value.trim(),
    fiyat: 0, toplam: 0,
    tedarikci: $('#fTedarikci').value.trim(),
    termin: $('#fTermin').value||'',
    durum: 'Taslak',
    timeline: [{ts:now(), ev:'Talep oluşturuldu'}],
    owner: $('#fBirim').value.trim()||'—',
    bildirimler: []
  };
  const data = load(); data.unshift(rec); save(data);
  showBanner('Talep kaydedildi: '+rec.sofNo,'ok');
  switchPage('dashboard'); renderAll();
}
function parseBulk(){
  const raw = $('#bulkBox').value.trim(); if(!raw) return showBanner('Veri yok','err');
  const lines = raw.split(/\n+/).filter(Boolean);
  const data = load();
  lines.forEach(line=>{
    const cols = line.split(/[\t,;]+/);
    const rec = {
      id: uid(), sofNo: cols[0] && cols[0].startsWith('SOF-')? cols[0] : nextSofNo(),
      birim: cols[0] && cols[0].startsWith('SOF-')? (cols[1]||'—') : (cols[0]||'—'),
      tip: cols[0] && cols[0].startsWith('SOF-')? (cols[2]||'Genel') : (cols[1]||'Genel'),
      ad: cols[0] && cols[0].startsWith('SOF-')? (cols[3]||'') : (cols[2]||''),
      miktar: Number(cols[0] && cols[0].startsWith('SOF-')? (cols[4]||1) : (cols[3]||1)),
      birim2: cols[0] && cols[0].startsWith('SOF-')? (cols[5]||'') : (cols[4]||''),
      fiyat: Number(cols[0] && cols[0].startsWith('SOF-')? (cols[6]||0) : (cols[5]||0)),
      toplam: 0,
      tedarikci: cols[0] && cols[0].startsWith('SOF-')? (cols[7]||'') : (cols[6]||''),
      termin: (cols[0] && cols[0].startsWith('SOF-')? (cols[8]||'') : (cols[7]||'')).slice(0,10),
      durum:'Taslak', timeline:[{ts:now(), ev:'Toplu yükleme'}], owner:'—', bildirimler:[]
    };
    rec.toplam = (rec.fiyat||0) * (rec.miktar||1);
    data.push(rec);
  });
  save(data); renderAll(); showBanner(lines.length+' satır eklendi.','ok');
}

// Logs
function pushLog(user,act,sofNo){
  const arr = JSON.parse(localStorage.getItem(LOG_KEY)||'[]');
  arr.unshift({ts:now(), user, act, sofNo});
  localStorage.setItem(LOG_KEY, JSON.stringify(arr));
  renderLog();
}
function renderLog(){
  const logs = JSON.parse(localStorage.getItem(LOG_KEY)||'[]');
  const tb = $('#logTable');
  tb.innerHTML = logs.map(x=>{
    return '<tr><td>'+x.ts.replace('T',' ').slice(0,16)+'</td><td>'+x.user+'</td><td>'+(x.act+(x.sofNo?(' • '+x.sofNo):''))+'</td></tr>';
  }).join('');
}

// Banner audio
function playAudio(url){ const a=new Audio(url); a.play().catch(()=>{}); }

// Modal
function openModal(id){ $('#'+id).classList.add('active'); }
function closeModal(id){ $('#'+id).classList.remove('active'); }
</script>
</body>
</html>
