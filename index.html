<!doctype html>
<html lang="tr">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOF Ana Liste</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Calibri', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .table-container {
            overflow-x: auto;
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 2000px;
            table-layout: auto;
        }
        
        th, td {
            border: 1px solid #d1d5db;
            padding: 8px;
            text-align: left;
            font-size: 12px;
            white-space: nowrap;
        }
        
        @media (max-width: 768px) {
            th, td {
                padding: 6px;
                font-size: 10px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 12px;
                margin: 2px;
            }
            
            .container {
                padding: 4px;
            }
        }
        
        th {
            background-color: #2459a0;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        tr:nth-child(odd) {
            background-color: white;
        }
        
        /* Onay durumu renkleri - sadece arka plan */
        .status-beklemede {
            background-color: #fef3c7 !important; /* bg-yellow-100 */
            transition: all 300ms ease;
        }
        
        .status-onaylandi {
            background-color: #dcfce7 !important; /* bg-green-100 */
            transition: all 300ms ease;
        }
        
        .status-red-edildi {
            background-color: #fee2e2 !important; /* bg-red-100 */
            transition: all 300ms ease;
        }
        
        .status-odeme-bekliyor {
            background-color: #dbeafe !important; /* bg-blue-100 */
            transition: all 300ms ease;
        }
        
        /* Diƒüer durumlar i√ßin varsayƒ±lan */
        .status-onay-bekliyor {
            background-color: #fef3c7 !important; /* bg-yellow-100 */
            transition: all 300ms ease;
        }
        
        .status-tamamlandi {
            background-color: #dcfce7 !important; /* bg-green-100 */
            transition: all 300ms ease;
        }
        
        input[type="text"], input[type="number"], input[type="date"], select {
            width: 100%;
            padding: 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .total-row {
            background-color: #f3f4f6 !important;
            font-weight: bold;
        }
        
        .grand-total-row {
            background-color: #2459a0 !important;
            color: white !important;
            font-weight: bold;
        }
        
        .selected-row {
            background-color: #dbeafe !important;
        }
        
        .btn {
            padding: 8px 16px;
            margin: 4px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: #2459a0;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1e40af;
        }
        
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        
        .btn-success {
            background-color: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #047857;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }
        
        .notification.success {
            background-color: #10b981;
        }
        
        .notification.error {
            background-color: #dc2626;
        }
        
        .notification.info {
            background-color: #3b82f6;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="bg-gray-100 min-h-full">
  <div class="container mx-auto p-6 bg-white shadow-lg rounded-lg my-4">
   <header class="mb-6 bg-white">
    <div class="flex flex-col items-center justify-center"><!-- Logo B√∂l√ºm√º -->
     <div class="flex flex-col items-center mb-2"><a href="https://www.somtech.ru/" target="_blank" rel="noopener noreferrer" class="block mb-2"> <img src="https://raw.githubusercontent.com/okarsli/deneme/main/%C5%9Eeffaf%20Logo.png" alt="SOMTECH RU Logo" class="w-32 h-auto object-contain hover:opacity-80 transition-opacity cursor-pointer" style="width: 130px;" onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='block';"> </a>
      <div id="logo-fallback" class="hidden mb-2"><a href="https://www.somtech.ru/" target="_blank" rel="noopener noreferrer" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 transition-colors"> SOMTECH RU </a>
      </div>
      <p class="text-center" style="font-size: 14px; font-family: 'Calibri', sans-serif; color: #6b7280;">Satƒ±n Alma Y√∂netim Sistemi</p>
     </div><!-- Ayra√ß √áizgi -->
     <div class="w-full h-px bg-gray-300 mt-4 mb-2" style="background-color: #d1d5db;"></div><!-- Bildirim Alanƒ± -->
     <div id="notification-area" class="w-full mt-2 mb-2"></div>
    </div>
   </header>
   <div class="mb-6 flex flex-wrap gap-2 justify-center"><button id="yeni-talep-btn" class="btn btn-primary"> üìù Yeni Talep Ba≈ülat </button> <button id="alt-satir-btn" class="btn btn-secondary"> ‚ûï Alt Satƒ±r Ekle </button> <button id="satir-sil-btn" class="btn btn-danger"> üóëÔ∏è Satƒ±r Sil </button> <button id="pdf-btn" class="btn btn-success"> üìÑ PDF ƒ∞ndir </button> <button id="kaydet-btn" class="btn btn-success"> üìä CSV ƒ∞ndir </button> <button id="export-csv-btn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2 font-semibold shadow-sm w-full md:w-auto transition-colors"> üì¶ Verileri Dƒ±≈üa Aktar </button> <button id="clear-local-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg px-4 py-2 w-full md:w-auto transition-colors"> üßπ Yerel Veriyi Temizle </button>
   </div><!-- Toplam Bilgi Paneli -->
   <div class="mb-8">
    <div class="text-center mb-6">
     <h2 class="text-xl font-bold text-gray-800 mb-2">üìä Toplam Bilgi Paneli</h2>
     <div class="w-32 h-px bg-gray-300 mx-auto"></div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-6xl mx-auto"><!-- SARF TOPLAMI Kartƒ± -->
     <div class="bg-gray-100 hover:bg-gray-200 rounded-xl shadow-md p-6 text-center transition-all duration-300 max-h-[110px] flex flex-col justify-between">
      <div class="flex items-center justify-start mb-2"><span class="text-xl mr-3">üíº</span>
       <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide">SARF TOPLAMI</h3>
      </div>
      <div class="text-2xl font-bold text-gray-800 mb-1" id="sarf-toplam-panel">
       ‚ÇΩ 0,00
      </div>
      <div class="text-xs text-gray-500 font-medium">
       ‚ÇΩ RUB
      </div>
     </div><!-- DEMƒ∞RBA≈û TOPLAMI Kartƒ± -->
     <div class="bg-red-50 hover:bg-red-100 rounded-xl shadow-md p-6 text-center transition-all duration-300 max-h-[110px] flex flex-col justify-between">
      <div class="flex items-center justify-start mb-2"><span class="text-xl mr-3">üß±</span>
       <h3 class="text-sm font-bold text-red-700 uppercase tracking-wide">DEMƒ∞RBA≈û TOPLAMI</h3>
      </div>
      <div class="text-2xl font-bold text-red-800 mb-1" id="demirbas-toplam-panel">
       ‚ÇΩ 0,00
      </div>
      <div class="text-xs text-red-500 font-medium">
       ‚ÇΩ RUB
      </div>
     </div><!-- GENEL TOPLAM Kartƒ± -->
     <div class="bg-cyan-50 hover:bg-cyan-100 rounded-xl shadow-md p-6 text-center transition-all duration-300 max-h-[110px] flex flex-col justify-between">
      <div class="flex items-center justify-start mb-2"><span class="text-xl mr-3">üí∞</span>
       <h3 class="text-sm font-bold text-cyan-700 uppercase tracking-wide">GENEL TOPLAM</h3>
      </div>
      <div class="text-2xl font-bold text-cyan-800 mb-1" id="genel-toplam-panel">
       ‚ÇΩ 0,00
      </div>
      <div class="text-xs text-cyan-500 font-medium">
       ‚ÇΩ RUB
      </div>
     </div>
    </div>
   </div>
   <div id="loading-indicator" class="hidden text-center py-4">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
    <p class="mt-2 text-gray-600">ƒ∞≈ülem yapƒ±lƒ±yor...</p>
   </div>
   <div class="table-container">
    <table id="sof-table">
     <thead>
      <tr>
       <th>Se√ß</th>
       <th>SIRA NO</th>
       <th>SOF FORM NO</th>
       <th>MALZEME Tƒ∞Pƒ∞</th>
       <th>TALEP EDEN</th>
       <th>TALEP TARƒ∞Hƒ∞</th>
       <th>ƒ∞STENEN TESLƒ∞M TARƒ∞Hƒ∞</th>
       <th>TALEP EDƒ∞LEN MALZEME</th>
       <th>DETAY 1 (MARKA, MODEL VB)</th>
       <th>DETAY 2 (PROJE, STANDART VB KODLAR)</th>
       <th>Bƒ∞Rƒ∞M</th>
       <th>TALEP Mƒ∞KTARI</th>
       <th>Sƒ∞PARƒ∞≈û Mƒ∞KTARI</th>
       <th>Bƒ∞Rƒ∞M Fƒ∞YAT (‚ÇΩ RUB)</th>
       <th>TOPLAM Fƒ∞YAT (‚ÇΩ RUB)</th>
       <th>TEDARƒ∞K√áƒ∞</th>
       <th>SATINALMA SORUMLUSU</th>
       <th>PLANLANAN TESLƒ∞M TARƒ∞Hƒ∞</th>
       <th>TESLƒ∞MAT Mƒ∞KTARI</th>
       <th>TESLƒ∞MAT TARƒ∞Hƒ∞</th>
       <th>KALAN Mƒ∞KTAR</th>
       <th>ONAY DURUMU</th>
       <th>A√áIKLAMA</th>
      </tr>
     </thead>
     <tbody id="table-body">
     </tbody>
    </table>
   </div>
  </div>
  <script>
        let currentData = [];
        let selectedRowIndex = -1;
        let nextSiraNo = 1;
        let nextFormNo = 1;
        let currentFormNo = '';
        let isLoading = false;
        let jsPDFLoaded = false;
        let calculateTotalTimeout = null;

        // Debounce fonksiyonu - toplam hesaplamalarƒ±nƒ± optimize eder
        function debouncedCalculateTotal() {
            if (calculateTotalTimeout) {
                clearTimeout(calculateTotalTimeout);
            }
            calculateTotalTimeout = setTimeout(() => {
                calculateTotal();
            }, 300);
        }

        const dataHandler = {
            onDataChanged(data) {
                currentData = data.sort((a, b) => a.sira_no - b.sira_no);
                updateNextNumbers();
                renderTable();
                calculateTotal();
                // LocalStorage'a otomatik kaydet
                saveToLocalStorage();
            }
        };

        // LocalStorage kaydetme fonksiyonu
        function saveToLocalStorage() {
            try {
                localStorage.setItem("sofTableData", JSON.stringify(currentData));
                console.log('Veriler localStorage\'a kaydedildi');
            } catch (error) {
                console.error('LocalStorage kaydetme hatasƒ±:', error);
            }
        }

        // LocalStorage'dan veri y√ºkleme fonksiyonu
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem("sofTableData");
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        return parsedData;
                    }
                }
                return null;
            } catch (error) {
                console.error('LocalStorage okuma hatasƒ±:', error);
                return null;
            }
        }

        // Yerel veriyi temizleme fonksiyonu
        function clearLocalStorage() {
            try {
                localStorage.removeItem("sofTableData");
                localStorage.removeItem("sofDataLoaded"); // GitHub CSV y√ºkleme i≈üaretini de temizle
                showNotification('üßπ Yerel veriler temizlendi. Sayfa yenileniyor...', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } catch (error) {
                console.error('LocalStorage temizleme hatasƒ±:', error);
                showNotification('Yerel veriler temizlenirken hata olu≈ütu.', 'error');
            }
        }

        function updateNextNumbers() {
            if (currentData.length > 0) {
                nextSiraNo = Math.max(...currentData.map(item => item.sira_no)) + 1;
                const formNumbers = currentData.map(item => {
                    // Yeni format: RF100.SOFS-0001 veya RF100.SOFD-0001
                    const match = item.sof_form_no.match(/RF100\.SOF[SD]-(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                });
                nextFormNo = Math.max(...formNumbers, 0) + 1;
            }
        }

        function showLoading() {
            isLoading = true;
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.querySelectorAll('.btn').forEach(btn => btn.disabled = true);
        }

        function hideLoading() {
            isLoading = false;
            document.getElementById('loading-indicator').classList.add('hidden');
            document.querySelectorAll('.btn').forEach(btn => btn.disabled = false);
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // Form numarasƒ± otomatik olu≈üturma
        function generateFormNumber(index, malzemeTipi) {
            const tipKodu = malzemeTipi === "SARF" ? "S" : "D";
            const formNo = String(index).padStart(4, "0");
            return `RF100.SOF${tipKodu}-${formNo}`;
        }

        function createNewRow(formNo = null, malzemeTipi = 'SARF') {
            const today = formatDate(new Date());
            
            if (!formNo) {
                const newIndex = currentData.length + 1;
                currentFormNo = generateFormNumber(newIndex, malzemeTipi);
            } else {
                currentFormNo = formNo;
            }

            return {
                sira_no: nextSiraNo++,
                sof_form_no: currentFormNo,
                malzeme_tipi: malzemeTipi,
                talep_eden: '',
                talep_tarihi: today,
                istenen_teslim_tarihi: '',
                talep_edilen_malzeme: '',
                detay_1: '',
                detay_2: '',
                birim: 'ADET',
                talep_miktari: 0,
                siparis_miktari: 0,
                birim_fiyat: 0,
                toplam_fiyat: 0,
                tedarikci: '',
                satinalma_sorumlusu: '',
                planlanan_teslim_tarihi: '',
                teslimat_miktari: 0,
                teslimat_tarihi: '',
                kalan_miktar: 0,
                onay_durumu: 'BEKLEMEDE',
                aciklama: ''
            };
        }

        // Optimized: Tek satƒ±r olu≈üturma fonksiyonu
        function createTableRow(row, index) {
            const tr = document.createElement('tr');
            tr.className = getStatusClass(row.onay_durumu);
            tr.dataset.rowId = row.__backendId || index;
            tr.innerHTML = `
                <td><input type="radio" name="selectedRow" value="${index}" onchange="selectRow(${index})"></td>
                <td>${row.sira_no}</td>
                <td>${row.sof_form_no}</td>
                <td>
                    <select onchange="updateField(${index}, 'malzeme_tipi', this.value)">
                        <option value="SARF" ${row.malzeme_tipi === 'SARF' ? 'selected' : ''}>SARF</option>
                        <option value="DEMƒ∞RBA≈û" ${row.malzeme_tipi === 'DEMƒ∞RBA≈û' ? 'selected' : ''}>DEMƒ∞RBA≈û</option>
                    </select>
                </td>
                <td><input type="text" value="${row.talep_eden}" onchange="updateField(${index}, 'talep_eden', this.value)"></td>
                <td><input type="date" value="${row.talep_tarihi}" onchange="updateField(${index}, 'talep_tarihi', this.value)"></td>
                <td><input type="date" value="${row.istenen_teslim_tarihi}" onchange="updateField(${index}, 'istenen_teslim_tarihi', this.value)"></td>
                <td><input type="text" value="${row.talep_edilen_malzeme}" onchange="updateField(${index}, 'talep_edilen_malzeme', this.value)"></td>
                <td><input type="text" value="${row.detay_1}" onchange="updateField(${index}, 'detay_1', this.value)"></td>
                <td><input type="text" value="${row.detay_2}" onchange="updateField(${index}, 'detay_2', this.value)"></td>
                <td>
                    <select onchange="updateField(${index}, 'birim', this.value)">
                        <option value="ADET" ${row.birim === 'ADET' ? 'selected' : ''}>ADET</option>
                        <option value="KG" ${row.birim === 'KG' ? 'selected' : ''}>KG</option>
                        <option value="LT" ${row.birim === 'LT' ? 'selected' : ''}>LT</option>
                        <option value="METRE" ${row.birim === 'METRE' ? 'selected' : ''}>METRE</option>
                        <option value="M2" ${row.birim === 'M2' ? 'selected' : ''}>M2</option>
                        <option value="M3" ${row.birim === 'M3' ? 'selected' : ''}>M3</option>
                        <option value="SET" ${row.birim === 'SET' ? 'selected' : ''}>SET</option>
                        <option value="PAKET" ${row.birim === 'PAKET' ? 'selected' : ''}>PAKET</option>
                        <option value="KUTU" ${row.birim === 'KUTU' ? 'selected' : ''}>KUTU</option>
                    </select>
                </td>
                <td><input type="number" value="${row.talep_miktari}" onchange="updateField(${index}, 'talep_miktari', parseFloat(this.value) || 0)"></td>
                <td><input type="number" value="${row.siparis_miktari}" onchange="updateField(${index}, 'siparis_miktari', parseFloat(this.value) || 0)"></td>
                <td><input type="number" step="0.01" value="${row.birim_fiyat}" onchange="updateField(${index}, 'birim_fiyat', parseFloat(this.value) || 0)"></td>
                <td class="font-bold">${row.toplam_fiyat.toFixed(2)}</td>
                <td><input type="text" value="${row.tedarikci}" onchange="updateField(${index}, 'tedarikci', this.value)"></td>
                <td><input type="text" value="${row.satinalma_sorumlusu}" onchange="updateField(${index}, 'satinalma_sorumlusu', this.value)"></td>
                <td><input type="date" value="${row.planlanan_teslim_tarihi}" onchange="updateField(${index}, 'planlanan_teslim_tarihi', this.value)"></td>
                <td><input type="number" value="${row.teslimat_miktari}" onchange="updateField(${index}, 'teslimat_miktari', parseFloat(this.value) || 0)"></td>
                <td><input type="date" value="${row.teslimat_tarihi}" onchange="updateField(${index}, 'teslimat_tarihi', this.value)"></td>
                <td><input type="number" value="${row.kalan_miktar}" onchange="updateField(${index}, 'kalan_miktar', parseFloat(this.value) || 0)"></td>
                <td>
                    <select onchange="updateField(${index}, 'onay_durumu', this.value)">
                        <option value="BEKLEMEDE" ${row.onay_durumu === 'BEKLEMEDE' ? 'selected' : ''}>BEKLEMEDE</option>
                        <option value="ONAY BEKLƒ∞YOR" ${row.onay_durumu === 'ONAY BEKLƒ∞YOR' ? 'selected' : ''}>ONAY BEKLƒ∞YOR</option>
                        <option value="ONAYLANDI" ${row.onay_durumu === 'ONAYLANDI' ? 'selected' : ''}>ONAYLANDI</option>
                        <option value="√ñDEME BEKLƒ∞YOR" ${row.onay_durumu === '√ñDEME BEKLƒ∞YOR' ? 'selected' : ''}>√ñDEME BEKLƒ∞YOR</option>
                        <option value="TAMAMLANDI" ${row.onay_durumu === 'TAMAMLANDI' ? 'selected' : ''}>TAMAMLANDI</option>
                        <option value="RED EDƒ∞LDƒ∞" ${row.onay_durumu === 'RED EDƒ∞LDƒ∞' ? 'selected' : ''}>RED EDƒ∞LDƒ∞</option>
                    </select>
                </td>
                <td><input type="text" value="${row.aciklama}" onchange="updateField(${index}, 'aciklama', this.value)"></td>
            `;
            return tr;
        }

        // Optimized: Selective DOM updates
        function renderTable() {
            const tbody = document.getElementById('table-body');
            const existingRows = new Map();
            
            // Mevcut satƒ±rlarƒ± map'e al
            [...tbody.children].forEach(row => {
                const rowId = row.dataset.rowId;
                if (rowId) {
                    existingRows.set(rowId, row);
                }
            });

            // Yeni veya g√ºncellenmi≈ü satƒ±rlarƒ± i≈üle
            currentData.forEach((row, index) => {
                const rowId = row.__backendId || index;
                
                if (existingRows.has(rowId)) {
                    // Mevcut satƒ±rƒ± g√ºncelle
                    const existingRow = existingRows.get(rowId);
                    const newRow = createTableRow(row, index);
                    tbody.replaceChild(newRow, existingRow);
                    existingRows.delete(rowId);
                } else {
                    // Yeni satƒ±r ekle
                    const newRow = createTableRow(row, index);
                    tbody.appendChild(newRow);
                }
            });

            // Silinmi≈ü satƒ±rlarƒ± kaldƒ±r
            existingRows.forEach(row => row.remove());
        }

        function selectRow(index) {
            selectedRowIndex = index;
            document.querySelectorAll('#table-body tr').forEach((tr, i) => {
                tr.classList.toggle('selected-row', i === index);
            });
        }

        function getStatusClass(status) {
            switch(status) {
                case 'BEKLEMEDE': return 'status-beklemede';
                case 'ONAY BEKLƒ∞YOR': return 'status-onay-bekliyor';
                case 'ONAYLANDI': return 'status-onaylandi';
                case '√ñDEME BEKLƒ∞YOR': return 'status-odeme-bekliyor';
                case 'TAMAMLANDI': return 'status-tamamlandi';
                case 'RED EDƒ∞LDƒ∞': return 'status-red-edildi';
                default: return 'status-beklemede';
            }
        }

        async function updateField(index, field, value) {
            if (isLoading) return;
            
            const row = currentData[index];
            row[field] = value;
            
            // Malzeme tipi deƒüi≈ütiƒüinde form numarasƒ±nƒ± g√ºncelle
            if (field === 'malzeme_tipi') {
                // Mevcut form numarasƒ±ndan index'i √ßƒ±kar veya satƒ±r pozisyonunu kullan
                const currentMatch = row.sof_form_no.match(/RF100\.SOF[SD]-(\d+)/);
                let formIndex;
                
                if (currentMatch) {
                    formIndex = parseInt(currentMatch[1]);
                } else {
                    // Form numarasƒ± yoksa veya ge√ßersizse, satƒ±r pozisyonunu kullan
                    formIndex = index + 1;
                }
                
                row.sof_form_no = generateFormNumber(formIndex, value);
                
                // Form numarasƒ± h√ºcresini g√ºncelle
                const formNoCell = document.querySelector(`#table-body tr:nth-child(${index + 1}) td:nth-child(3)`);
                if (formNoCell) {
                    formNoCell.textContent = row.sof_form_no;
                }
                debouncedCalculateTotal();
            }
            
            // Otomatik hesaplama: TOPLAM Fƒ∞YAT = TALEP Mƒ∞KTARI √ó Bƒ∞Rƒ∞M Fƒ∞YAT
            if (field === 'talep_miktari' || field === 'birim_fiyat') {
                row.toplam_fiyat = row.talep_miktari * row.birim_fiyat;
                
                // Toplam fiyat h√ºcresini anƒ±nda g√ºncelle
                const toplamCell = document.querySelector(`#table-body tr:nth-child(${index + 1}) td:nth-child(15)`);
                if (toplamCell) {
                    toplamCell.textContent = row.toplam_fiyat.toFixed(2);
                }
                
                // Debounced toplam hesaplama
                debouncedCalculateTotal();
            }
            
            // Onay durumu deƒüi≈ütiƒüinde satƒ±r rengini g√ºncelle
            if (field === 'onay_durumu') {
                const tableRow = document.querySelector(`#table-body tr:nth-child(${index + 1})`);
                if (tableRow) {
                    // Eski status sƒ±nƒ±flarƒ±nƒ± kaldƒ±r
                    tableRow.className = tableRow.className.replace(/status-\w+/g, '');
                    // Yeni status sƒ±nƒ±fƒ±nƒ± ekle
                    tableRow.classList.add(getStatusClass(value));
                }
            }
            
            // Yalnƒ±zca kritik i≈ülemlerde loading g√∂ster
            if (field === 'onay_durumu' || field === 'malzeme_tipi') {
                showLoading();
            }
            
            const result = await window.dataSdk.update(row);
            
            if (field === 'onay_durumu' || field === 'malzeme_tipi') {
                hideLoading();
            }
            
            if (!result.isOk) {
                showNotification('G√ºncelleme sƒ±rasƒ±nda hata olu≈ütu: ' + result.error.message, 'error');
            }
        }

        function calculateTotal() {
            const sarfTotal = currentData
                .filter(row => row.malzeme_tipi === 'SARF')
                .reduce((sum, row) => sum + row.toplam_fiyat, 0);
            
            const demirbasTotal = currentData
                .filter(row => row.malzeme_tipi === 'DEMƒ∞RBA≈û')
                .reduce((sum, row) => sum + row.toplam_fiyat, 0);
            
            const genelTotal = sarfTotal + demirbasTotal;
            
            // T√ºrk√ße format ile panel kartlarƒ±nƒ± g√ºncelle (‚ÇΩ 125.430,00)
            document.getElementById('sarf-toplam-panel').textContent = `‚ÇΩ ${sarfTotal.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('demirbas-toplam-panel').textContent = `‚ÇΩ ${demirbasTotal.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('genel-toplam-panel').textContent = `‚ÇΩ ${genelTotal.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        async function yeniTalepBaslat() {
            if (isLoading) return;
            if (currentData.length >= 999) {
                showNotification('Maksimum 999 kayƒ±t sƒ±nƒ±rƒ±na ula≈üƒ±ldƒ±. L√ºtfen √∂nce bazƒ± kayƒ±tlarƒ± silin.', 'error');
                return;
            }
            
            showLoading();
            const newRow = createNewRow();
            const result = await window.dataSdk.create(newRow);
            hideLoading();
            
            if (!result.isOk) {
                showNotification('Yeni talep olu≈üturulurken hata olu≈ütu: ' + result.error.message, 'error');
            }
        }

        async function altSatirEkle() {
            if (isLoading) return;
            if (currentData.length >= 999) {
                showNotification('Maksimum 999 kayƒ±t sƒ±nƒ±rƒ±na ula≈üƒ±ldƒ±. L√ºtfen √∂nce bazƒ± kayƒ±tlarƒ± silin.', 'error');
                return;
            }
            
            if (currentData.length === 0) {
                showNotification('√ñnce "Yeni Talep Ba≈ülat" butonuna basarak bir form olu≈üturun.', 'info');
                return;
            }
            
            const lastFormNo = currentData[currentData.length - 1].sof_form_no;
            
            showLoading();
            const newRow = createNewRow(lastFormNo);
            const result = await window.dataSdk.create(newRow);
            hideLoading();
            
            if (!result.isOk) {
                showNotification('Alt satƒ±r eklenirken hata olu≈ütu: ' + result.error.message, 'error');
            }
        }

        async function satirSil() {
            if (isLoading) return;
            if (selectedRowIndex === -1) {
                showNotification('L√ºtfen silmek istediƒüiniz satƒ±rƒ± se√ßin.', 'info');
                return;
            }
            
            const selectedRow = currentData[selectedRowIndex];
            
            showLoading();
            const result = await window.dataSdk.delete(selectedRow);
            hideLoading();
            
            if (result.isOk) {
                selectedRowIndex = -1;
                showNotification('Satƒ±r ba≈üarƒ±yla silindi.', 'success');
            } else {
                showNotification('Satƒ±r silinirken hata olu≈ütu: ' + result.error.message, 'error');
            }
        }

        // Dinamik PDF k√ºt√ºphanesi y√ºkleme
        async function loadJsPDF() {
            if (jsPDFLoaded && window.jsPDF) {
                return true;
            }
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = () => {
                    jsPDFLoaded = true;
                    resolve(true);
                };
                script.onerror = () => {
                    reject(new Error('PDF k√ºt√ºphanesi y√ºklenemedi'));
                };
                document.head.appendChild(script);
            });
        }

        function csvDƒ±saAktar() {
            if (currentData.length === 0) {
                showNotification('Dƒ±≈üa aktarƒ±lacak veri bulunmuyor. √ñnce veri ekleyin.', 'info');
                return;
            }

            // CSV ba≈ülƒ±klarƒ±
            const headers = [
                'SIRA NO',
                'SOF FORM NO', 
                'MALZEME Tƒ∞Pƒ∞',
                'TALEP EDEN',
                'TALEP TARƒ∞Hƒ∞',
                'ƒ∞STENEN TESLƒ∞M TARƒ∞Hƒ∞',
                'TALEP EDƒ∞LEN MALZEME',
                'DETAY 1 (MARKA, MODEL VB)',
                'DETAY 2 (PROJE, STANDART VB KODLAR)',
                'Bƒ∞Rƒ∞M',
                'TALEP Mƒ∞KTARI',
                'Sƒ∞PARƒ∞≈û Mƒ∞KTARI',
                'Bƒ∞Rƒ∞M Fƒ∞YAT (‚ÇΩ RUB)',
                'TOPLAM Fƒ∞YAT (‚ÇΩ RUB)',
                'TEDARƒ∞K√áƒ∞',
                'SATINALMA SORUMLUSU',
                'PLANLANAN TESLƒ∞M TARƒ∞Hƒ∞',
                'TESLƒ∞MAT Mƒ∞KTARI',
                'TESLƒ∞MAT TARƒ∞Hƒ∞',
                'KALAN Mƒ∞KTAR',
                'ONAY DURUMU',
                'A√áIKLAMA'
            ];

            // CSV i√ßeriƒüi olu≈ütur
            let csvContent = '\uFEFF'; // UTF-8 BOM for Excel compatibility
            
            // Ba≈ülƒ±klarƒ± ekle
            csvContent += headers.join(';') + '\n';
            
            // Veri satƒ±rlarƒ±nƒ± ekle
            currentData.forEach(row => {
                const csvRow = [
                    row.sira_no,
                    `"${row.sof_form_no}"`,
                    `"${row.malzeme_tipi}"`,
                    `"${row.talep_eden}"`,
                    `"${row.talep_tarihi}"`,
                    `"${row.istenen_teslim_tarihi}"`,
                    `"${row.talep_edilen_malzeme}"`,
                    `"${row.detay_1}"`,
                    `"${row.detay_2}"`,
                    `"${row.birim}"`,
                    row.talep_miktari,
                    row.siparis_miktari,
                    row.birim_fiyat.toFixed(2),
                    row.toplam_fiyat.toFixed(2),
                    `"${row.tedarikci}"`,
                    `"${row.satinalma_sorumlusu}"`,
                    `"${row.planlanan_teslim_tarihi}"`,
                    row.teslimat_miktari,
                    `"${row.teslimat_tarihi}"`,
                    row.kalan_miktar,
                    `"${row.onay_durumu}"`,
                    `"${row.aciklama}"`
                ];
                csvContent += csvRow.join(';') + '\n';
            });

            // Alt toplamlarƒ± ekle
            csvContent += '\n'; // Bo≈ü satƒ±r
            
            const sarfTotal = currentData
                .filter(row => row.malzeme_tipi === 'SARF')
                .reduce((sum, row) => sum + row.toplam_fiyat, 0);
            const demirbasTotal = currentData
                .filter(row => row.malzeme_tipi === 'DEMƒ∞RBA≈û')
                .reduce((sum, row) => sum + row.toplam_fiyat, 0);
            const genelTotal = sarfTotal + demirbasTotal;
            
            csvContent += `"SARF TOPLAMI (‚ÇΩ RUB):";;;;;;;;;;;;;;;"${sarfTotal.toFixed(2)}"\n`;
            csvContent += `"DEMƒ∞RBA≈û TOPLAMI (‚ÇΩ RUB):";;;;;;;;;;;;;;;"${demirbasTotal.toFixed(2)}"\n`;
            csvContent += `"GENEL TOPLAM (‚ÇΩ RUB):";;;;;;;;;;;;;;;"${genelTotal.toFixed(2)}"\n`;

            // Dosya adƒ± olu≈ütur
            const today = new Date().toLocaleDateString('tr-TR');
            const fileName = `SOMTECH_SOF_${today.replace(/\./g, '_')}.csv`;

            // CSV dosyasƒ±nƒ± indir
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification(`CSV dosyasƒ± ba≈üarƒ±yla indirildi: ${fileName}`, 'success');
            } else {
                showNotification('Tarayƒ±cƒ±nƒ±z dosya indirmeyi desteklemiyor.', 'error');
            }
        }

        // Yeni CSV dƒ±≈üa aktarma fonksiyonu - istenen formatta
        function exportToCSV() {
            if (currentData.length === 0) {
                showNotification('Dƒ±≈üa aktarƒ±lacak veri bulunmuyor. √ñnce veri ekleyin.', 'info');
                return;
            }

            const today = new Date();
            const fileName = `SOF_TALEP_LISTESI_${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}.csv`;

            // Tablo verilerinden ba≈ülƒ±klarƒ± al
            const headers = [
                'sira_no',
                'sof_form_no',
                'malzeme_tipi',
                'talep_eden',
                'talep_tarihi',
                'istenen_teslim_tarihi',
                'talep_edilen_malzeme',
                'detay_1',
                'detay_2',
                'birim',
                'talep_miktari',
                'siparis_miktari',
                'birim_fiyat',
                'toplam_fiyat',
                'tedarikci',
                'satinalma_sorumlusu',
                'planlanan_teslim_tarihi',
                'teslimat_miktari',
                'teslimat_tarihi',
                'kalan_miktar',
                'onay_durumu',
                'aciklama'
            ];

            // CSV satƒ±rlarƒ± olu≈ütur
            const csvRows = [headers.join(";")];

            currentData.forEach(row => {
                const values = headers.map(h => {
                    const value = row[h];
                    if (value === null || value === undefined) {
                        return "";
                    }
                    // String deƒüerleri √ßift tƒ±rnak i√ßine al ve i√ßindeki √ßift tƒ±rnaklarƒ± escape et
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(";"));
            });

            // UTF-8 BOM ekleyerek CSV string olu≈ütur
            const csvString = '\uFEFF' + csvRows.join("\n");
            
            // Blob olu≈ütur ve indir
            const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = fileName;
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification(`üì¶ Veriler ba≈üarƒ±yla dƒ±≈üa aktarƒ±ldƒ±: ${fileName}`, 'success');
            } else {
                showNotification('Tarayƒ±cƒ±nƒ±z dosya indirmeyi desteklemiyor.', 'error');
            }
        }

        async function pdfIndir() {
            // PDF k√ºt√ºphanesini dinamik olarak y√ºkle
            try {
                showLoading();
                await loadJsPDF();
                hideLoading();
            } catch (error) {
                hideLoading();
                showNotification('PDF k√ºt√ºphanesi y√ºklenemedi. L√ºtfen tekrar deneyin.', 'error');
                return;
            }

            const { jsPDF } = window.jsPDF;
            const doc = new jsPDF('l', 'mm', 'a4'); // A4 Landscape - 297x210mm
            
            // Logo ekleme
            const logoUrl = 'https://raw.githubusercontent.com/okarsli/deneme/main/%C5%9Eeffaf%20Logo.png';
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
                try {
                    // Logo ortada hizalanmƒ±≈ü, max 120px geni≈ülik
                    const logoWidth = 40; // mm cinsinden
                    const logoHeight = 20; // mm cinsinden
                    const pageWidth = 297; // A4 landscape geni≈ülik
                    const logoX = (pageWidth - logoWidth) / 2; // Ortala
                    doc.addImage(img, 'PNG', logoX, 20, logoWidth, logoHeight);
                } catch (e) {
                    console.log('Logo eklenemedi:', e);
                }
                generatePDFContent(doc);
            };
            
            img.onerror = function() {
                console.log('Logo y√ºklenemedi, PDF logo olmadan olu≈üturuluyor');
                generatePDFContent(doc);
            };
            
            img.src = logoUrl;
        }

        function generatePDFContent(doc) {
            const pageWidth = 297; // A4 landscape geni≈ülik
            const pageHeight = 210; // A4 landscape y√ºkseklik
            const margin = 15; // 15mm kenar bo≈üluƒüu
            
            // Logo altƒ±nda "Satƒ±n Alma Y√∂netim Sistemi" metni - gri renkte
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(107, 114, 128); // Gri renk (#6b7280)
            doc.text('Satƒ±n Alma Y√∂netim Sistemi', pageWidth / 2, 50, { align: 'center' });
            
            // Logo altƒ±na ince gri √ßizgi (#d1d5db)
            doc.setDrawColor(209, 213, 219); // #d1d5db
            doc.setLineWidth(0.5);
            doc.line(margin, 55, pageWidth - margin, 55);
            
            // Ana ba≈ülƒ±k
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0); // Siyah
            doc.text('Sƒ∞PARƒ∞≈û ONAY FORMU (SOF)', pageWidth / 2, 65, { align: 'center' });
            
            // Tarih - saƒü √ºstte
            const today = new Date().toLocaleDateString('tr-TR');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text(`Tarih: ${today}`, pageWidth - margin, 25, { align: 'right' });
            
            // Tablo ba≈ülƒ±klarƒ±
            const headers = [
                'Sƒ±ra No', 'Form No', 'Malzeme Tipi', 'Talep Eden', 'Talep Edilen Malzeme', 
                'Birim', 'Talep Miktarƒ±', 'Birim Fiyat (‚ÇΩ RUB)', 'Toplam Fiyat (‚ÇΩ RUB)', 'Onay Durumu'
            ];
            
            let yPos = 75;
            doc.setFontSize(8);
            doc.setFont('helvetica', 'bold');
            
            // Tablo geni≈üliƒüi hesaplama
            const tableWidth = pageWidth - (2 * margin);
            const colWidths = [20, 35, 25, 30, 60, 15, 20, 30, 30, 25]; // Toplam: 290mm
            
            // Ba≈ülƒ±k satƒ±rƒ± - gri arka plan (#f3f4f6)
            doc.setFillColor(243, 244, 246);
            doc.setTextColor(0, 0, 0);
            doc.setDrawColor(209, 213, 219); // Gri kenarlƒ±k
            
            let xPos = margin;
            headers.forEach((header, i) => {
                doc.rect(xPos, yPos, colWidths[i], 10, 'FD'); // Fill and Draw
                doc.text(header, xPos + 2, yPos + 6);
                xPos += colWidths[i];
            });
            
            yPos += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            
            // Veri satƒ±rlarƒ±
            currentData.forEach((row, index) => {
                // Sayfa kontrol√º - alt kƒ±sƒ±mda imza alanƒ± i√ßin yer bƒ±rak
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 25; // Yeni sayfada √ºstten ba≈üla
                }
                
                xPos = margin;
                const rowData = [
                    row.sira_no.toString(),
                    row.sof_form_no,
                    row.malzeme_tipi,
                    row.talep_eden.length > 18 ? row.talep_eden.substring(0, 18) + '...' : row.talep_eden,
                    row.talep_edilen_malzeme.length > 35 ? row.talep_edilen_malzeme.substring(0, 35) + '...' : row.talep_edilen_malzeme,
                    row.birim,
                    row.talep_miktari.toString(),
                    `${row.birim_fiyat.toFixed(2)} ‚ÇΩ`,
                    `${row.toplam_fiyat.toFixed(2)} ‚ÇΩ`,
                    row.onay_durumu
                ];
                
                // Zebra striping - √ßift satƒ±rlar a√ßƒ±k gri
                if (index % 2 === 0) {
                    doc.setFillColor(249, 250, 251);
                    doc.rect(margin, yPos, tableWidth, 8, 'F');
                }
                
                // H√ºcre kenarlƒ±klarƒ± ve veriler
                rowData.forEach((data, i) => {
                    doc.setDrawColor(209, 213, 219); // Gri kenarlƒ±k
                    doc.rect(xPos, yPos, colWidths[i], 8, 'D');
                    doc.text(data, xPos + 1, yPos + 5);
                    xPos += colWidths[i];
                });
                
                yPos += 8;
            });
            
            // Alt toplamlar
            yPos += 15;
            const sarfTotal = currentData
                .filter(row => row.malzeme_tipi === 'SARF')
                .reduce((sum, row) => sum + row.toplam_fiyat, 0);
            const demirbasTotal = currentData
                .filter(row => row.malzeme_tipi === 'DEMƒ∞RBA≈û')
                .reduce((sum, row) => sum + row.toplam_fiyat, 0);
            const genelTotal = sarfTotal + demirbasTotal;
            
            // Toplam tablosu
            const totalTableX = pageWidth - margin - 120;
            
            // SARF TOPLAMI
            doc.setFillColor(243, 244, 246);
            doc.rect(totalTableX, yPos, 120, 8, 'FD');
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text('SARF TOPLAMI:', totalTableX + 5, yPos + 5);
            doc.text(`${sarfTotal.toFixed(2)} ‚ÇΩ RUB`, totalTableX + 80, yPos + 5);
            
            yPos += 8;
            
            // DEMƒ∞RBA≈û TOPLAMI
            doc.setFillColor(243, 244, 246);
            doc.rect(totalTableX, yPos, 120, 8, 'FD');
            doc.text('DEMƒ∞RBA≈û TOPLAMI:', totalTableX + 5, yPos + 5);
            doc.text(`${demirbasTotal.toFixed(2)} ‚ÇΩ RUB`, totalTableX + 80, yPos + 5);
            
            yPos += 8;
            
            // GENEL TOPLAM
            doc.setFillColor(36, 89, 160);
            doc.setTextColor(255, 255, 255);
            doc.rect(totalTableX, yPos, 120, 10, 'FD');
            doc.setFontSize(10);
            doc.text('GENEL TOPLAM:', totalTableX + 5, yPos + 6);
            doc.text(`${genelTotal.toFixed(2)} ‚ÇΩ RUB`, totalTableX + 80, yPos + 6);
            
            // ƒ∞mza alanlarƒ± - sayfa altƒ±nda
            const signatureY = pageHeight - 25;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            
            // ƒ∞mza alanlarƒ± yatayda e≈üit aralƒ±kta
            const signatureWidth = (pageWidth - 2 * margin) / 3;
            const signatures = ['Oƒüuzhan Karslƒ±', 'Osman Tala≈ü', 'Mutlu Doƒüan'];
            
            signatures.forEach((name, index) => {
                const signatureX = margin + (index * signatureWidth);
                const centerX = signatureX + (signatureWidth / 2);
                
                // ƒ∞sim
                doc.text(name, centerX, signatureY, { align: 'center' });
                
                // Altƒ± √ßizili bo≈üluk (imza √ßizgisi)
                const lineWidth = 60; // mm
                const lineX = centerX - (lineWidth / 2);
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.5);
                doc.line(lineX, signatureY + 3, lineX + lineWidth, signatureY + 3);
            });
            
            // PDF kaydet
            const fileName = `SOMTECH_SOF_${today.replace(/\./g, '_')}.pdf`;
            doc.save(fileName);
            showNotification(`PDF dosyasƒ± ba≈üarƒ±yla indirildi: ${fileName}`, 'success');
        }

        // LocalStorage'dan veri y√ºkleme ve Data SDK'ya aktarma
        async function loadLocalStorageToDataSDK() {
            const localData = loadFromLocalStorage();
            if (localData && localData.length > 0) {
                showLoading();
                
                try {
                    // LocalStorage'daki her kayƒ±t i√ßin Data SDK'ya ekle
                    for (const record of localData) {
                        // __backendId'yi kaldƒ±r √ß√ºnk√º create i≈ülemi i√ßin gerekli deƒüil
                        const { __backendId, ...recordWithoutId } = record;
                        const result = await window.dataSdk.create(recordWithoutId);
                        if (!result.isOk) {
                            console.error('LocalStorage verisi Data SDK\'ya eklenirken hata:', result.error);
                        }
                    }
                    
                    hideLoading();
                    showNotification('‚úÖ Yerel kayƒ±t geri y√ºklendi', 'success');
                    return true; // Ba≈üarƒ±lƒ± y√ºkleme
                } catch (error) {
                    hideLoading();
                    console.error('LocalStorage verisi y√ºklenirken hata:', error);
                    showNotification('Yerel veriler y√ºklenirken hata olu≈ütu.', 'error');
                    return false;
                }
            }
            return false; // Yerel veri yok
        }

        // GitHub'dan CSV otomatik y√ºkleme fonksiyonu - tek seferlik
        async function csvOtomatikYukle() {
            // localStorage'dan daha √∂nce y√ºklenmi≈ü mi kontrol et
            if (localStorage.getItem('sofDataLoaded') === 'true') {
                console.log('Veriler daha √∂nce y√ºklenmi≈ü, tekrar y√ºkleme yapƒ±lmƒ±yor.');
                return;
            }

            const csvUrl = 'https://raw.githubusercontent.com/okarsli/deneme/refs/heads/main/data.csv';
            
            try {
                showLoading();
                
                // GitHub'dan CSV dosyasƒ±nƒ± CORS modunda indir
                const response = await fetch(csvUrl, {
                    mode: 'cors',
                    headers: {
                        'Accept': 'text/csv,text/plain,*/*',
                        'Accept-Charset': 'utf-8'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // UTF-8 olarak oku
                const csvText = await response.text();
                
                // CSV'yi ayrƒ±≈ütƒ±r ve tabloya ekle
                await parseCSVandFillTable(csvText);
                
                // Ba≈üarƒ±lƒ± y√ºkleme sonrasƒ± localStorage'a i≈üaretle
                localStorage.setItem('sofDataLoaded', 'true');
                
                hideLoading();
                
                // Ba≈üarƒ± bildirimi g√∂ster
                showNotification('‚úÖ Veriler ba≈üarƒ±yla y√ºklendi (tek seferlik)', 'success');
                
            } catch (error) {
                hideLoading();
                console.error('CSV y√ºkleme hatasƒ±:', error);
                
                // CORS veya network hatasƒ± kontrol√º
                showNotification('‚ùå CSV verisi alƒ±namadƒ± veya bi√ßimi hatalƒ±.', 'error');
            }
        }

        // Ba≈ülƒ±k normalizasyon fonksiyonu - T√ºrk√ße karakterleri ve bo≈üluklarƒ± temizler
        function normalizeHeader(header) {
            return header
                .toUpperCase()
                .replace(/[ƒ∞I]/g, "I")
                .replace(/≈û/g, "S")
                .replace(/ƒû/g, "G")
                .replace(/√ú/g, "U")
                .replace(/√ñ/g, "O")
                .replace(/√á/g, "C")
                .replace(/["']/g, "")
                .replace(/\s+/g, "")
                .trim();
        }

        // CSV parse ve tablo doldurma fonksiyonu - noktalƒ± virg√ºl ayracƒ±yla
        async function parseCSVandFillTable(csvText) {
            // UTF-8 BOM karakterini temizle
            const cleanedText = csvText.replace(/^\uFEFF/, '');
            
            // CSV'yi satƒ±rlara b√∂l
            const lines = cleanedText.split('\n');
            
            // Bo≈ü satƒ±rlarƒ± ve sadece noktalƒ± virg√ºl i√ßeren satƒ±rlarƒ± filtrele
            const validLines = lines.filter(line => {
                const trimmed = line.trim();
                return trimmed !== '' && trimmed !== ';' && !trimmed.match(/^;+$/);
            });
            
            if (validLines.length < 2) {
                throw new Error('CSV dosyasƒ± ge√ßersiz veya bo≈ü');
            }
            
            // Noktalƒ± virg√ºl ayracƒ±yla ayrƒ±≈ütƒ±r
            const rows = validLines.map(line => {
                return line.split(';').map(cell => 
                    cell ? cell.trim().replace(/^"|"$/g, '') : ''
                );
            });

            // Ba≈ülƒ±klarƒ± al ve normalize et
            const headers = rows[0].map(h => h.trim());
            const normalizedHeaders = headers.map(normalizeHeader);

            // Normalize edilmi≈ü ba≈ülƒ±k e≈üle≈ütirme haritasƒ±
            const headerMap = {
                'SIRANO': 'SIRA_NO',
                'SOFFORMNO': 'SOF_FORM_NO', 
                'MALZEMETIPI': 'MALZEME_TIPI',
                'TALEPEDEN': 'TALEP_EDEN',
                'TALEPTARIHI': 'TALEP_TARIHI',
                'ISTENENTESLIMTARIHI': 'TESLIM_TARIHI',
                'TALEPEDILENMALZEME': 'MALZEME',
                'DETAY1(MARKA,MODELVB)': 'DETAY1',
                'DETAY1': 'DETAY1',
                'DETAY2(PROJE,STANDARTVBKODLAR)': 'DETAY2',
                'DETAY2': 'DETAY2',
                'BIRIM': 'BIRIM',
                'TALEPMIKTARI': 'TALEP_MIKTARI',
                'SIPARISMIKTARI': 'SIPARIS_MIKTARI',
                'BIRIMFIYAT(‚ÇΩRUB)': 'BIRIM_FIYAT',
                'BIRIMFIYAT': 'BIRIM_FIYAT',
                'TOPLAMFIYAT(‚ÇΩRUB)': 'TOPLAM_FIYAT',
                'TOPLAMFIYAT': 'TOPLAM_FIYAT',
                'TEDARIKCI': 'TEDARIKCI',
                'SATINALMASORUMLUSU': 'SATINALMA_SORUMLUSU',
                'PLANLANANTESLIMTARIHI': 'PLANLANAN_TESLIM',
                'TESLIMATMIKTARI': 'TESLIMAT_MIKTARI',
                'TESLIMATTARIHI': 'TESLIMAT_TARIHI',
                'KALANMIKTAR': 'KALAN_MIKTAR',
                'ONAYDURUMU': 'ONAY',
                'ACIKLAMA': 'ACIKLAMA'
            };

            // Normalize edilmi≈ü ba≈ülƒ±k indekslerini bul
            const indexes = {};
            for (const [normalizedKey, value] of Object.entries(headerMap)) {
                const index = normalizedHeaders.indexOf(normalizedKey);
                if (index !== -1) {
                    indexes[value] = index;
                }
            }

            // Eksik ba≈ülƒ±klarƒ± kontrol et
            if (Object.keys(indexes).length === 0) {
                throw new Error('Ge√ßerli ba≈ülƒ±k bulunamadƒ±');
            }

            console.log('Orijinal ba≈ülƒ±klar:', headers);
            console.log('Normalize edilmi≈ü ba≈ülƒ±klar:', normalizedHeaders);
            console.log('E≈üle≈üen indeksler:', indexes);

            // Veri satƒ±rlarƒ±nƒ± i≈üle
            const dataRows = rows.slice(1);
            let processedCount = 0;
            
            for (let i = 0; i < dataRows.length; i++) {
                const row = dataRows[i];
                
                // Bo≈ü satƒ±rlarƒ± atla
                if (!row || row.length === 0 || row.every(cell => !cell || cell.trim() === '')) {
                    continue;
                }
                
                // Satƒ±r verilerini hazƒ±rla
                const rowData = {};
                for (const [key, index] of Object.entries(indexes)) {
                    if (index !== undefined && row[index] !== undefined) {
                        const cellValue = row[index];
                        rowData[key] = cellValue ? cellValue.toString().trim() : '';
                    } else {
                        rowData[key] = '';
                    }
                }
                
                // En az bir veri varsa tabloya ekle
                const hasData = Object.values(rowData).some(value => value && value.trim() !== '');
                if (hasData) {
                    await addRowToTable(rowData, i + 1);
                    processedCount++;
                }
            }

            // Toplamlarƒ± hesapla
            calculateTotal();
            
            console.log(`CSV ba≈üarƒ±yla i≈ülendi: ${processedCount} kayƒ±t y√ºklendi`);
        }

        // Satƒ±r ekleme fonksiyonu - noktalƒ± virg√ºl CSV'den gelen veriler i√ßin
        async function addRowToTable(rowData, rowIndex) {
            // Malzeme tipini belirle
            const malzemeTipi = rowData.MALZEME_TIPI || 'SARF';
            
            // Form numarasƒ± kontrol√º - bo≈üsa otomatik olu≈ütur
            let formNo = rowData.SOF_FORM_NO;
            if (!formNo || formNo.trim() === '') {
                const newIndex = currentData.length + 1;
                formNo = generateFormNumber(newIndex, malzemeTipi);
            }
            
            // üîÑ Eksik alanlarƒ± otomatik doldur
            // 1Ô∏è‚É£ TALEP EDEN kontrol√º
            let talepEden = rowData.TALEP_EDEN;
            if (!talepEden || talepEden.trim() === '') {
                talepEden = 'Tanƒ±msƒ±z';
            }
            
            // 2Ô∏è‚É£ TALEP TARƒ∞Hƒ∞ kontrol√º - GG.AA.YYYY formatƒ±nda
            let talepTarihi = rowData.TALEP_TARIHI;
            if (!talepTarihi || talepTarihi.trim() === '') {
                const today = new Date();
                talepTarihi = `${String(today.getDate()).padStart(2, '0')}.${String(today.getMonth() + 1).padStart(2, '0')}.${today.getFullYear()}`;
            }
            
            // Yeni kayƒ±t olu≈ütur
            const newRecord = {
                sira_no: parseInt(rowData.SIRA_NO) || nextSiraNo++,
                sof_form_no: formNo,
                malzeme_tipi: malzemeTipi,
                talep_eden: talepEden,
                talep_tarihi: talepTarihi,
                istenen_teslim_tarihi: rowData.TESLIM_TARIHI || '',
                talep_edilen_malzeme: rowData.MALZEME || '',
                detay_1: rowData.DETAY1 || '',
                detay_2: rowData.DETAY2 || '',
                birim: rowData.BIRIM || 'ADET',
                talep_miktari: parseFloat(rowData.TALEP_MIKTARI) || 0,
                siparis_miktari: parseFloat(rowData.SIPARIS_MIKTARI) || 0,
                birim_fiyat: parseFloat(rowData.BIRIM_FIYAT) || 0,
                toplam_fiyat: parseFloat(rowData.TOPLAM_FIYAT) || 0, // CSV'den gelen deƒüer kullanƒ±lƒ±r
                tedarikci: rowData.TEDARIKCI || '',
                satinalma_sorumlusu: rowData.SATINALMA_SORUMLUSU || '',
                planlanan_teslim_tarihi: rowData.PLANLANAN_TESLIM || '',
                teslimat_miktari: parseFloat(rowData.TESLIMAT_MIKTARI) || 0,
                teslimat_tarihi: rowData.TESLIMAT_TARIHI || '',
                kalan_miktar: parseFloat(rowData.KALAN_MIKTAR) || 0,
                onay_durumu: rowData.ONAY || 'BEKLEMEDE',
                aciklama: rowData.ACIKLAMA || ''
            };
            
            // Eƒüer CSV'de toplam fiyat yoksa otomatik hesapla: TOPLAM Fƒ∞YAT = TALEP Mƒ∞KTARI √ó Bƒ∞Rƒ∞M Fƒ∞YAT
            if (!newRecord.toplam_fiyat && newRecord.talep_miktari && newRecord.birim_fiyat) {
                newRecord.toplam_fiyat = newRecord.talep_miktari * newRecord.birim_fiyat;
            }
            
            // Data SDK'ya kaydet
            const result = await window.dataSdk.create(newRecord);
            if (!result.isOk) {
                console.error('Kayƒ±t eklenirken hata:', result.error);
            }
        }

        // Bildirim g√∂sterme fonksiyonu
        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            
            // Mevcut bildirimleri temizle
            notificationArea.innerHTML = '';
            
            const notification = document.createElement('div');
            
            // Tailwind sƒ±nƒ±flarƒ±nƒ± type'a g√∂re ayarla
            let classes = 'p-2 rounded-md shadow-sm text-center transition-all duration-300 ';
            
            if (type === 'success') {
                classes += 'bg-green-100 text-green-800 border border-green-300';
            } else if (type === 'error') {
                classes += 'bg-red-100 text-red-800 border border-red-300';
            } else {
                classes += 'bg-blue-100 text-blue-800 border border-blue-300';
            }
            
            notification.className = classes;
            notification.textContent = message;
            
            notificationArea.appendChild(notification);
            
            // 3 saniye sonra otomatik kaybolma
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Event listeners
        document.getElementById('yeni-talep-btn').addEventListener('click', yeniTalepBaslat);
        document.getElementById('alt-satir-btn').addEventListener('click', altSatirEkle);
        document.getElementById('satir-sil-btn').addEventListener('click', satirSil);
        document.getElementById('pdf-btn').addEventListener('click', pdfIndir);
        document.getElementById('kaydet-btn').addEventListener('click', csvDƒ±saAktar);
        document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
        document.getElementById('clear-local-btn').addEventListener('click', clearLocalStorage);

        // Initialize
        window.addEventListener('load', async () => {
            if (window.dataSdk) {
                const initResult = await window.dataSdk.init(dataHandler);
                if (!initResult.isOk) {
                    console.error('Data SDK ba≈ülatƒ±lamadƒ±:', initResult.error);
                    return;
                }
                
                // √ñnce localStorage'dan veri y√ºklemeyi dene
                const localDataLoaded = await loadLocalStorageToDataSDK();
                
                // Eƒüer localStorage'da veri yoksa ve daha √∂nce CSV y√ºklenmemi≈üse GitHub'dan y√ºkle
                if (!localDataLoaded && localStorage.getItem('sofDataLoaded') !== 'true' && currentData.length === 0) {
                    await csvOtomatikYukle();
                }
            }
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98ff2e78312dd35d',t:'MTc2MDY5NzY2NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
