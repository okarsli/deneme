<!doctype html>
<html lang="tr">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOF Ana Liste</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Calibri', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .table-container {
            overflow-x: auto;
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 2000px;
        }
        
        th, td {
            border: 1px solid #d1d5db;
            padding: 8px;
            text-align: left;
            font-size: 12px;
            white-space: nowrap;
        }
        
        @media (max-width: 768px) {
            th, td {
                padding: 6px;
                font-size: 10px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 12px;
                margin: 2px;
            }
            
            .container {
                padding: 4px;
            }
        }
        
        th {
            background-color: #2459a0;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        tr:nth-child(odd) {
            background-color: white;
        }
        
        /* Onay durumu renkleri */
        .status-beklemede {
            background-color: #e5e7eb !important;
            transition: all 300ms ease;
        }
        
        .status-onaylandi {
            background-color: #2459a0 !important;
            color: white !important;
            transition: all 300ms ease;
        }
        
        .status-odeme-bekliyor {
            background-color: #f59e0b !important;
            color: white !important;
            transition: all 300ms ease;
        }
        
        .status-tamamlandi {
            background-color: #10b981 !important;
            color: white !important;
            transition: all 300ms ease;
        }
        
        .status-red-edildi {
            background-color: #dc2626 !important;
            color: white !important;
            transition: all 300ms ease;
        }
        
        input[type="text"], input[type="number"], input[type="date"], select {
            width: 100%;
            padding: 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .total-row {
            background-color: #f3f4f6 !important;
            font-weight: bold;
        }
        
        .grand-total-row {
            background-color: #2459a0 !important;
            color: white !important;
            font-weight: bold;
        }
        
        .selected-row {
            background-color: #dbeafe !important;
        }
        
        .btn {
            padding: 8px 16px;
            margin: 4px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: #2459a0;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1e40af;
        }
        
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        
        .btn-success {
            background-color: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #047857;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="bg-gray-100 min-h-full">
  <div class="container mx-auto p-6 bg-white shadow-lg rounded-lg my-4">
   <header class="mb-6 text-center">
    <h1 id="system-title" class="text-3xl font-bold text-gray-800 mb-2">SOF Ana Liste</h1>
    <p id="company-name" class="text-lg text-gray-600">Malzeme Talep Y√∂netim Sistemi</p>
   </header>
   <div class="mb-6 flex flex-wrap gap-2 justify-center"><button id="yeni-talep-btn" class="btn btn-primary"> üìù Yeni Talep Ba≈ülat </button> <button id="alt-satir-btn" class="btn btn-secondary"> ‚ûï Alt Satƒ±r Ekle </button> <button id="satir-sil-btn" class="btn btn-danger"> üóëÔ∏è Satƒ±r Sil </button> <button id="pdf-btn" class="btn btn-success"> üìÑ PDF ƒ∞ndir </button> <button id="kaydet-btn" class="btn btn-success"> üíæ Kaydet </button>
   </div><!-- Toplam Bilgi Paneli -->
   <div class="mb-6">
    <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">üìä Toplam Bilgi Paneli</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto"><!-- SARF TOPLAMI Kartƒ± -->
     <div class="bg-gray-100 rounded-xl shadow-md p-6 text-center border-l-4 border-gray-500">
      <div class="flex items-center justify-center mb-3"><span class="text-2xl mr-2">üì¶</span>
       <h3 class="text-lg font-bold text-gray-700">SARF TOPLAMI</h3>
      </div>
      <div class="text-3xl font-bold text-gray-800" id="sarf-toplam-panel">
       0.00
      </div>
      <div class="text-sm text-gray-600 mt-1">
       ‚ÇΩ RUB
      </div>
     </div><!-- DEMƒ∞RBA≈û TOPLAMI Kartƒ± -->
     <div class="bg-red-50 rounded-xl shadow-md p-6 text-center border-l-4 border-red-400">
      <div class="flex items-center justify-center mb-3"><span class="text-2xl mr-2">üè≠</span>
       <h3 class="text-lg font-bold text-red-700">DEMƒ∞RBA≈û TOPLAMI</h3>
      </div>
      <div class="text-3xl font-bold text-red-800" id="demirbas-toplam-panel">
       0.00
      </div>
      <div class="text-sm text-red-600 mt-1">
       ‚ÇΩ RUB
      </div>
     </div>
    </div>
   </div>
   <div id="loading-indicator" class="hidden text-center py-4">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
    <p class="mt-2 text-gray-600">ƒ∞≈ülem yapƒ±lƒ±yor...</p>
   </div>
   <div class="table-container">
    <table id="sof-table">
     <thead>
      <tr>
       <th>Se√ß</th>
       <th>SIRA NO</th>
       <th>SOF FORM NO</th>
       <th>MALZEME Tƒ∞Pƒ∞</th>
       <th>TALEP EDEN</th>
       <th>TALEP TARƒ∞Hƒ∞</th>
       <th>ƒ∞STENEN TESLƒ∞M TARƒ∞Hƒ∞</th>
       <th>TALEP EDƒ∞LEN MALZEME</th>
       <th>DETAY 1 (MARKA, MODEL VB)</th>
       <th>DETAY 2 (PROJE, STANDART VB KODLAR)</th>
       <th>Bƒ∞Rƒ∞M</th>
       <th>TALEP Mƒ∞KTARI</th>
       <th>Sƒ∞PARƒ∞≈û Mƒ∞KTARI</th>
       <th>Bƒ∞Rƒ∞M Fƒ∞YAT (‚ÇΩ RUB)</th>
       <th>TOPLAM Fƒ∞YAT (‚ÇΩ RUB)</th>
       <th>TEDARƒ∞K√áƒ∞</th>
       <th>SATINALMA SORUMLUSU</th>
       <th>PLANLANAN TESLƒ∞M TARƒ∞Hƒ∞</th>
       <th>TESLƒ∞MAT Mƒ∞KTARI</th>
       <th>TESLƒ∞MAT TARƒ∞Hƒ∞</th>
       <th>KALAN Mƒ∞KTAR</th>
       <th>ONAY DURUMU</th>
       <th>A√áIKLAMA</th>
      </tr>
     </thead>
     <tbody id="table-body">
     </tbody>
     <tfoot>
      <tr class="total-row">
       <td colspan="14" class="text-right font-bold">SARF TOPLAMI (‚ÇΩ RUB):</td>
       <td id="sarf-toplam" class="font-bold">0.00</td>
       <td colspan="8"></td>
      </tr>
      <tr class="total-row">
       <td colspan="14" class="text-right font-bold">DEMƒ∞RBA≈û TOPLAMI (‚ÇΩ RUB):</td>
       <td id="demirbas-toplam" class="font-bold">0.00</td>
       <td colspan="8"></td>
      </tr>
      <tr class="grand-total-row">
       <td colspan="14" class="text-right font-bold">GENEL TOPLAM (‚ÇΩ RUB):</td>
       <td id="genel-toplam" class="font-bold">0.00</td>
       <td colspan="8"></td>
      </tr>
     </tfoot>
    </table>
   </div>
  </div>
  <script>
        let currentData = [];
        let selectedRowIndex = -1;
        let nextSiraNo = 1;
        let nextFormNo = 1;
        let currentFormNo = '';
        let isLoading = false;

        const defaultConfig = {
            system_title: "SOF Ana Liste",
            company_name: "Malzeme Talep Y√∂netim Sistemi"
        };

        const dataHandler = {
            onDataChanged(data) {
                currentData = data.sort((a, b) => a.sira_no - b.sira_no);
                updateNextNumbers();
                renderTable();
                calculateTotal();
            }
        };

        function updateNextNumbers() {
            if (currentData.length > 0) {
                nextSiraNo = Math.max(...currentData.map(item => item.sira_no)) + 1;
                const formNumbers = currentData.map(item => {
                    const match = item.sof_form_no.match(/RF100\.SOF-(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                });
                nextFormNo = Math.max(...formNumbers, 0) + 1;
            }
        }

        function showLoading() {
            isLoading = true;
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.querySelectorAll('.btn').forEach(btn => btn.disabled = true);
        }

        function hideLoading() {
            isLoading = false;
            document.getElementById('loading-indicator').classList.add('hidden');
            document.querySelectorAll('.btn').forEach(btn => btn.disabled = false);
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function createNewRow(formNo = null) {
            const today = formatDate(new Date());
            
            if (!formNo) {
                currentFormNo = `RF100.SOF-${String(nextFormNo).padStart(4, '0')}`;
                nextFormNo++;
            } else {
                currentFormNo = formNo;
            }

            return {
                sira_no: nextSiraNo++,
                sof_form_no: currentFormNo,
                malzeme_tipi: 'SARF',
                talep_eden: '',
                talep_tarihi: today,
                istenen_teslim_tarihi: '',
                talep_edilen_malzeme: '',
                detay_1: '',
                detay_2: '',
                birim: '',
                talep_miktari: 0,
                siparis_miktari: 0,
                birim_fiyat: 0,
                toplam_fiyat: 0,
                tedarikci: '',
                satinalma_sorumlusu: '',
                planlanan_teslim_tarihi: '',
                teslimat_miktari: 0,
                teslimat_tarihi: '',
                kalan_miktar: 0,
                onay_durumu: 'BEKLEMEDE',
                aciklama: ''
            };
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            currentData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = getStatusClass(row.onay_durumu);
                tr.innerHTML = `
                    <td><input type="radio" name="selectedRow" value="${index}" onchange="selectRow(${index})"></td>
                    <td>${row.sira_no}</td>
                    <td>${row.sof_form_no}</td>
                    <td>
                        <select onchange="updateField(${index}, 'malzeme_tipi', this.value)">
                            <option value="SARF" ${row.malzeme_tipi === 'SARF' ? 'selected' : ''}>SARF</option>
                            <option value="DEMƒ∞RBA≈û" ${row.malzeme_tipi === 'DEMƒ∞RBA≈û' ? 'selected' : ''}>DEMƒ∞RBA≈û</option>
                        </select>
                    </td>
                    <td><input type="text" value="${row.talep_eden}" onchange="updateField(${index}, 'talep_eden', this.value)"></td>
                    <td><input type="date" value="${row.talep_tarihi}" onchange="updateField(${index}, 'talep_tarihi', this.value)"></td>
                    <td><input type="date" value="${row.istenen_teslim_tarihi}" onchange="updateField(${index}, 'istenen_teslim_tarihi', this.value)"></td>
                    <td><input type="text" value="${row.talep_edilen_malzeme}" onchange="updateField(${index}, 'talep_edilen_malzeme', this.value)"></td>
                    <td><input type="text" value="${row.detay_1}" onchange="updateField(${index}, 'detay_1', this.value)"></td>
                    <td><input type="text" value="${row.detay_2}" onchange="updateField(${index}, 'detay_2', this.value)"></td>
                    <td><input type="text" value="${row.birim}" onchange="updateField(${index}, 'birim', this.value)"></td>
                    <td><input type="number" value="${row.talep_miktari}" onchange="updateField(${index}, 'talep_miktari', parseFloat(this.value) || 0)"></td>
                    <td><input type="number" value="${row.siparis_miktari}" onchange="updateField(${index}, 'siparis_miktari', parseFloat(this.value) || 0)"></td>
                    <td><input type="number" step="0.01" value="${row.birim_fiyat}" onchange="updateField(${index}, 'birim_fiyat', parseFloat(this.value) || 0)"></td>
                    <td class="font-bold">${row.toplam_fiyat.toFixed(2)}</td>
                    <td><input type="text" value="${row.tedarikci}" onchange="updateField(${index}, 'tedarikci', this.value)"></td>
                    <td><input type="text" value="${row.satinalma_sorumlusu}" onchange="updateField(${index}, 'satinalma_sorumlusu', this.value)"></td>
                    <td><input type="date" value="${row.planlanan_teslim_tarihi}" onchange="updateField(${index}, 'planlanan_teslim_tarihi', this.value)"></td>
                    <td><input type="number" value="${row.teslimat_miktari}" onchange="updateField(${index}, 'teslimat_miktari', parseFloat(this.value) || 0)"></td>
                    <td><input type="date" value="${row.teslimat_tarihi}" onchange="updateField(${index}, 'teslimat_tarihi', this.value)"></td>
                    <td><input type="number" value="${row.kalan_miktar}" onchange="updateField(${index}, 'kalan_miktar', parseFloat(this.value) || 0)"></td>
                    <td>
                        <select onchange="updateField(${index}, 'onay_durumu', this.value)">
                            <option value="BEKLEMEDE" ${row.onay_durumu === 'BEKLEMEDE' ? 'selected' : ''}>BEKLEMEDE</option>
                            <option value="ONAYLANDI" ${row.onay_durumu === 'ONAYLANDI' ? 'selected' : ''}>ONAYLANDI</option>
                            <option value="√ñDEME BEKLƒ∞YOR" ${row.onay_durumu === '√ñDEME BEKLƒ∞YOR' ? 'selected' : ''}>√ñDEME BEKLƒ∞YOR</option>
                            <option value="TAMAMLANDI" ${row.onay_durumu === 'TAMAMLANDI' ? 'selected' : ''}>TAMAMLANDI</option>
                            <option value="RED EDƒ∞LDƒ∞" ${row.onay_durumu === 'RED EDƒ∞LDƒ∞' ? 'selected' : ''}>RED EDƒ∞LDƒ∞</option>
                        </select>
                    </td>
                    <td><input type="text" value="${row.aciklama}" onchange="updateField(${index}, 'aciklama', this.value)"></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function selectRow(index) {
            selectedRowIndex = index;
            document.querySelectorAll('#table-body tr').forEach((tr, i) => {
                tr.classList.toggle('selected-row', i === index);
            });
        }

        function getStatusClass(status) {
            switch(status) {
                case 'BEKLEMEDE': return 'status-beklemede';
                case 'ONAYLANDI': return 'status-onaylandi';
                case '√ñDEME BEKLƒ∞YOR': return 'status-odeme-bekliyor';
                case 'TAMAMLANDI': return 'status-tamamlandi';
                case 'RED EDƒ∞LDƒ∞': return 'status-red-edildi';
                default: return 'status-beklemede';
            }
        }

        async function updateField(index, field, value) {
            if (isLoading) return;
            
            const row = currentData[index];
            row[field] = value;
            
            // Otomatik hesaplama: TOPLAM Fƒ∞YAT = TALEP Mƒ∞KTARI √ó Bƒ∞Rƒ∞M Fƒ∞YAT
            if (field === 'talep_miktari' || field === 'birim_fiyat') {
                row.toplam_fiyat = row.talep_miktari * row.birim_fiyat;
                
                // Toplam fiyat h√ºcresini anƒ±nda g√ºncelle
                const toplamCell = document.querySelector(`#table-body tr:nth-child(${index + 1}) td:nth-child(15)`);
                if (toplamCell) {
                    toplamCell.textContent = row.toplam_fiyat.toFixed(2);
                }
                
                // Alt toplamlarƒ± ve genel toplamƒ± g√ºncelle
                calculateTotal();
            }
            
            // Malzeme tipi deƒüi≈ütiƒüinde alt toplamlarƒ± g√ºncelle
            if (field === 'malzeme_tipi') {
                calculateTotal();
            }
            
            // Onay durumu deƒüi≈ütiƒüinde satƒ±r rengini g√ºncelle
            if (field === 'onay_durumu') {
                const tableRow = document.querySelector(`#table-body tr:nth-child(${index + 1})`);
                if (tableRow) {
                    // Eski status sƒ±nƒ±flarƒ±nƒ± kaldƒ±r
                    tableRow.className = tableRow.className.replace(/status-\w+/g, '');
                    // Yeni status sƒ±nƒ±fƒ±nƒ± ekle
                    tableRow.classList.add(getStatusClass(value));
                }
            }
            
            showLoading();
            const result = await window.dataSdk.update(row);
            hideLoading();
            
            if (!result.isOk) {
                alert('G√ºncelleme sƒ±rasƒ±nda hata olu≈ütu: ' + result.error.message);
            }
        }

        function calculateTotal() {
            const sarfTotal = currentData
                .filter(row => row.malzeme_tipi === 'SARF')
                .reduce((sum, row) => sum + row.toplam_fiyat, 0);
            
            const demirbasTotal = currentData
                .filter(row => row.malzeme_tipi === 'DEMƒ∞RBA≈û')
                .reduce((sum, row) => sum + row.toplam_fiyat, 0);
            
            const genelTotal = sarfTotal + demirbasTotal;
            
            // Tablo altƒ±ndaki toplamlarƒ± g√ºncelle
            document.getElementById('sarf-toplam').textContent = sarfTotal.toFixed(2);
            document.getElementById('demirbas-toplam').textContent = demirbasTotal.toFixed(2);
            document.getElementById('genel-toplam').textContent = genelTotal.toFixed(2);
            
            // √ústteki panel kartlarƒ±nƒ± g√ºncelle
            document.getElementById('sarf-toplam-panel').textContent = sarfTotal.toFixed(2);
            document.getElementById('demirbas-toplam-panel').textContent = demirbasTotal.toFixed(2);
        }

        async function yeniTalepBaslat() {
            if (isLoading) return;
            if (currentData.length >= 999) {
                alert('Maksimum 999 kayƒ±t sƒ±nƒ±rƒ±na ula≈üƒ±ldƒ±. L√ºtfen √∂nce bazƒ± kayƒ±tlarƒ± silin.');
                return;
            }
            
            showLoading();
            const newRow = createNewRow();
            const result = await window.dataSdk.create(newRow);
            hideLoading();
            
            if (!result.isOk) {
                alert('Yeni talep olu≈üturulurken hata olu≈ütu: ' + result.error.message);
            }
        }

        async function altSatirEkle() {
            if (isLoading) return;
            if (currentData.length >= 999) {
                alert('Maksimum 999 kayƒ±t sƒ±nƒ±rƒ±na ula≈üƒ±ldƒ±. L√ºtfen √∂nce bazƒ± kayƒ±tlarƒ± silin.');
                return;
            }
            
            if (currentData.length === 0) {
                alert('√ñnce "Yeni Talep Ba≈ülat" butonuna basarak bir form olu≈üturun.');
                return;
            }
            
            const lastFormNo = currentData[currentData.length - 1].sof_form_no;
            
            showLoading();
            const newRow = createNewRow(lastFormNo);
            const result = await window.dataSdk.create(newRow);
            hideLoading();
            
            if (!result.isOk) {
                alert('Alt satƒ±r eklenirken hata olu≈ütu: ' + result.error.message);
            }
        }

        async function satirSil() {
            if (isLoading) return;
            if (selectedRowIndex === -1) {
                alert('L√ºtfen silmek istediƒüiniz satƒ±rƒ± se√ßin.');
                return;
            }
            
            const selectedRow = currentData[selectedRowIndex];
            
            showLoading();
            const result = await window.dataSdk.delete(selectedRow);
            hideLoading();
            
            if (result.isOk) {
                selectedRowIndex = -1;
            } else {
                alert('Satƒ±r silinirken hata olu≈ütu: ' + result.error.message);
            }
        }

        function pdfIndir() {
            if (!window.jsPDF) {
                alert('PDF k√ºt√ºphanesi y√ºklenemedi.');
                return;
            }

            const { jsPDF } = window.jsPDF;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape orientation
            
            // Logo ekleme
            const logoUrl = 'https://resimlink.com/TUzslur';
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
                try {
                    doc.addImage(img, 'PNG', 10, 10, 40, 20);
                } catch (e) {
                    console.log('Logo eklenemedi:', e);
                }
                generatePDFContent(doc);
            };
            
            img.onerror = function() {
                console.log('Logo y√ºklenemedi, PDF logo olmadan olu≈üturuluyor');
                generatePDFContent(doc);
            };
            
            img.src = logoUrl;
        }

        function generatePDFContent(doc) {
            // Tarih saƒü √ºstte
            const today = new Date().toLocaleDateString('tr-TR');
            doc.setFontSize(10);
            doc.text(`Tarih: ${today}`, 250, 15);
            
            // Ana ba≈ülƒ±k - ortada
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('SOMTECH RU ‚Äì Sƒ∞PARƒ∞≈û ONAY FORMU (SOF)', 148, 40, { align: 'center' });
            
            // Tablo ba≈ülƒ±klarƒ± - daha kompakt
            const headers = [
                'Sƒ±ra', 'Form No', 'Tip', 'Talep Eden', 'Malzeme', 
                'Birim', 'Miktar', 'B.Fiyat', 'Toplam', 'Durum'
            ];
            
            let yPos = 55;
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            
            // Ba≈ülƒ±k satƒ±rƒ± - mavi arka plan
            doc.setFillColor(36, 89, 160); // #2459a0
            doc.setTextColor(255, 255, 255); // Beyaz yazƒ±
            
            let xPos = 10;
            const colWidths = [15, 30, 20, 30, 50, 15, 20, 20, 25, 25];
            
            headers.forEach((header, i) => {
                doc.rect(xPos, yPos, colWidths[i], 8, 'F');
                doc.text(header, xPos + 2, yPos + 5);
                xPos += colWidths[i];
            });
            
            yPos += 8;
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0); // Siyah yazƒ±
            
            // Veri satƒ±rlarƒ±
            currentData.forEach((row, index) => {
                if (yPos > 170) { // Yeni sayfa
                    doc.addPage();
                    yPos = 20;
                }
                
                xPos = 10;
                const rowData = [
                    row.sira_no.toString(),
                    row.sof_form_no,
                    row.malzeme_tipi,
                    row.talep_eden.substring(0, 15),
                    row.talep_edilen_malzeme.substring(0, 30),
                    row.birim,
                    row.talep_miktari.toString(),
                    row.birim_fiyat.toFixed(2),
                    row.toplam_fiyat.toFixed(2),
                    row.onay_durumu
                ];
                
                // Zebra striping
                if (index % 2 === 0) {
                    doc.setFillColor(249, 250, 251); // A√ßƒ±k gri
                    doc.rect(10, yPos, 250, 6, 'F');
                }
                
                rowData.forEach((data, i) => {
                    doc.rect(xPos, yPos, colWidths[i], 6);
                    doc.text(data, xPos + 1, yPos + 4);
                    xPos += colWidths[i];
                });
                
                yPos += 6;
            });
            
            // Alt toplamlar
            yPos += 10;
            const sarfTotal = currentData
                .filter(row => row.malzeme_tipi === 'SARF')
                .reduce((sum, row) => sum + row.toplam_fiyat, 0);
            const demirbasTotal = currentData
                .filter(row => row.malzeme_tipi === 'DEMƒ∞RBA≈û')
                .reduce((sum, row) => sum + row.toplam_fiyat, 0);
            const genelTotal = sarfTotal + demirbasTotal;
            
            // SARF TOPLAMI - gri arka plan
            doc.setFillColor(243, 244, 246);
            doc.rect(150, yPos, 110, 8, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('SARF TOPLAMI:', 155, yPos + 5);
            doc.text(`${sarfTotal.toFixed(2)} ‚ÇΩ`, 220, yPos + 5);
            
            yPos += 8;
            
            // DEMƒ∞RBA≈û TOPLAMI - gri arka plan
            doc.setFillColor(243, 244, 246);
            doc.rect(150, yPos, 110, 8, 'F');
            doc.text('DEMƒ∞RBA≈û TOPLAMI:', 155, yPos + 5);
            doc.text(`${demirbasTotal.toFixed(2)} ‚ÇΩ`, 220, yPos + 5);
            
            yPos += 8;
            
            // GENEL TOPLAM - mavi arka plan
            doc.setFillColor(36, 89, 160);
            doc.setTextColor(255, 255, 255);
            doc.rect(150, yPos, 110, 10, 'F');
            doc.setFontSize(10);
            doc.text('GENEL TOPLAM:', 155, yPos + 6);
            doc.text(`${genelTotal.toFixed(2)} ‚ÇΩ`, 220, yPos + 6);
            
            // Alt not
            doc.setFontSize(8);
            doc.setFont(undefined, 'italic');
            doc.setTextColor(128, 128, 128);
            doc.text('Bu belge elektronik ortamda hazƒ±rlanmƒ±≈ütƒ±r.', 148, 200, { align: 'center' });
            
            // PDF kaydet
            const fileName = `SOMTECH_SOF_${today.replace(/\./g, '_')}.pdf`;
            doc.save(fileName);
        }

        async function render(config) {
            document.getElementById('system-title').textContent = config.system_title || defaultConfig.system_title;
            document.getElementById('company-name').textContent = config.company_name || defaultConfig.company_name;
        }

        function mapToCapabilities(config) {
            return {
                recolorables: [],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            };
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ["system_title", config.system_title || defaultConfig.system_title],
                ["company_name", config.company_name || defaultConfig.company_name]
            ]);
        }

        // Event listeners
        document.getElementById('yeni-talep-btn').addEventListener('click', yeniTalepBaslat);
        document.getElementById('alt-satir-btn').addEventListener('click', altSatirEkle);
        document.getElementById('satir-sil-btn').addEventListener('click', satirSil);
        document.getElementById('pdf-btn').addEventListener('click', pdfIndir);
        document.getElementById('kaydet-btn').addEventListener('click', () => {
            alert('Veriler otomatik olarak Canva Sheet\'te saklanmaktadƒ±r.');
        });

        // Initialize
        window.addEventListener('load', async () => {
            if (window.dataSdk) {
                const initResult = await window.dataSdk.init(dataHandler);
                if (!initResult.isOk) {
                    console.error('Data SDK ba≈ülatƒ±lamadƒ±:', initResult.error);
                }
            }
            
            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    render,
                    mapToCapabilities,
                    mapToEditPanelValues
                });
            }
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98fe984416e53a72',t:'MTc2MDY5MTUxMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
