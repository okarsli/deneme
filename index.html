<!doctype html>
<html lang="tr">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOF Ana Liste</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Calibri', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Dark Mode Styles */
        .dark {
            background-color: #111827 !important;
            color: #E5E7EB !important;
        }
        
        .dark .bg-white {
            background-color: #1F2937 !important;
        }
        
        .dark .bg-gray-50 {
            background-color: #374151 !important;
        }
        
        .dark .bg-gray-100 {
            background-color: #4B5563 !important;
        }
        
        .dark .text-gray-600 {
            color: #D1D5DB !important;
        }
        
        .dark .text-gray-700 {
            color: #E5E7EB !important;
        }
        
        .dark .text-gray-800 {
            color: #F3F4F6 !important;
        }
        
        .dark .border-gray-300 {
            border-color: #4B5563 !important;
        }
        
        .dark th {
            background-color: #1E3A8A !important;
        }
        
        .dark tr:nth-child(even) {
            background-color: #374151 !important;
        }
        
        .dark tr:nth-child(odd) {
            background-color: #1F2937 !important;
        }
        
        .dark input, .dark select, .dark textarea {
            background-color: #374151 !important;
            border-color: #4B5563 !important;
            color: #E5E7EB !important;
        }
        
        .dark .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.1) !important;
        }
        
        .table-container {
            overflow-x: auto;
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 2000px;
            table-layout: auto;
        }
        
        th, td {
            border: 1px solid #d1d5db;
            padding: 8px;
            text-align: left;
            font-size: 12px;
            white-space: nowrap;
        }
        
        @media (max-width: 768px) {
            th, td {
                padding: 6px;
                font-size: 10px;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 12px;
                margin: 2px;
            }
            
            .container {
                padding: 4px;
            }
        }
        
        th {
            background-color: #2459a0;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        tr:nth-child(odd) {
            background-color: white;
        }
        
        /* Onay durumu renkleri - sadece arka plan */
        .status-beklemede {
            background-color: #fef3c7 !important; /* bg-yellow-100 */
            transition: all 300ms ease;
        }
        
        .status-onaylandi {
            background-color: #dcfce7 !important; /* bg-green-100 */
            transition: all 300ms ease;
        }
        
        .status-red-edildi {
            background-color: #fee2e2 !important; /* bg-red-100 */
            transition: all 300ms ease;
        }
        
        .status-odeme-bekliyor {
            background-color: #dbeafe !important; /* bg-blue-100 */
            transition: all 300ms ease;
        }
        
        /* DiÄŸer durumlar iÃ§in varsayÄ±lan */
        .status-onay-bekliyor {
            background-color: #fef3c7 !important; /* bg-yellow-100 */
            transition: all 300ms ease;
        }
        
        .status-tamamlandi {
            background-color: #dcfce7 !important; /* bg-green-100 */
            transition: all 300ms ease;
        }
        
        input[type="text"], input[type="number"], input[type="date"], select {
            width: 100%;
            padding: 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 11px;
        }
        
        .total-row {
            background-color: #f3f4f6 !important;
            font-weight: bold;
        }
        
        .grand-total-row {
            background-color: #2459a0 !important;
            color: white !important;
            font-weight: bold;
        }
        
        .selected-row {
            background-color: #dbeafe !important;
        }
        
        .btn {
            padding: 8px 16px;
            margin: 4px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: #2459a0;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1e40af;
        }
        
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        .btn-danger {
            background-color: #dc2626;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        
        .btn-success {
            background-color: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #047857;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }
        
        .notification.success {
            background-color: #10b981;
        }
        
        .notification.error {
            background-color: #dc2626;
        }
        
        .notification.info {
            background-color: #3b82f6;
        }
        
        /* Teslimat Durumu Renkleri */
        .delivery-status-beklemede {
            background-color: #FACC15 !important; /* Turuncu */
            color: #92400E !important; /* Koyu turuncu yazÄ± */
            font-weight: bold !important;
            text-align: center !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
        }
        
        .delivery-status-tamamlandi {
            background-color: #22C55E !important; /* YeÅŸil */
            color: white !important;
            font-weight: bold !important;
            text-align: center !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
        }
        
        .delivery-status-belirlenmedi {
            background-color: #9CA3AF !important; /* Gri */
            color: white !important;
            font-weight: bold !important;
            text-align: center !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
        }
        
        /* Readonly alanlar iÃ§in stil */
        .readonly-field {
            background-color: #f3f4f6 !important;
            color: #6b7280 !important;
            cursor: not-allowed !important;
        }
        
        /* SÄ±ralama stilleri */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .sortable:hover {
            background-color: #1e40af !important;
        }
        
        .sort-icon {
            font-size: 10px;
            margin-left: 4px;
            color: #d1d5db;
        }
        
        .sortable.sort-asc .sort-icon {
            color: #fbbf24;
        }
        
        .sortable.sort-desc .sort-icon {
            color: #fbbf24;
        }
        
        .sortable.sort-asc .sort-icon::before {
            content: "â–²";
        }
        
        .sortable.sort-desc .sort-icon::before {
            content: "â–¼";
        }
        
        .sortable.sort-asc .sort-icon,
        .sortable.sort-desc .sort-icon {
            font-weight: bold;
        }
        
        /* Arama ve filtre stilleri */
        #searchInput:focus,
        #filterSelect:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .no-results {
            background-color: #f3f4f6;
            color: #6b7280;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        /* Talep eden dolu satÄ±rlar iÃ§in hafif gri arka plan */
        .talep-eden-filled {
            background-color: #F9FAFB !important;
        }
        
        .talep-eden-filled:nth-child(even) {
            background-color: #F3F4F6 !important;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="bg-gray-100 min-h-full">
  <div class="container mx-auto p-6 bg-white shadow-lg rounded-lg my-4">
   <header class="mb-6 bg-white">
    <div class="flex flex-col items-center justify-center"><!-- Logo BÃ¶lÃ¼mÃ¼ -->
     <div class="flex flex-col items-center mb-2"><a href="https://www.somtech.ru/" target="_blank" rel="noopener noreferrer" class="block mb-2"> <img src="https://raw.githubusercontent.com/okarsli/deneme/main/%C5%9Eeffaf%20Logo.png" alt="SOMTECH RU Logo" class="w-32 h-auto object-contain hover:opacity-80 transition-opacity cursor-pointer" style="width: 130px;" onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='block';"> </a>
      <div id="logo-fallback" class="hidden mb-2"><a href="https://www.somtech.ru/" target="_blank" rel="noopener noreferrer" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 transition-colors"> SOMTECH RU </a>
      </div>
      <p class="text-center" style="font-size: 14px; font-family: 'Calibri', sans-serif; color: #6b7280;">SatÄ±n Alma YÃ¶netim Sistemi</p>
     </div><!-- AyraÃ§ Ã‡izgi -->
     <div class="w-full h-px bg-gray-300 mt-4 mb-2" style="background-color: #d1d5db;"></div><!-- Bildirim AlanÄ± -->
     <div id="notification-area" class="w-full mt-2 mb-2"></div><!-- Ãœst Kontrol Paneli -->
     <div class="flex justify-between items-center mt-2"><!-- Sol taraf - Rol SeÃ§ici -->
      <div class="flex items-center gap-2"><label for="roleSelector" class="text-sm font-medium text-gray-600 dark:text-gray-300">KullanÄ±cÄ± RolÃ¼:</label> <select id="roleSelector" class="border border-gray-300 dark:border-gray-600 rounded-lg p-2 text-sm bg-white dark:bg-gray-700 dark:text-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="setRole(this.value)"> <option value="VIEWER">ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼leyici</option> <option value="EDITOR">âœï¸ DÃ¼zenleyici</option> <option value="ADMIN">ğŸ§‘â€ğŸ’¼ YÃ¶netici</option> </select>
      </div><!-- SaÄŸ taraf - Ayarlar Butonu -->
      <div class="flex items-center gap-2"><button id="settingsBtn" class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg px-3 py-2 text-sm font-medium shadow-sm transition-colors flex items-center gap-1"> âš™ï¸ Ayarlar </button>
      </div>
     </div>
    </div>
   </header><!-- Arama ve Filtreleme Sistemi -->
   <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
    <div class="flex flex-col md:flex-row gap-4 items-center justify-center"><!-- Arama Ã‡ubuÄŸu -->
     <div class="w-full md:w-1/2"><input type="text" id="searchInput" placeholder="ğŸ” Form numarasÄ±, malzeme, talep eden veya proje adÄ±na gÃ¶re ara..." class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
     </div><!-- Filtreleme MenÃ¼sÃ¼ -->
     <div class="flex gap-2"><select id="filterSelect" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"> <option value="TÃ¼mÃ¼">TÃ¼mÃ¼</option> <option value="SARF">SARF</option> <option value="DEMÄ°RBAÅ">DEMÄ°RBAÅ</option> <option value="BEKLEMEDE">BEKLEMEDE</option> <option value="ONAYLANDI">ONAYLANDI</option> <option value="RED EDÄ°LDÄ°">RED EDÄ°LDÄ°</option> <option value="TAMAMLANDI">TAMAMLANDI</option> </select> <!-- Temizle Butonu --> <button id="clearFiltersBtn" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg shadow-sm transition-colors"> ğŸ—‘ï¸ Temizle </button>
     </div>
    </div><!-- SonuÃ§ Bilgisi -->
    <div id="searchResults" class="text-center mt-2 text-sm text-gray-600"></div>
   </div><!-- Toplu Ä°ÅŸlem Sistemi -->
   <div class="mb-6 bg-blue-50 p-4 rounded-lg shadow-sm"><!-- SeÃ§im Bilgisi -->
    <div id="selectionInfo" class="text-center mb-3 text-sm text-blue-700 font-medium hidden"><span id="selectedCount">0</span> satÄ±r seÃ§ildi
    </div><!-- Toplu Ä°ÅŸlem ButonlarÄ± -->
    <div class="flex flex-wrap gap-2 justify-center"><button id="bulkEditBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg px-4 py-2 font-semibold shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled> âœï¸ Toplu DÃ¼zenle </button> <button id="bulkDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white rounded-lg px-4 py-2 font-semibold shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled> ğŸ—‘ï¸ Toplu Sil </button> <button id="bulkApproveBtn" class="bg-green-600 hover:bg-green-700 text-white rounded-lg px-4 py-2 font-semibold shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled> âœ… Toplu Onayla </button> <button id="selectAllBtn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2 font-semibold shadow-sm transition-colors"> ğŸ“‹ TÃ¼mÃ¼nÃ¼ SeÃ§ </button> <button id="deselectAllBtn" class="bg-gray-500 hover:bg-gray-600 text-white rounded-lg px-4 py-2 font-semibold shadow-sm transition-colors"> âŒ SeÃ§imi Temizle </button>
    </div>
   </div>
   <div class="mb-6 flex flex-wrap gap-2 justify-center"><button id="yeni-talep-btn" class="btn btn-primary"> ğŸ“ Yeni Talep BaÅŸlat </button> <button id="alt-satir-btn" class="btn btn-secondary"> â• Alt SatÄ±r Ekle </button> <button id="satir-sil-btn" class="btn btn-danger"> ğŸ—‘ï¸ SatÄ±r Sil </button> <button id="pdf-btn" class="btn btn-success"> ğŸ“„ PDF Ä°ndir </button> <button id="kaydet-btn" class="btn btn-success"> ğŸ“Š CSV Ä°ndir </button> <button id="export-csv-btn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2 font-semibold shadow-sm w-full md:w-auto transition-colors"> ğŸ“¦ Verileri DÄ±ÅŸa Aktar </button> <button id="excel-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg px-4 py-2 shadow-md w-full md:w-auto transition-colors"> ğŸ“Š Excel Olarak DÄ±ÅŸa Aktar </button>
   </div><!-- Toplam Bilgi Paneli -->
   <div class="mb-8">
    <div class="text-center mb-6">
     <h2 class="text-xl font-bold text-gray-800 mb-2">ğŸ“Š Toplam Bilgi Paneli</h2>
     <div class="w-32 h-px bg-gray-300 mx-auto"></div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-6xl mx-auto"><!-- SARF TOPLAMI KartÄ± -->
     <div class="bg-gray-100 hover:bg-gray-200 rounded-xl shadow-md p-6 text-center transition-all duration-300 max-h-[110px] flex flex-col justify-between">
      <div class="flex items-center justify-start mb-2"><span class="text-xl mr-3">ğŸ’¼</span>
       <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide">SARF TOPLAMI</h3>
      </div>
      <div class="text-2xl font-bold text-gray-800 mb-1" id="sarf-toplam-panel">
       â‚½ 0,00
      </div>
      <div class="text-xs text-gray-500 font-medium">
       â‚½ RUB
      </div>
     </div><!-- DEMÄ°RBAÅ TOPLAMI KartÄ± -->
     <div class="bg-red-50 hover:bg-red-100 rounded-xl shadow-md p-6 text-center transition-all duration-300 max-h-[110px] flex flex-col justify-between">
      <div class="flex items-center justify-start mb-2"><span class="text-xl mr-3">ğŸ§±</span>
       <h3 class="text-sm font-bold text-red-700 uppercase tracking-wide">DEMÄ°RBAÅ TOPLAMI</h3>
      </div>
      <div class="text-2xl font-bold text-red-800 mb-1" id="demirbas-toplam-panel">
       â‚½ 0,00
      </div>
      <div class="text-xs text-red-500 font-medium">
       â‚½ RUB
      </div>
     </div><!-- GENEL TOPLAM KartÄ± -->
     <div class="bg-cyan-50 hover:bg-cyan-100 rounded-xl shadow-md p-6 text-center transition-all duration-300 max-h-[110px] flex flex-col justify-between">
      <div class="flex items-center justify-start mb-2"><span class="text-xl mr-3">ğŸ’°</span>
       <h3 class="text-sm font-bold text-cyan-700 uppercase tracking-wide">GENEL TOPLAM</h3>
      </div>
      <div class="text-2xl font-bold text-cyan-800 mb-1" id="genel-toplam-panel">
       â‚½ 0,00
      </div>
      <div class="text-xs text-cyan-500 font-medium">
       â‚½ RUB
      </div>
     </div>
    </div>
   </div>
   <div id="loading-indicator" class="hidden text-center py-4">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
    <p class="mt-2 text-gray-600">Ä°ÅŸlem yapÄ±lÄ±yor...</p>
   </div>
   <div class="table-container">
    <table id="sof-table">
     <thead>
      <tr>
       <th><input type="checkbox" id="selectAllCheckbox" class="w-4 h-4"></th>
       <th class="sortable" data-column="sira_no" data-type="number">SIRA NO <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="sof_form_no" data-type="text">SOF FORM NO <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="malzeme_tipi" data-type="text">MALZEME TÄ°PÄ° <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="talep_eden" data-type="text">TALEP EDEN <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="talep_tarihi" data-type="text">TALEP TARÄ°HÄ° <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="istenen_teslim_tarihi" data-type="text">Ä°STENEN TESLÄ°M TARÄ°HÄ° <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="teslimat_durumu" data-type="text">TESLÄ°MAT DURUMU <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="talep_edilen_malzeme" data-type="text">TALEP EDÄ°LEN MALZEME <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="detay_1" data-type="text">DETAY 1 (MARKA, MODEL VB) <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="detay_2" data-type="text">DETAY 2 (PROJE, STANDART VB KODLAR) <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="birim" data-type="text">BÄ°RÄ°M <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="talep_miktari" data-type="number">TALEP MÄ°KTARI <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="siparis_miktari" data-type="number">SÄ°PARÄ°Å MÄ°KTARI <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="birim_fiyat" data-type="number">BÄ°RÄ°M FÄ°YAT (â‚½ RUB) <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="toplam_fiyat" data-type="number">TOPLAM FÄ°YAT (â‚½ RUB) <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="tedarikci" data-type="text">TEDARÄ°KÃ‡Ä° <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="satinalma_sorumlusu" data-type="text">SATINALMA SORUMLUSU <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="planlanan_teslim_tarihi" data-type="text">PLANLANAN TESLÄ°M TARÄ°HÄ° <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="teslimat_miktari" data-type="number">TESLÄ°MAT MÄ°KTARI <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="teslimat_tarihi" data-type="text">TESLÄ°MAT TARÄ°HÄ° <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="kalan_miktar" data-type="number">KALAN MÄ°KTAR <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="onay_durumu" data-type="text">ONAY DURUMU <span class="sort-icon">â‡…</span></th>
       <th class="sortable" data-column="aciklama" data-type="text">AÃ‡IKLAMA <span class="sort-icon">â‡…</span></th>
      </tr>
     </thead>
     <tbody id="table-body">
     </tbody>
    </table>
   </div><!-- Teslimat Durumu Bilgi Paneli -->
   <div class="mt-6 bg-blue-50 rounded-lg shadow-sm p-4">
    <div class="text-center">
     <h3 class="text-lg font-bold text-blue-700 mb-3">ğŸ“‹ Teslimat Durumu GÃ¶stergesi</h3>
     <div class="flex justify-center items-center gap-6 text-sm">
      <div class="flex items-center gap-2"><span class="w-4 h-4 bg-green-500 rounded-full inline-block"></span> <span class="font-medium text-gray-700">ğŸŸ¢ TamamlandÄ±</span>
      </div>
      <div class="flex items-center gap-2"><span class="w-4 h-4 bg-yellow-400 rounded-full inline-block"></span> <span class="font-medium text-gray-700">ğŸŸ¡ Beklemede</span>
      </div>
      <div class="flex items-center gap-2"><span class="w-4 h-4 bg-gray-400 rounded-full inline-block"></span> <span class="font-medium text-gray-700">âšª Belirlenmedi</span>
      </div>
     </div>
     <div class="mt-3 text-xs text-gray-600">
      Teslimat durumlarÄ± teslimat tarihine gÃ¶re otomatik hesaplanÄ±r
     </div>
    </div>
   </div><!-- Raporlar ve Ä°statistikler Paneli -->
   <div class="mt-8 bg-gray-50 rounded-xl shadow-md p-4">
    <div class="text-center mb-6">
     <h2 class="text-xl font-bold text-gray-700 mb-2">ğŸ“ˆ Raporlar ve Ä°statistikler</h2>
     <div class="w-32 h-px bg-gray-300 mx-auto"></div>
    </div><!-- Grafik AlanlarÄ± -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4"><!-- Malzeme Tipi DaÄŸÄ±lÄ±mÄ± -->
     <div class="bg-white rounded-lg shadow-sm p-4">
      <h3 class="text-lg font-bold text-gray-700 text-center mb-4">ğŸ“Š Malzeme Tipi DaÄŸÄ±lÄ±mÄ± (%)</h3>
      <div class="relative h-64">
       <canvas id="materialTypeChart"></canvas>
      </div>
     </div><!-- Talep Durumu DaÄŸÄ±lÄ±mÄ± -->
     <div class="bg-white rounded-lg shadow-sm p-4">
      <h3 class="text-lg font-bold text-gray-700 text-center mb-4">âœ… Talep Durumu DaÄŸÄ±lÄ±mÄ±</h3>
      <div class="relative h-64">
       <canvas id="statusChart"></canvas>
      </div>
     </div><!-- AylÄ±k Toplam Harcama -->
     <div class="bg-white rounded-lg shadow-sm p-4 lg:col-span-2">
      <h3 class="text-lg font-bold text-gray-700 text-center mb-4">ğŸ“ˆ AylÄ±k Toplam Harcama (â‚½ RUB)</h3>
      <div class="relative h-80">
       <canvas id="monthlyExpenseChart"></canvas>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Toplu DÃ¼zenleme Modal -->
  <div id="bulkEditModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
   <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-gray-800">âœï¸ Toplu DÃ¼zenleme</h2><button id="closeBulkEditModal" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
     </div>
     <div class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><!-- Malzeme Tipi -->
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Malzeme Tipi</label> <select id="bulkMalzemeTipi" class="w-full p-2 border border-gray-300 rounded-lg"> <option value="">DeÄŸiÅŸtirme</option> <option value="SARF">SARF</option> <option value="DEMÄ°RBAÅ">DEMÄ°RBAÅ</option> </select>
       </div><!-- Birim -->
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Birim</label> <select id="bulkBirim" class="w-full p-2 border border-gray-300 rounded-lg"> <option value="">DeÄŸiÅŸtirme</option> <option value="ADET">ADET</option> <option value="KG">KG</option> <option value="LT">LT</option> <option value="METRE">METRE</option> <option value="M2">M2</option> <option value="M3">M3</option> <option value="SET">SET</option> <option value="PAKET">PAKET</option> <option value="KUTU">KUTU</option> </select>
       </div><!-- Birim Fiyat -->
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Birim Fiyat (â‚½ RUB)</label> <input type="number" step="0.01" id="bulkBirimFiyat" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Yeni fiyat girin">
       </div><!-- Onay Durumu -->
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Onay Durumu</label> <select id="bulkOnayDurumu" class="w-full p-2 border border-gray-300 rounded-lg"> <option value="">DeÄŸiÅŸtirme</option> <option value="BEKLEMEDE">BEKLEMEDE</option> <option value="ONAY BEKLÄ°YOR">ONAY BEKLÄ°YOR</option> <option value="ONAYLANDI">ONAYLANDI</option> <option value="Ã–DEME BEKLÄ°YOR">Ã–DEME BEKLÄ°YOR</option> <option value="TAMAMLANDI">TAMAMLANDI</option> <option value="RED EDÄ°LDÄ°">RED EDÄ°LDÄ°</option> </select>
       </div><!-- TedarikÃ§i -->
       <div><label class="block text-sm font-medium text-gray-700 mb-1">TedarikÃ§i</label> <input type="text" id="bulkTedarikci" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="TedarikÃ§i adÄ±">
       </div><!-- SatÄ±nalma Sorumlusu -->
       <div><label class="block text-sm font-medium text-gray-700 mb-1">SatÄ±nalma Sorumlusu</label> <input type="text" id="bulkSatinalma" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Sorumlu kiÅŸi">
       </div><!-- Planlanan Teslim Tarihi -->
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Planlanan Teslim Tarihi</label> <input type="text" id="bulkPlanTeslim" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="DD.MM.YY">
       </div><!-- Teslimat Tarihi -->
       <div><label class="block text-sm font-medium text-gray-700 mb-1">Teslimat Tarihi</label> <input type="text" id="bulkTeslimatTarihi" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="DD.MM.YY">
       </div>
      </div><!-- AÃ§Ä±klama -->
      <div><label class="block text-sm font-medium text-gray-700 mb-1">AÃ§Ä±klama</label> <textarea id="bulkAciklama" class="w-full p-2 border border-gray-300 rounded-lg" rows="3" placeholder="AÃ§Ä±klama ekleyin"></textarea>
      </div>
     </div>
     <div class="flex justify-end gap-3 mt-6"><button id="cancelBulkEdit" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg font-medium transition-colors"> Ä°ptal </button> <button id="applyBulkEdit" class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-medium transition-colors"> DeÄŸiÅŸiklikleri Uygula </button>
     </div>
    </div>
   </div>
  </div><!-- Ayarlar Modal -->
  <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
   <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md mx-auto">
    <div class="p-6">
     <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-bold text-gray-800 dark:text-white">âš™ï¸ Sistem AyarlarÄ±</h2><button id="closeSettingsModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl transition-colors">Ã—</button>
     </div>
     <div class="space-y-4"><!-- Form NumarasÄ± SÄ±fÄ±rlama -->
      <div class="border-b border-gray-200 dark:border-gray-600 pb-4">
       <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ğŸ“„ Form NumarasÄ± YÃ¶netimi</h3><button id="resetFormNumberBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg px-4 py-2 font-medium transition-colors"> Form NumarasÄ±nÄ± SÄ±fÄ±rla </button>
       <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Sadece yÃ¶neticiler kullanabilir</p>
      </div><!-- Veri YÃ¶netimi -->
      <div class="border-b border-gray-200 dark:border-gray-600 pb-4">
       <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ğŸ’¾ Veri YÃ¶netimi</h3>
       <div class="space-y-2"><button id="settingsExportBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white rounded-lg px-4 py-2 font-medium transition-colors"> Verileri DÄ±ÅŸa Aktar (CSV) </button>
       </div>
      </div><!-- Rol SeÃ§imi -->
      <div class="border-b border-gray-200 dark:border-gray-600 pb-4">
       <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ğŸ” KullanÄ±cÄ± RolÃ¼</h3><select id="settingsRoleSelector" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg p-2 text-sm bg-white dark:bg-gray-700 dark:text-white"> <option value="VIEWER">ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼leyici</option> <option value="EDITOR">âœï¸ DÃ¼zenleyici</option> <option value="ADMIN">ğŸ§‘â€ğŸ’¼ YÃ¶netici</option> </select>
      </div><!-- Dark Mode -->
      <div class="pb-4">
       <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ğŸŒ™ GÃ¶rÃ¼nÃ¼m</h3>
       <div class="flex items-center justify-between"><span class="text-sm text-gray-600 dark:text-gray-400">KaranlÄ±k Mod</span> <label class="relative inline-flex items-center cursor-pointer"> <input type="checkbox" id="darkModeToggle" class="sr-only peer">
         <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div></label>
       </div>
      </div>
     </div>
     <div class="flex justify-end gap-3 mt-6"><button id="cancelSettings" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-300 rounded-lg font-medium transition-colors"> Ä°ptal </button> <button id="saveSettings" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors"> âœ… Kaydet </button>
     </div>
    </div>
   </div>
  </div><!-- Onay Modal -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
   <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-md">
    <div class="p-6">
     <div class="text-center">
      <div class="text-4xl mb-4">
       âš ï¸
      </div>
      <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2" id="confirmTitle">Onay Gerekli</h3>
      <p class="text-gray-600 dark:text-gray-300 mb-6" id="confirmMessage">Bu iÅŸlemi gerÃ§ekleÅŸtirmek istediÄŸinizden emin misiniz?</p>
      <div class="flex justify-center gap-3"><button id="cancelConfirm" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-700 dark:text-gray-300 rounded-lg font-medium transition-colors"> Ä°ptal </button> <button id="confirmAction" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors"> Onayla </button>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        let currentData = [];
        let filteredData = [];
        let selectedRowIndex = -1;
        let nextSiraNo = 1;
        let nextFormNo = 1;
        let currentFormNo = '';
        let isLoading = false;
        let jsPDFLoaded = false;
        let calculateTotalTimeout = null;
        let currentSortColumn = '';
        let currentSortDirection = 'asc';
        let searchTerm = '';
        let filterValue = 'TÃ¼mÃ¼';
        let selectedRows = new Set();
        let confirmCallback = null;
        
        // Grafik deÄŸiÅŸkenleri
        let materialTypeChart = null;
        let statusChart = null;
        let monthlyExpenseChart = null;

        // KullanÄ±cÄ± yetki sistemi
        let userRole = localStorage.getItem("userRole") || "VIEWER";
        
        // Dark mode sistemi
        let darkModeEnabled = localStorage.getItem("darkModeEnabled") === "true";

        // Rol tanÄ±mlarÄ±
        const ROLES = {
            VIEWER: "VIEWER",
            EDITOR: "EDITOR", 
            ADMIN: "ADMIN"
        };

        // Rol yetkileri
        const PERMISSIONS = {
            [ROLES.VIEWER]: {
                canView: true,
                canEdit: false,
                canDelete: false,
                canAdd: false,
                canExport: true,
                canManageSystem: false,
                canApprove: false,
                canBulkEdit: false
            },
            [ROLES.EDITOR]: {
                canView: true,
                canEdit: true,
                canDelete: true,
                canAdd: true,
                canExport: true,
                canManageSystem: false,
                canApprove: false,
                canBulkEdit: true
            },
            [ROLES.ADMIN]: {
                canView: true,
                canEdit: true,
                canDelete: true,
                canAdd: true,
                canExport: true,
                canManageSystem: true,
                canApprove: true,
                canBulkEdit: true
            }
        };

        // Rol ayarlama fonksiyonu
        function setRole(role) {
            if (!ROLES[role]) {
                console.error('GeÃ§ersiz rol:', role);
                return;
            }
            
            userRole = role;
            localStorage.setItem("userRole", role);
            applyRolePermissions();
            
            // Rol deÄŸiÅŸikliÄŸi bildirimi
            const roleNames = {
                VIEWER: "ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼leyici",
                EDITOR: "âœï¸ DÃ¼zenleyici", 
                ADMIN: "ğŸ§‘â€ğŸ’¼ YÃ¶netici"
            };
            
            showNotification(`âœ… Rol baÅŸarÄ±yla deÄŸiÅŸtirildi: ${roleNames[role]}`, 'success');
        }

        // Dark mode fonksiyonlarÄ±
        function toggleDarkMode() {
            darkModeEnabled = !darkModeEnabled;
            localStorage.setItem("darkModeEnabled", darkModeEnabled.toString());
            applyDarkMode();
        }

        function applyDarkMode() {
            const body = document.body;
            const html = document.documentElement;
            
            if (darkModeEnabled) {
                body.classList.add('dark');
                html.classList.add('dark');
            } else {
                body.classList.remove('dark');
                html.classList.remove('dark');
            }
            
            // Dark mode toggle'Ä±nÄ± gÃ¼ncelle
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.checked = darkModeEnabled;
            }
        }

        // Ayarlar modal fonksiyonlarÄ±
        function openSettingsModal() {
            // Mevcut ayarlarÄ± modal'a yÃ¼kle
            document.getElementById('settingsRoleSelector').value = userRole;
            document.getElementById('darkModeToggle').checked = darkModeEnabled;
            
            // Form numarasÄ± sÄ±fÄ±rlama butonunu yetki kontrolÃ¼
            const resetBtn = document.getElementById('resetFormNumberBtn');
            if (resetBtn) {
                resetBtn.disabled = !hasPermission('canManageSystem');
                if (!hasPermission('canManageSystem')) {
                    resetBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    resetBtn.title = 'Bu iÅŸlem iÃ§in yÃ¶netici yetkisi gerekli';
                } else {
                    resetBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    resetBtn.title = '';
                }
            }
            
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function saveSettings() {
            // Rol deÄŸiÅŸikliÄŸi
            const newRole = document.getElementById('settingsRoleSelector').value;
            if (newRole !== userRole) {
                setRole(newRole);
                // Ana rol seÃ§iciyi de gÃ¼ncelle
                document.getElementById('roleSelector').value = newRole;
            }
            
            // Dark mode deÄŸiÅŸikliÄŸi
            const newDarkMode = document.getElementById('darkModeToggle').checked;
            if (newDarkMode !== darkModeEnabled) {
                darkModeEnabled = newDarkMode;
                localStorage.setItem("darkModeEnabled", darkModeEnabled.toString());
                applyDarkMode();
            }
            
            closeSettingsModal();
            showNotification('âœ… Ayarlar kaydedildi.', 'success');
        }

        // Form numarasÄ± sÄ±fÄ±rlama fonksiyonu
        function resetFormNumber() {
            if (!hasPermission('canManageSystem')) {
                showNotification('Bu iÅŸlem iÃ§in yÃ¶netici yetkisi gerekli.', 'error');
                return;
            }
            
            showConfirmModal(
                'Form NumarasÄ± SÄ±fÄ±rlama',
                'Form numarasÄ±nÄ± sÄ±fÄ±rlamak istiyor musunuz? Bu iÅŸlem geri alÄ±namaz.',
                () => {
                    nextFormNo = 1;
                    currentFormNo = '';
                    showNotification('âš ï¸ Form numarasÄ± sÄ±fÄ±rlandÄ±.', 'success');
                    closeSettingsModal();
                }
            );
        }

        // Yetki kontrolÃ¼ fonksiyonu
        function hasPermission(permission) {
            return PERMISSIONS[userRole] && PERMISSIONS[userRole][permission] === true;
        }

        // Rol yetkilerini uygulama fonksiyonu
        function applyRolePermissions() {
            const permissions = PERMISSIONS[userRole];
            
            // Buton yetkileri
            const buttons = {
                'yeni-talep-btn': permissions.canAdd,
                'alt-satir-btn': permissions.canAdd,
                'satir-sil-btn': permissions.canDelete,
                'pdf-btn': permissions.canExport,
                'kaydet-btn': permissions.canExport,
                'export-csv-btn': permissions.canExport,
                'excel-btn': permissions.canExport,

                'bulkEditBtn': permissions.canBulkEdit,
                'bulkDeleteBtn': permissions.canBulkEdit && permissions.canDelete,
                'bulkApproveBtn': permissions.canApprove,
                'selectAllBtn': permissions.canBulkEdit,
                'deselectAllBtn': permissions.canBulkEdit
            };
            
            // ButonlarÄ± etkinleÅŸtir/devre dÄ±ÅŸÄ± bÄ±rak
            Object.entries(buttons).forEach(([buttonId, allowed]) => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.disabled = !allowed;
                    if (!allowed) {
                        button.classList.add('opacity-50', 'cursor-not-allowed');
                        button.title = 'Bu iÅŸlem iÃ§in yetkiniz bulunmuyor';
                    } else {
                        button.classList.remove('opacity-50', 'cursor-not-allowed');
                        button.title = '';
                    }
                }
            });
            
            // Toplu iÅŸlem panelini gizle/gÃ¶ster
            const bulkPanel = document.querySelector('.bg-blue-50');
            if (bulkPanel) {
                if (permissions.canBulkEdit) {
                    bulkPanel.style.display = 'block';
                } else {
                    bulkPanel.style.display = 'none';
                }
            }
            
            // Tablo input alanlarÄ±nÄ± kontrol et
            applyTablePermissions();
            
            // Rol seÃ§icisini gÃ¼ncelle
            const roleSelector = document.getElementById('roleSelector');
            if (roleSelector) {
                roleSelector.value = userRole;
            }
        }

        // Tablo input yetkilerini uygulama
        function applyTablePermissions() {
            const permissions = PERMISSIONS[userRole];
            
            // TÃ¼m input, select ve textarea elementlerini kontrol et
            document.querySelectorAll('#table-body input, #table-body select, #table-body textarea').forEach(element => {
                if (!permissions.canEdit) {
                    element.disabled = true;
                    element.classList.add('readonly-field');
                } else {
                    // EDITOR rolÃ¼ iÃ§in sistem alanlarÄ±nÄ± kÄ±sÄ±tla
                    if (userRole === ROLES.EDITOR) {
                        const isSystemField = element.closest('td') && (
                            element.closest('tr').children[1] === element.closest('td') || // SIRA NO
                            element.closest('tr').children[2] === element.closest('td') || // SOF FORM NO
                            element.closest('tr').children[5] === element.closest('td') || // TALEP TARÄ°HÄ°
                            element.closest('tr').children[22] === element.closest('td')   // ONAY DURUMU
                        );
                        
                        if (isSystemField) {
                            element.disabled = true;
                            element.classList.add('readonly-field');
                            element.title = 'Bu alan sadece yÃ¶neticiler tarafÄ±ndan dÃ¼zenlenebilir';
                        } else {
                            element.disabled = false;
                            element.classList.remove('readonly-field');
                            element.title = '';
                        }
                    } else if (userRole === ROLES.ADMIN) {
                        // ADMIN iÃ§in tÃ¼m alanlar aÃ§Ä±k (CSV readonly kontrolÃ¼ hariÃ§)
                        if (!element.classList.contains('readonly-field') || element.dataset.csvReadonly !== 'true') {
                            element.disabled = false;
                        }
                    }
                }
            });
            
            // Checkbox'larÄ± kontrol et
            document.querySelectorAll('.row-checkbox, #selectAllCheckbox').forEach(checkbox => {
                if (!permissions.canBulkEdit) {
                    checkbox.disabled = true;
                    checkbox.style.opacity = '0.5';
                } else {
                    checkbox.disabled = false;
                    checkbox.style.opacity = '1';
                }
            });
        }

        // Debounce fonksiyonu - toplam hesaplamalarÄ±nÄ± optimize eder
        function debouncedCalculateTotal() {
            if (calculateTotalTimeout) {
                clearTimeout(calculateTotalTimeout);
            }
            calculateTotalTimeout = setTimeout(() => {
                calculateTotal();
            }, 300);
        }

        const dataHandler = {
            onDataChanged(data) {
                currentData = data.sort((a, b) => a.sira_no - b.sira_no);
                updateNextNumbers();
                applyFiltersAndSearch();
                calculateTotal();
                renderCharts();
                // LocalStorage'a otomatik kaydet
                saveToLocalStorage();
            }
        };

        // Grafik render fonksiyonu
        function renderCharts() {
            if (currentData.length === 0) {
                // Veri yoksa grafikleri temizle
                clearCharts();
                return;
            }
            
            renderMaterialTypeChart();
            renderStatusChart();
            renderMonthlyExpenseChart();
        }

        // Grafikleri temizleme fonksiyonu
        function clearCharts() {
            if (materialTypeChart) {
                materialTypeChart.destroy();
                materialTypeChart = null;
            }
            if (statusChart) {
                statusChart.destroy();
                statusChart = null;
            }
            if (monthlyExpenseChart) {
                monthlyExpenseChart.destroy();
                monthlyExpenseChart = null;
            }
        }

        // Malzeme Tipi DaÄŸÄ±lÄ±mÄ± GrafiÄŸi
        function renderMaterialTypeChart() {
            const ctx = document.getElementById('materialTypeChart');
            if (!ctx) return;

            // Mevcut grafiÄŸi yok et
            if (materialTypeChart) {
                materialTypeChart.destroy();
            }

            // Veri hazÄ±rlama
            const materialTypes = {};
            currentData.forEach(row => {
                const type = row.malzeme_tipi || 'TanÄ±msÄ±z';
                materialTypes[type] = (materialTypes[type] || 0) + 1;
            });

            const labels = Object.keys(materialTypes);
            const data = Object.values(materialTypes);
            const colors = {
                'SARF': '#3B82F6',
                'DEMÄ°RBAÅ': '#F97316',
                'TanÄ±msÄ±z': '#9CA3AF'
            };

            materialTypeChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: labels.map(label => colors[label] || '#9CA3AF'),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} adet (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Talep Durumu DaÄŸÄ±lÄ±mÄ± GrafiÄŸi
        function renderStatusChart() {
            const ctx = document.getElementById('statusChart');
            if (!ctx) return;

            // Mevcut grafiÄŸi yok et
            if (statusChart) {
                statusChart.destroy();
            }

            // Veri hazÄ±rlama
            const statuses = {};
            currentData.forEach(row => {
                const status = row.onay_durumu || 'TanÄ±msÄ±z';
                statuses[status] = (statuses[status] || 0) + 1;
            });

            const labels = Object.keys(statuses);
            const data = Object.values(statuses);
            const colors = {
                'BEKLEMEDE': '#FACC15',
                'ONAY BEKLÄ°YOR': '#FACC15',
                'ONAYLANDI': '#60A5FA',
                'Ã–DEME BEKLÄ°YOR': '#60A5FA',
                'TAMAMLANDI': '#34D399',
                'RED EDÄ°LDÄ°': '#F87171',
                'TanÄ±msÄ±z': '#9CA3AF'
            };

            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: labels.map(label => colors[label] || '#9CA3AF'),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '50%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} adet (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // AylÄ±k Toplam Harcama GrafiÄŸi
        function renderMonthlyExpenseChart() {
            const ctx = document.getElementById('monthlyExpenseChart');
            if (!ctx) return;

            // Mevcut grafiÄŸi yok et
            if (monthlyExpenseChart) {
                monthlyExpenseChart.destroy();
            }

            // Veri hazÄ±rlama - aylÄ±k gruplandÄ±rma
            const monthlyData = {};
            currentData.forEach(row => {
                if (row.talep_tarihi && row.toplam_fiyat) {
                    // Tarih formatÄ±: DD.MM.YY
                    const dateParts = row.talep_tarihi.split('.');
                    if (dateParts.length === 3) {
                        const month = dateParts[1];
                        const year = '20' + dateParts[2]; // YY -> YYYY
                        const monthKey = `${month}/${year}`;
                        
                        monthlyData[monthKey] = (monthlyData[monthKey] || 0) + row.toplam_fiyat;
                    }
                }
            });

            // AylarÄ± sÄ±rala
            const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split('/');
                const [monthB, yearB] = b.split('/');
                const dateA = new Date(parseInt(yearA), parseInt(monthA) - 1);
                const dateB = new Date(parseInt(yearB), parseInt(monthB) - 1);
                return dateA - dateB;
            });

            const labels = sortedMonths.map(month => {
                const [monthNum, year] = month.split('/');
                const monthNames = ['Oca', 'Åub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'AÄŸu', 'Eyl', 'Eki', 'Kas', 'Ara'];
                return `${monthNames[parseInt(monthNum) - 1]} ${year}`;
            });
            
            const data = sortedMonths.map(month => monthlyData[month]);

            monthlyExpenseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Toplam Harcama (â‚½ RUB)',
                        data: data,
                        backgroundColor: '#4CAF50',
                        borderColor: '#388E3C',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('tr-TR', {
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0
                                    }) + ' â‚½';
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Toplam: ${context.parsed.y.toLocaleString('tr-TR', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    })} â‚½`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ğŸš€ Ultra hÄ±zlÄ± arama ve filtreleme - optimized search
        function applyFiltersAndSearch() {
            let filtered = currentData;
            
            // HÄ±zlÄ± arama filtresi - sadece gerekli alanlarda ara
            if (searchTerm) {
                const searchLower = searchTerm.toLowerCase();
                filtered = filtered.filter(row => {
                    // Sadece Ã¶nemli alanlarda ara (performans iÃ§in)
                    return (
                        (row.sof_form_no && row.sof_form_no.toLowerCase().includes(searchLower)) ||
                        (row.talep_eden && row.talep_eden.toLowerCase().includes(searchLower)) ||
                        (row.talep_edilen_malzeme && row.talep_edilen_malzeme.toLowerCase().includes(searchLower)) ||
                        (row.tedarikci && row.tedarikci.toLowerCase().includes(searchLower)) ||
                        (row.detay_2 && row.detay_2.toLowerCase().includes(searchLower))
                    );
                });
            }
            
            // HÄ±zlÄ± kategori filtresi
            if (filterValue !== 'TÃ¼mÃ¼') {
                filtered = filtered.filter(row => {
                    return row.malzeme_tipi === filterValue || 
                           row.onay_durumu === filterValue ||
                           row.teslimat_durumu === filterValue;
                });
            }
            
            // HÄ±zlÄ± sÄ±ralama
            if (currentSortColumn) {
                filtered = sortDataFast(filtered, currentSortColumn, currentSortDirection);
            }
            
            filteredData = filtered;
            
            // Debounced render
            requestAnimationFrame(() => {
                renderTable();
                updateSearchResults();
            });
        }
        
        // ğŸš€ Ultra hÄ±zlÄ± sÄ±ralama - optimized sorting
        function sortDataFast(data, column, direction) {
            // SayÄ±sal sÃ¼tunlar iÃ§in hÄ±zlÄ± lookup
            const numericColumns = new Set(['sira_no', 'talep_miktari', 'siparis_miktari', 'birim_fiyat', 'toplam_fiyat', 'teslimat_miktari', 'kalan_miktar']);
            
            return data.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                if (numericColumns.has(column)) {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else {
                    aVal = (aVal || '').toString().toLowerCase();
                    bVal = (bVal || '').toString().toLowerCase();
                }
                
                const result = aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                return direction === 'asc' ? result : -result;
            });
        }

        function sortData(data, column, direction) {
            return data.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // SayÄ±sal sÃ¼tunlar iÃ§in
                const numericColumns = ['sira_no', 'talep_miktari', 'siparis_miktari', 'birim_fiyat', 'toplam_fiyat', 'teslimat_miktari', 'kalan_miktar'];
                if (numericColumns.includes(column)) {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else {
                    // Metin sÃ¼tunlarÄ± iÃ§in
                    aVal = (aVal || '').toString().toLowerCase();
                    bVal = (bVal || '').toString().toLowerCase();
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
        }

        function updateSearchResults() {
            const resultsDiv = document.getElementById('searchResults');
            const total = currentData.length;
            const filtered = filteredData.length;
            
            if (total === 0) {
                resultsDiv.textContent = '';
                return;
            }
            
            if (searchTerm || filterValue !== 'TÃ¼mÃ¼') {
                resultsDiv.textContent = `${filtered} / ${total} kayÄ±t gÃ¶steriliyor`;
                resultsDiv.className = 'text-center mt-2 text-sm text-blue-600 font-medium';
            } else {
                resultsDiv.textContent = `Toplam ${total} kayÄ±t`;
                resultsDiv.className = 'text-center mt-2 text-sm text-gray-600';
            }
        }

        function clearFilters() {
            searchTerm = '';
            filterValue = 'TÃ¼mÃ¼';
            currentSortColumn = '';
            currentSortDirection = 'asc';
            
            document.getElementById('searchInput').value = '';
            document.getElementById('filterSelect').value = 'TÃ¼mÃ¼';
            
            // SÄ±ralama ikonlarÄ±nÄ± sÄ±fÄ±rla
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                const icon = th.querySelector('.sort-icon');
                if (icon) {
                    icon.textContent = 'â‡…';
                }
            });
            
            applyFiltersAndSearch();
        }

        // 2025 yÄ±lÄ± iÃ§in Ã¶zel localStorage anahtarlarÄ±
        const STORAGE_KEY = 'sofData_2025';
        const BACKUP_KEY = 'sofGlobalBackup';
        const LOADED_FLAG = 'sofDataLoaded_2025';

        // LocalStorage kaydetme fonksiyonu
        function saveToLocalStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(currentData));
                console.log('Veriler localStorage\'a kaydedildi (sofData_2025)');
            } catch (error) {
                console.error('LocalStorage kaydetme hatasÄ±:', error);
            }
        }

        // LocalStorage'dan veri yÃ¼kleme fonksiyonu
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        console.log(`LocalStorage'dan ${parsedData.length} kayÄ±t yÃ¼klendi (sofData_2025)`);
                        return parsedData;
                    }
                }
                console.log('LocalStorage boÅŸ veya geÃ§ersiz (sofData_2025)');
                return null;
            } catch (error) {
                console.error('LocalStorage okuma hatasÄ±:', error);
                return null;
            }
        }

        // Yedek veri yÃ¼kleme fonksiyonu
        function loadBackupData() {
            try {
                const backupData = localStorage.getItem(BACKUP_KEY);
                if (backupData) {
                    const parsedData = JSON.parse(backupData);
                    if (Array.isArray(parsedData) && parsedData.length > 0) {
                        return parsedData;
                    }
                }
                return null;
            } catch (error) {
                console.error('Yedek veri okuma hatasÄ±:', error);
                return null;
            }
        }

        // Yerel veriyi temizleme fonksiyonu
        function clearLocalStorage() {
            if (!hasPermission('canManageSystem')) {
                showNotification('Bu iÅŸlem iÃ§in yetkiniz bulunmuyor.', 'error');
                return;
            }
            
            showConfirmModal(
                'Yerel Veri Temizleme',
                'Yerel veriler (sofData_2025) tamamen silinecek. Bu iÅŸlem geri alÄ±namaz. Emin misiniz?',
                () => {
                    try {
                        localStorage.removeItem(STORAGE_KEY);
                        localStorage.removeItem(BACKUP_KEY);
                        localStorage.removeItem(LOADED_FLAG);
                        showNotification('ğŸ§¹ Yerel veriler temizlendi. Sayfa yenileniyor...', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } catch (error) {
                        console.error('LocalStorage temizleme hatasÄ±:', error);
                        showNotification('Yerel veriler temizlenirken hata oluÅŸtu.', 'error');
                    }
                }
            );
        }

        function updateNextNumbers() {
            if (currentData.length > 0) {
                nextSiraNo = Math.max(...currentData.map(item => item.sira_no)) + 1;
                const formNumbers = currentData.map(item => {
                    // Yeni format: RF100.SOFS-0001 veya RF100.SOFD-0001
                    const match = item.sof_form_no.match(/RF100\.SOF[SD]-(\d+)/);
                    return match ? parseInt(match[1]) : 0;
                });
                nextFormNo = Math.max(...formNumbers, 0) + 1;
            }
        }

        function showLoading() {
            isLoading = true;
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.querySelectorAll('.btn').forEach(btn => btn.disabled = true);
        }

        function hideLoading() {
            isLoading = false;
            document.getElementById('loading-indicator').classList.add('hidden');
            document.querySelectorAll('.btn').forEach(btn => btn.disabled = false);
        }

        // Tarih formatÄ± fonksiyonu - DD.MM.YY
        function getFormattedDate(offsetDays = 0) {
            const d = new Date();
            d.setDate(d.getDate() + offsetDays);
            const day = String(d.getDate()).padStart(2, "0");
            const month = String(d.getMonth() + 1).padStart(2, "0");
            const year = String(d.getFullYear()).slice(-2);
            return `${day}.${month}.${year}`;
        }

        // Form numarasÄ± otomatik oluÅŸturma
        function generateFormNumber(index, malzemeTipi) {
            const tipKodu = malzemeTipi === "SARF" ? "S" : "D";
            const formNo = String(index).padStart(4, "0");
            return `RF100.SOF${tipKodu}-${formNo}`;
        }

        function createNewRow(formNo = null, malzemeTipi = 'SARF', useExistingDates = false, existingTalepTarihi = '', existingTeslimTarihi = '') {
            let talepTarihi, istenenTeslimTarihi;
            
            if (useExistingDates) {
                // Alt satÄ±r ekleme - mevcut tarihleri kullan
                talepTarihi = existingTalepTarihi;
                istenenTeslimTarihi = existingTeslimTarihi;
            } else {
                // Yeni talep - bugÃ¼n + 7 gÃ¼n
                talepTarihi = getFormattedDate(0); // BugÃ¼n
                istenenTeslimTarihi = getFormattedDate(7); // 7 gÃ¼n sonra
            }
            
            if (!formNo) {
                currentFormNo = generateFormNumber(nextFormNo, malzemeTipi);
            } else {
                currentFormNo = formNo;
            }

            const newRow = {
                sira_no: nextSiraNo++,
                sof_form_no: currentFormNo,
                malzeme_tipi: malzemeTipi,
                talep_eden: '',
                talep_tarihi: talepTarihi,
                istenen_teslim_tarihi: istenenTeslimTarihi,
                teslimat_durumu: 'BELÄ°RLENMEDÄ°', // BaÅŸlangÄ±Ã§ta belirlenmedi
                talep_edilen_malzeme: '',
                detay_1: '',
                detay_2: '',
                birim: 'ADET',
                talep_miktari: 0,
                siparis_miktari: 0,
                birim_fiyat: 0,
                toplam_fiyat: 0,
                tedarikci: '',
                satinalma_sorumlusu: '',
                planlanan_teslim_tarihi: '',
                teslimat_miktari: 0,
                teslimat_tarihi: '',
                kalan_miktar: 0,
                onay_durumu: 'BEKLEMEDE',
                aciklama: '',
                is_from_csv: false
            };
            
            // Teslimat durumunu hesapla
            updateDeliveryStatus(newRow);
            
            return newRow;
        }

        // Teslimat durumu gÃ¼ncelleme fonksiyonu - teslimat tarihine gÃ¶re
        function updateDeliveryStatus(row) {
            const teslimatTarihi = row.teslimat_tarihi;
            
            // Teslimat tarihi boÅŸsa
            if (!teslimatTarihi || teslimatTarihi.trim() === '') {
                row.teslimat_durumu = 'BELÄ°RLENMEDÄ°';
                return;
            }
            
            // Tarih formatÄ±nÄ± kontrol et (DD.MM.YY)
            const datePattern = /^(\d{1,2})\.(\d{1,2})\.(\d{2})$/;
            const match = teslimatTarihi.match(datePattern);
            
            if (!match) {
                row.teslimat_durumu = 'BELÄ°RLENMEDÄ°';
                return;
            }
            
            // Tarihi parse et
            const day = parseInt(match[1]);
            const month = parseInt(match[2]) - 1; // JavaScript aylarÄ± 0-11
            const year = parseInt('20' + match[3]); // YY -> YYYY
            
            const teslimatDate = new Date(year, month, day);
            const today = new Date();
            
            // Sadece tarihi karÅŸÄ±laÅŸtÄ±r (saat bilgisini sÄ±fÄ±rla)
            today.setHours(0, 0, 0, 0);
            teslimatDate.setHours(0, 0, 0, 0);
            
            // Tarih karÅŸÄ±laÅŸtÄ±rmasÄ±
            if (teslimatDate <= today) {
                row.teslimat_durumu = 'TAMAMLANDI'; // BugÃ¼n veya Ã¶ncesi
            } else {
                row.teslimat_durumu = 'BEKLEMEDE'; // Gelecek tarih
            }
        }

        // Onay durumu gÃ¼ncelleme fonksiyonu
        function updateApprovalStatus(row) {
            if (row.teslimat_tarihi && row.teslimat_tarihi.trim() !== '') {
                row.onay_durumu = 'TAMAMLANDI';
            }
            // Teslimat tarihi boÅŸsa mevcut onay durumu korunur
        }

        // TÃ¼m verilerin onay durumunu kontrol et
        function updateAllApprovalStatuses() {
            currentData.forEach(row => {
                updateApprovalStatus(row);
                updateDeliveryStatus(row);
            });
        }

        // TÃ¼m teslimat durumlarÄ±nÄ± gÃ¼ncelle
        function updateAllDeliveryStatuses() {
            let updated = false;
            currentData.forEach(row => {
                const oldStatus = row.teslimat_durumu;
                updateDeliveryStatus(row);
                if (oldStatus !== row.teslimat_durumu) {
                    updated = true;
                }
            });
            
            if (updated) {
                renderTable();
                showNotification('ğŸ“… Teslimat durumlarÄ± gÃ¼ncellendi', 'success');
            }
        }

        // ğŸš€ JET HIZI TABLO OPTÄ°MÄ°ZASYONU - VIRTUAL SCROLLING + BATCH RENDERING
        
        // Virtual scrolling parametreleri
        const VIRTUAL_SCROLL = {
            ITEM_HEIGHT: 40, // Her satÄ±rÄ±n yÃ¼ksekliÄŸi (px)
            BUFFER_SIZE: 10, // GÃ¶rÃ¼nÃ¼r alanÄ±n dÄ±ÅŸÄ±nda render edilecek satÄ±r sayÄ±sÄ±
            CONTAINER_HEIGHT: 600, // Tablo container yÃ¼ksekliÄŸi
            VISIBLE_ITEMS: Math.ceil(600 / 40) + 20 // GÃ¶rÃ¼nÃ¼r satÄ±r sayÄ±sÄ± + buffer
        };
        
        let virtualScrollState = {
            scrollTop: 0,
            startIndex: 0,
            endIndex: VIRTUAL_SCROLL.VISIBLE_ITEMS,
            totalHeight: 0
        };
        
        // HÄ±zlÄ± DOM element cache
        const domCache = new Map();
        
        // Batch rendering iÃ§in queue
        let renderQueue = [];
        let isRendering = false;
        
        // ğŸš€ Ultra hÄ±zlÄ± satÄ±r oluÅŸturma - Template cloning
        function createTableRowFast(row, index) {
            // Template cache kontrolÃ¼
            let template = domCache.get('row-template');
            if (!template) {
                template = document.createElement('tr');
                template.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox w-4 h-4"></td>
                    <td class="sira-no"></td>
                    <td class="form-no"></td>
                    <td class="malzeme-select"></td>
                    <td><input type="text" class="talep-eden"></td>
                    <td><input type="text" class="talep-tarihi"></td>
                    <td><input type="text" class="istenen-teslim"></td>
                    <td><span class="teslimat-durumu"></span></td>
                    <td><input type="text" class="talep-malzeme"></td>
                    <td><input type="text" class="detay-1"></td>
                    <td><input type="text" class="detay-2"></td>
                    <td class="birim-select"></td>
                    <td><input type="number" class="talep-miktar"></td>
                    <td><input type="number" class="siparis-miktar"></td>
                    <td><input type="number" step="0.01" class="birim-fiyat"></td>
                    <td class="toplam-fiyat font-bold"></td>
                    <td><input type="text" class="tedarikci"></td>
                    <td><input type="text" class="satinalma"></td>
                    <td><input type="text" class="planlanan-teslim"></td>
                    <td><input type="number" class="teslimat-miktar"></td>
                    <td><input type="text" class="teslimat-tarihi"></td>
                    <td><input type="number" class="kalan-miktar"></td>
                    <td class="onay-select"></td>
                    <td><input type="text" class="aciklama"></td>
                `;
                domCache.set('row-template', template);
            }
            
            // Template'i clone et
            const tr = template.cloneNode(true);
            
            // HÄ±zlÄ± class assignment
            tr.className = getStatusClassFast(row.onay_durumu);
            if (row.talep_eden?.trim()) tr.classList.add('talep-eden-filled');
            tr.dataset.rowId = row.__backendId || index;
            
            // HÄ±zlÄ± veri doldurma - querySelector yerine direct access
            const cells = tr.children;
            
            // Checkbox
            const checkbox = cells[0].firstElementChild;
            checkbox.dataset.index = index;
            checkbox.onchange = () => toggleRowSelection(index);
            
            // SÄ±ra No
            cells[1].textContent = row.sira_no;
            
            // Form No
            cells[2].textContent = row.sof_form_no;
            cells[2].className = row.is_from_csv ? 'readonly-field' : '';
            
            // Malzeme Tipi Select
            cells[3].innerHTML = createSelectFast('malzeme_tipi', [
                {value: 'SARF', text: 'SARF'},
                {value: 'DEMÄ°RBAÅ', text: 'DEMÄ°RBAÅ'}
            ], row.malzeme_tipi, index, row.is_from_csv);
            
            // Input alanlarÄ± - batch update
            const inputs = [
                {cell: 4, field: 'talep_eden', value: row.talep_eden},
                {cell: 5, field: 'talep_tarihi', value: row.talep_tarihi, readonly: row.is_from_csv},
                {cell: 6, field: 'istenen_teslim_tarihi', value: row.istenen_teslim_tarihi, readonly: row.is_from_csv},
                {cell: 8, field: 'talep_edilen_malzeme', value: row.talep_edilen_malzeme},
                {cell: 9, field: 'detay_1', value: row.detay_1},
                {cell: 10, field: 'detay_2', value: row.detay_2},
                {cell: 12, field: 'talep_miktari', value: row.talep_miktari, type: 'number'},
                {cell: 13, field: 'siparis_miktari', value: row.siparis_miktari, type: 'number'},
                {cell: 14, field: 'birim_fiyat', value: row.birim_fiyat, type: 'number'},
                {cell: 16, field: 'tedarikci', value: row.tedarikci},
                {cell: 17, field: 'satinalma_sorumlusu', value: row.satinalma_sorumlusu},
                {cell: 18, field: 'planlanan_teslim_tarihi', value: row.planlanan_teslim_tarihi},
                {cell: 19, field: 'teslimat_miktari', value: row.teslimat_miktari, type: 'number'},
                {cell: 20, field: 'teslimat_tarihi', value: row.teslimat_tarihi, special: 'delivery'},
                {cell: 21, field: 'kalan_miktar', value: row.kalan_miktar, type: 'number'},
                {cell: 23, field: 'aciklama', value: row.aciklama}
            ];
            
            // Batch input update
            inputs.forEach(({cell, field, value, type, readonly, special}) => {
                const input = cells[cell].firstElementChild;
                input.value = value || '';
                if (readonly) {
                    input.className += ' readonly-field';
                    input.readOnly = true;
                }
                
                if (special === 'delivery') {
                    input.onchange = () => updateFieldWithDeliveryCheck(index, field, input.value);
                } else {
                    input.onchange = () => updateField(index, field, type === 'number' ? (parseFloat(input.value) || 0) : input.value);
                }
            });
            
            // Teslimat Durumu
            const deliverySpan = cells[7].firstElementChild;
            deliverySpan.textContent = row.teslimat_durumu;
            deliverySpan.className = getDeliveryStatusClassFast(row.teslimat_durumu);
            
            // Birim Select
            cells[11].innerHTML = createSelectFast('birim', [
                {value: 'ADET', text: 'ADET'}, {value: 'KG', text: 'KG'}, {value: 'LT', text: 'LT'},
                {value: 'METRE', text: 'METRE'}, {value: 'M2', text: 'M2'}, {value: 'M3', text: 'M3'},
                {value: 'SET', text: 'SET'}, {value: 'PAKET', text: 'PAKET'}, {value: 'KUTU', text: 'KUTU'}
            ], row.birim, index);
            
            // Toplam Fiyat
            cells[15].textContent = row.toplam_fiyat.toFixed(2);
            
            // Onay Durumu Select
            const approvalReadonly = row.teslimat_tarihi?.trim() ? 'readonly-field' : '';
            const approvalDisabled = row.teslimat_tarihi?.trim() ? true : false;
            cells[22].innerHTML = createSelectFast('onay_durumu', [
                {value: 'BEKLEMEDE', text: 'BEKLEMEDE'},
                {value: 'ONAY BEKLÄ°YOR', text: 'ONAY BEKLÄ°YOR'},
                {value: 'ONAYLANDI', text: 'ONAYLANDI'},
                {value: 'Ã–DEME BEKLÄ°YOR', text: 'Ã–DEME BEKLÄ°YOR'},
                {value: 'TAMAMLANDI', text: 'TAMAMLANDI'},
                {value: 'RED EDÄ°LDÄ°', text: 'RED EDÄ°LDÄ°'}
            ], row.onay_durumu, index, false, approvalReadonly, approvalDisabled);
            
            return tr;
        }
        
        // ğŸš€ Ultra hÄ±zlÄ± select oluÅŸturma
        function createSelectFast(field, options, selected, index, readonly = false, extraClass = '', disabled = false) {
            const readonlyAttr = readonly ? 'readonly disabled' : '';
            const disabledAttr = disabled ? 'disabled' : '';
            const className = readonly ? 'readonly-field' : extraClass;
            
            let html = `<select onchange="updateField(${index}, '${field}', this.value)" ${readonlyAttr} ${disabledAttr} class="${className}">`;
            options.forEach(opt => {
                html += `<option value="${opt.value}" ${selected === opt.value ? 'selected' : ''}>${opt.text}</option>`;
            });
            html += '</select>';
            return html;
        }
        
        // ğŸš€ HÄ±zlÄ± class getters - lookup table
        const statusClassMap = {
            'BEKLEMEDE': 'status-beklemede',
            'ONAY BEKLÄ°YOR': 'status-onay-bekliyor',
            'ONAYLANDI': 'status-onaylandi',
            'Ã–DEME BEKLÄ°YOR': 'status-odeme-bekliyor',
            'TAMAMLANDI': 'status-tamamlandi',
            'RED EDÄ°LDÄ°': 'status-red-edildi'
        };
        
        const deliveryClassMap = {
            'TAMAMLANDI': 'delivery-status-tamamlandi',
            'BEKLEMEDE': 'delivery-status-beklemede',
            'BELÄ°RLENMEDÄ°': 'delivery-status-belirlenmedi'
        };
        
        function getStatusClassFast(status) {
            return statusClassMap[status] || 'status-beklemede';
        }
        
        function getDeliveryStatusClassFast(status) {
            return deliveryClassMap[status] || 'delivery-status-belirlenmedi';
        }
        
        // ğŸš€ Virtual Scrolling ile Ultra HÄ±zlÄ± Tablo Render
        function renderTableVirtual() {
            const tbody = document.getElementById('table-body');
            const dataToRender = filteredData.length > 0 || searchTerm || filterValue !== 'TÃ¼mÃ¼' ? filteredData : currentData;
            
            // Veri yoksa
            if (dataToRender.length === 0) {
                if (searchTerm || filterValue !== 'TÃ¼mÃ¼') {
                    tbody.innerHTML = `
                        <tr><td colspan="24" class="no-results">
                            <div class="py-8">
                                <div class="text-lg mb-2">ğŸ”</div>
                                <div class="font-medium">EÅŸleÅŸen kayÄ±t bulunamadÄ±</div>
                                <div class="text-sm mt-1">Arama kriterlerinizi deÄŸiÅŸtirmeyi deneyin</div>
                            </div>
                        </td></tr>
                    `;
                } else {
                    tbody.innerHTML = '';
                }
                return;
            }
            
            // Virtual scrolling hesaplamalarÄ±
            const totalItems = dataToRender.length;
            virtualScrollState.totalHeight = totalItems * VIRTUAL_SCROLL.ITEM_HEIGHT;
            
            // GÃ¶rÃ¼nÃ¼r aralÄ±ÄŸÄ± hesapla
            const startIndex = Math.max(0, virtualScrollState.startIndex - VIRTUAL_SCROLL.BUFFER_SIZE);
            const endIndex = Math.min(totalItems, virtualScrollState.endIndex + VIRTUAL_SCROLL.BUFFER_SIZE);
            
            // Batch rendering - sadece gÃ¶rÃ¼nÃ¼r satÄ±rlarÄ± render et
            const fragment = document.createDocumentFragment();
            
            // Ãœst spacer
            if (startIndex > 0) {
                const topSpacer = document.createElement('tr');
                topSpacer.style.height = `${startIndex * VIRTUAL_SCROLL.ITEM_HEIGHT}px`;
                topSpacer.innerHTML = '<td colspan="24"></td>';
                fragment.appendChild(topSpacer);
            }
            
            // GÃ¶rÃ¼nÃ¼r satÄ±rlar - batch processing
            const batchSize = 20;
            for (let i = startIndex; i < endIndex; i += batchSize) {
                const batchEnd = Math.min(i + batchSize, endIndex);
                
                // Batch iÃ§indeki satÄ±rlarÄ± oluÅŸtur
                for (let j = i; j < batchEnd; j++) {
                    if (j < dataToRender.length) {
                        const row = dataToRender[j];
                        const originalIndex = currentData.findIndex(item => 
                            (item.__backendId && item.__backendId === row.__backendId) || 
                            (item.sira_no === row.sira_no && item.sof_form_no === row.sof_form_no)
                        );
                        
                        const newRow = createTableRowFast(row, originalIndex >= 0 ? originalIndex : j);
                        
                        // Checkbox durumunu koru
                        const checkbox = newRow.querySelector('.row-checkbox');
                        if (checkbox && originalIndex >= 0) {
                            checkbox.checked = selectedRows.has(originalIndex);
                        }
                        
                        fragment.appendChild(newRow);
                    }
                }
                
                // Batch arasÄ± micro-break (UI donmasÄ±nÄ± Ã¶nler)
                if (i + batchSize < endIndex) {
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }
            
            // Alt spacer
            if (endIndex < totalItems) {
                const bottomSpacer = document.createElement('tr');
                bottomSpacer.style.height = `${(totalItems - endIndex) * VIRTUAL_SCROLL.ITEM_HEIGHT}px`;
                bottomSpacer.innerHTML = '<td colspan="24"></td>';
                fragment.appendChild(bottomSpacer);
            }
            
            // DOM'a tek seferde ekle
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
            
            // UI gÃ¼ncellemeleri
            requestAnimationFrame(() => {
                updateSelectionUI();
                applyTablePermissions();
            });
        }
        
        // ğŸš€ Debounced render - Ã§ok hÄ±zlÄ± gÃ¼ncellemeleri optimize eder
        let renderTimeout;
        function renderTable() {
            if (renderTimeout) clearTimeout(renderTimeout);
            
            renderTimeout = setTimeout(() => {
                if (currentData.length > 100) {
                    // BÃ¼yÃ¼k veri setleri iÃ§in virtual scrolling
                    renderTableVirtual();
                } else {
                    // KÃ¼Ã§Ã¼k veri setleri iÃ§in normal render
                    renderTableNormal();
                }
            }, 16); // 60fps iÃ§in 16ms
        }
        
        // ğŸš€ Normal render - kÃ¼Ã§Ã¼k veri setleri iÃ§in
        function renderTableNormal() {
            const tbody = document.getElementById('table-body');
            const dataToRender = filteredData.length > 0 || searchTerm || filterValue !== 'TÃ¼mÃ¼' ? filteredData : currentData;
            
            if (dataToRender.length === 0 && (searchTerm || filterValue !== 'TÃ¼mÃ¼')) {
                tbody.innerHTML = `
                    <tr><td colspan="24" class="no-results">
                        <div class="py-8">
                            <div class="text-lg mb-2">ğŸ”</div>
                            <div class="font-medium">EÅŸleÅŸen kayÄ±t bulunamadÄ±</div>
                            <div class="text-sm mt-1">Arama kriterlerinizi deÄŸiÅŸtirmeyi deneyin</div>
                        </div>
                    </td></tr>
                `;
                return;
            }
            
            // Fragment kullanarak batch DOM update
            const fragment = document.createDocumentFragment();
            
            dataToRender.forEach((row, index) => {
                const originalIndex = currentData.findIndex(item => 
                    (item.__backendId && item.__backendId === row.__backendId) || 
                    (item.sira_no === row.sira_no && item.sof_form_no === row.sof_form_no)
                );
                
                const newRow = createTableRowFast(row, originalIndex >= 0 ? originalIndex : index);
                
                // Checkbox durumunu koru
                const checkbox = newRow.querySelector('.row-checkbox');
                if (checkbox && originalIndex >= 0) {
                    checkbox.checked = selectedRows.has(originalIndex);
                }
                
                fragment.appendChild(newRow);
            });
            
            // Tek seferde DOM'a ekle
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
            
            // UI gÃ¼ncellemeleri
            requestAnimationFrame(() => {
                updateSelectionUI();
                applyTablePermissions();
            });
        }

        // Toplu seÃ§im fonksiyonlarÄ±
        function toggleRowSelection(index) {
            const checkbox = document.querySelector(`input[data-index="${index}"]`);
            if (checkbox && checkbox.checked) {
                selectedRows.add(index);
            } else {
                selectedRows.delete(index);
            }
            updateSelectionUI();
        }

        function selectAllRows() {
            const dataToRender = filteredData.length > 0 || searchTerm || filterValue !== 'TÃ¼mÃ¼' ? filteredData : currentData;
            selectedRows.clear();
            
            dataToRender.forEach((row, displayIndex) => {
                const originalIndex = currentData.findIndex(item => 
                    (item.__backendId && item.__backendId === row.__backendId) || 
                    (item.sira_no === row.sira_no && item.sof_form_no === row.sof_form_no)
                );
                if (originalIndex >= 0) {
                    selectedRows.add(originalIndex);
                }
            });
            
            // Checkbox'larÄ± gÃ¼ncelle
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                const index = parseInt(checkbox.dataset.index);
                checkbox.checked = selectedRows.has(index);
            });
            
            document.getElementById('selectAllCheckbox').checked = true;
            updateSelectionUI();
        }

        function deselectAllRows() {
            selectedRows.clear();
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('selectAllCheckbox').checked = false;
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = selectedRows.size;
            const selectionInfo = document.getElementById('selectionInfo');
            const selectedCountSpan = document.getElementById('selectedCount');
            const bulkButtons = ['bulkEditBtn', 'bulkDeleteBtn', 'bulkApproveBtn'];
            
            if (count > 0) {
                selectionInfo.classList.remove('hidden');
                selectedCountSpan.textContent = count;
                bulkButtons.forEach(btnId => {
                    document.getElementById(btnId).disabled = false;
                });
            } else {
                selectionInfo.classList.add('hidden');
                bulkButtons.forEach(btnId => {
                    document.getElementById(btnId).disabled = true;
                });
            }
            
            // Ana checkbox durumunu gÃ¼ncelle
            const totalVisibleRows = document.querySelectorAll('.row-checkbox').length;
            const checkedRows = document.querySelectorAll('.row-checkbox:checked').length;
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (checkedRows === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedRows === totalVisibleRows) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        function selectRow(index) {
            selectedRowIndex = index;
            document.querySelectorAll('#table-body tr').forEach((tr, i) => {
                tr.classList.toggle('selected-row', i === index);
            });
        }

        function getStatusClass(status) {
            switch(status) {
                case 'BEKLEMEDE': return 'status-beklemede';
                case 'ONAY BEKLÄ°YOR': return 'status-onay-bekliyor';
                case 'ONAYLANDI': return 'status-onaylandi';
                case 'Ã–DEME BEKLÄ°YOR': return 'status-odeme-bekliyor';
                case 'TAMAMLANDI': return 'status-tamamlandi';
                case 'RED EDÄ°LDÄ°': return 'status-red-edildi';
                default: return 'status-beklemede';
            }
        }

        // Toplu iÅŸlem fonksiyonlarÄ±
        function openBulkEditModal() {
            if (!hasPermission('canBulkEdit')) {
                showNotification('Bu iÅŸlem iÃ§in yetkiniz bulunmuyor.', 'error');
                return;
            }
            
            if (selectedRows.size === 0) {
                showNotification('LÃ¼tfen dÃ¼zenlemek istediÄŸiniz satÄ±rlarÄ± seÃ§in.', 'info');
                return;
            }
            
            // Modal alanlarÄ±nÄ± temizle
            document.getElementById('bulkMalzemeTipi').value = '';
            document.getElementById('bulkBirim').value = '';
            document.getElementById('bulkBirimFiyat').value = '';
            document.getElementById('bulkOnayDurumu').value = '';
            document.getElementById('bulkTedarikci').value = '';
            document.getElementById('bulkSatinalma').value = '';
            document.getElementById('bulkPlanTeslim').value = '';
            document.getElementById('bulkTeslimatTarihi').value = '';
            document.getElementById('bulkAciklama').value = '';
            
            document.getElementById('bulkEditModal').classList.remove('hidden');
        }

        function closeBulkEditModal() {
            document.getElementById('bulkEditModal').classList.add('hidden');
        }

        async function applyBulkEdit() {
            if (isLoading) return;
            
            const updates = {};
            
            // DeÄŸiÅŸtirilecek alanlarÄ± topla
            const malzemeTipi = document.getElementById('bulkMalzemeTipi').value;
            const birim = document.getElementById('bulkBirim').value;
            const birimFiyat = document.getElementById('bulkBirimFiyat').value;
            const onayDurumu = document.getElementById('bulkOnayDurumu').value;
            const tedarikci = document.getElementById('bulkTedarikci').value;
            const satinalma = document.getElementById('bulkSatinalma').value;
            const planTeslim = document.getElementById('bulkPlanTeslim').value;
            const teslimatTarihi = document.getElementById('bulkTeslimatTarihi').value;
            const aciklama = document.getElementById('bulkAciklama').value;
            
            if (malzemeTipi) updates.malzeme_tipi = malzemeTipi;
            if (birim) updates.birim = birim;
            if (birimFiyat) updates.birim_fiyat = parseFloat(birimFiyat);
            if (onayDurumu) updates.onay_durumu = onayDurumu;
            if (tedarikci) updates.tedarikci = tedarikci;
            if (satinalma) updates.satinalma_sorumlusu = satinalma;
            if (planTeslim) updates.planlanan_teslim_tarihi = planTeslim;
            if (teslimatTarihi) updates.teslimat_tarihi = teslimatTarihi;
            if (aciklama) updates.aciklama = aciklama;
            
            if (Object.keys(updates).length === 0) {
                showNotification('LÃ¼tfen en az bir alan deÄŸiÅŸtirin.', 'info');
                return;
            }
            
            showLoading();
            let successCount = 0;
            let errorCount = 0;
            
            // SeÃ§ili satÄ±rlarÄ± gÃ¼ncelle
            for (const index of selectedRows) {
                const row = currentData[index];
                if (row) {
                    // GÃ¼ncellemeleri uygula
                    Object.assign(row, updates);
                    
                    // Birim fiyat deÄŸiÅŸtiyse toplam fiyatÄ± yeniden hesapla
                    if (updates.birim_fiyat !== undefined) {
                        row.toplam_fiyat = row.talep_miktari * row.birim_fiyat;
                    }
                    
                    // Malzeme tipi deÄŸiÅŸtiyse form numarasÄ±nÄ± gÃ¼ncelle
                    if (updates.malzeme_tipi) {
                        const currentMatch = row.sof_form_no.match(/RF100\.SOF[SD]-(\d+)/);
                        let formIndex = currentMatch ? parseInt(currentMatch[1]) : index + 1;
                        row.sof_form_no = generateFormNumber(formIndex, updates.malzeme_tipi);
                    }
                    
                    // Teslimat tarihi kontrolÃ¼
                    if (updates.teslimat_tarihi) {
                        updateApprovalStatus(row);
                    }
                    
                    const result = await window.dataSdk.update(row);
                    if (result.isOk) {
                        successCount++;
                    } else {
                        errorCount++;
                        console.error('Toplu gÃ¼ncelleme hatasÄ±:', result.error);
                    }
                }
            }
            
            hideLoading();
            closeBulkEditModal();
            
            if (successCount > 0) {
                showNotification(`âœ… ${successCount} satÄ±r baÅŸarÄ±yla gÃ¼ncellendi.`, 'success');
                deselectAllRows();
            }
            
            if (errorCount > 0) {
                showNotification(`âš ï¸ ${errorCount} satÄ±r gÃ¼ncellenirken hata oluÅŸtu.`, 'error');
            }
        }

        function showConfirmModal(title, message, callback) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            confirmCallback = null;
        }

        function executeConfirmedAction() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        }

        async function bulkDelete() {
            if (selectedRows.size === 0) {
                showNotification('LÃ¼tfen silmek istediÄŸiniz satÄ±rlarÄ± seÃ§in.', 'info');
                return;
            }
            
            showConfirmModal(
                'Toplu Silme OnayÄ±',
                `SeÃ§ili ${selectedRows.size} satÄ±rÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?`,
                async () => {
                    if (isLoading) return;
                    
                    showLoading();
                    let successCount = 0;
                    let errorCount = 0;
                    
                    // SeÃ§ili satÄ±rlarÄ± sil (geriye doÄŸru sÄ±ralayarak index karÄ±ÅŸÄ±klÄ±ÄŸÄ±nÄ± Ã¶nle)
                    const sortedIndexes = Array.from(selectedRows).sort((a, b) => b - a);
                    
                    for (const index of sortedIndexes) {
                        const row = currentData[index];
                        if (row) {
                            const result = await window.dataSdk.delete(row);
                            if (result.isOk) {
                                successCount++;
                            } else {
                                errorCount++;
                                console.error('Toplu silme hatasÄ±:', result.error);
                            }
                        }
                    }
                    
                    hideLoading();
                    
                    if (successCount > 0) {
                        showNotification(`ğŸ—‘ï¸ ${successCount} satÄ±r silindi.`, 'success');
                        deselectAllRows();
                    }
                    
                    if (errorCount > 0) {
                        showNotification(`âš ï¸ ${errorCount} satÄ±r silinirken hata oluÅŸtu.`, 'error');
                    }
                }
            );
        }

        async function bulkApprove() {
            if (selectedRows.size === 0) {
                showNotification('LÃ¼tfen onaylamak istediÄŸiniz satÄ±rlarÄ± seÃ§in.', 'info');
                return;
            }
            
            if (isLoading) return;
            
            showLoading();
            let successCount = 0;
            let errorCount = 0;
            
            // SeÃ§ili satÄ±rlarÄ± onayla
            for (const index of selectedRows) {
                const row = currentData[index];
                if (row) {
                    row.onay_durumu = 'ONAYLANDI';
                    
                    const result = await window.dataSdk.update(row);
                    if (result.isOk) {
                        successCount++;
                    } else {
                        errorCount++;
                        console.error('Toplu onaylama hatasÄ±:', result.error);
                    }
                }
            }
            
            hideLoading();
            
            if (successCount > 0) {
                showNotification(`âœ… ${successCount} satÄ±r onaylandÄ±.`, 'success');
                deselectAllRows();
            }
            
            if (errorCount > 0) {
                showNotification(`âš ï¸ ${errorCount} satÄ±r onaylanÄ±rken hata oluÅŸtu.`, 'error');
            }
        }

        // Teslimat tarihi ile onay durumu kontrolÃ¼
        async function updateFieldWithApprovalCheck(index, field, value) {
            if (isLoading) return;
            
            const row = currentData[index];
            row[field] = value;
            
            // Teslimat tarihi deÄŸiÅŸtiÄŸinde onay durumunu kontrol et
            if (field === 'teslimat_tarihi') {
                updateApprovalStatus(row);
                
                // Onay durumu hÃ¼cresini gÃ¼ncelle
                const onayCell = document.querySelector(`#table-body tr:nth-child(${index + 1}) td:nth-child(23) select`);
                if (onayCell) {
                    onayCell.value = row.onay_durumu;
                    // Readonly durumunu gÃ¼ncelle
                    if (value && value.trim() !== '') {
                        onayCell.classList.add('readonly-field');
                        onayCell.disabled = true;
                    } else {
                        onayCell.classList.remove('readonly-field');
                        onayCell.disabled = false;
                    }
                }
                
                // SatÄ±r rengini gÃ¼ncelle
                const tableRow = document.querySelector(`#table-body tr:nth-child(${index + 1})`);
                if (tableRow) {
                    tableRow.className = tableRow.className.replace(/status-\w+/g, '');
                    tableRow.classList.add(getStatusClass(row.onay_durumu));
                }
            }
            
            showLoading();
            const result = await window.dataSdk.update(row);
            hideLoading();
            
            if (!result.isOk) {
                showNotification('GÃ¼ncelleme sÄ±rasÄ±nda hata oluÅŸtu: ' + result.error.message, 'error');
            }
        }

        // Teslimat tarihi gÃ¼ncelleme fonksiyonu
        async function updateFieldWithDeliveryCheck(index, field, value) {
            if (isLoading) return;
            
            const row = currentData[index];
            row[field] = value;
            
            // Teslimat tarihi deÄŸiÅŸtiÄŸinde teslimat durumunu kontrol et
            if (field === 'teslimat_tarihi') {
                updateDeliveryStatus(row);
                
                // Teslimat durumu hÃ¼cresini gÃ¼ncelle
                const deliveryCell = document.querySelector(`#table-body tr:nth-child(${index + 1}) td:nth-child(8) span`);
                if (deliveryCell) {
                    deliveryCell.textContent = row.teslimat_durumu;
                    
                    // CSS sÄ±nÄ±fÄ±nÄ± gÃ¼ncelle
                    let newClass = 'delivery-status-belirlenmedi';
                    if (row.teslimat_durumu === 'TAMAMLANDI') {
                        newClass = 'delivery-status-tamamlandi';
                    } else if (row.teslimat_durumu === 'BEKLEMEDE') {
                        newClass = 'delivery-status-beklemede';
                    }
                    deliveryCell.className = newClass;
                }
            }
            
            showLoading();
            const result = await window.dataSdk.update(row);
            hideLoading();
            
            if (!result.isOk) {
                showNotification('GÃ¼ncelleme sÄ±rasÄ±nda hata oluÅŸtu: ' + result.error.message, 'error');
            }
        }

        async function updateField(index, field, value) {
            if (isLoading) return;
            
            const row = currentData[index];
            row[field] = value;
            
            // Malzeme tipi deÄŸiÅŸtiÄŸinde form numarasÄ±nÄ± gÃ¼ncelle
            if (field === 'malzeme_tipi') {
                // Mevcut form numarasÄ±ndan index'i Ã§Ä±kar veya satÄ±r pozisyonunu kullan
                const currentMatch = row.sof_form_no.match(/RF100\.SOF[SD]-(\d+)/);
                let formIndex;
                
                if (currentMatch) {
                    formIndex = parseInt(currentMatch[1]);
                } else {
                    // Form numarasÄ± yoksa veya geÃ§ersizse, satÄ±r pozisyonunu kullan
                    formIndex = index + 1;
                }
                
                row.sof_form_no = generateFormNumber(formIndex, value);
                
                // Form numarasÄ± hÃ¼cresini gÃ¼ncelle
                const formNoCell = document.querySelector(`#table-body tr:nth-child(${index + 1}) td:nth-child(3)`);
                if (formNoCell) {
                    formNoCell.textContent = row.sof_form_no;
                }
                debouncedCalculateTotal();
            }
            
            // Otomatik hesaplama: TOPLAM FÄ°YAT = TALEP MÄ°KTARI Ã— BÄ°RÄ°M FÄ°YAT
            if (field === 'talep_miktari' || field === 'birim_fiyat') {
                row.toplam_fiyat = row.talep_miktari * row.birim_fiyat;
                
                // Toplam fiyat hÃ¼cresini anÄ±nda gÃ¼ncelle
                const toplamCell = document.querySelector(`#table-body tr:nth-child(${index + 1}) td:nth-child(15)`);
                if (toplamCell) {
                    toplamCell.textContent = row.toplam_fiyat.toFixed(2);
                }
                
                // Debounced toplam hesaplama
                debouncedCalculateTotal();
            }
            
            // Talep eden deÄŸiÅŸtiÄŸinde satÄ±r rengini gÃ¼ncelle
            if (field === 'talep_eden') {
                const tableRow = document.querySelector(`#table-body tr:nth-child(${index + 1})`);
                if (tableRow) {
                    if (value && value.trim() !== '') {
                        tableRow.classList.add('talep-eden-filled');
                    } else {
                        tableRow.classList.remove('talep-eden-filled');
                    }
                }
            }
            
            // Onay durumu deÄŸiÅŸtiÄŸinde satÄ±r rengini gÃ¼ncelle
            if (field === 'onay_durumu') {
                const tableRow = document.querySelector(`#table-body tr:nth-child(${index + 1})`);
                if (tableRow) {
                    // Eski status sÄ±nÄ±flarÄ±nÄ± kaldÄ±r
                    tableRow.className = tableRow.className.replace(/status-\w+/g, '');
                    // Yeni status sÄ±nÄ±fÄ±nÄ± ekle
                    tableRow.classList.add(getStatusClass(value));
                    
                    // Talep eden dolu ise sÄ±nÄ±fÄ± koru
                    if (row.talep_eden && row.talep_eden.trim() !== '') {
                        tableRow.classList.add('talep-eden-filled');
                    }
                }
            }
            
            // YalnÄ±zca kritik iÅŸlemlerde loading gÃ¶ster
            if (field === 'onay_durumu' || field === 'malzeme_tipi') {
                showLoading();
            }
            
            const result = await window.dataSdk.update(row);
            
            if (field === 'onay_durumu' || field === 'malzeme_tipi') {
                hideLoading();
            }
            
            if (!result.isOk) {
                showNotification('GÃ¼ncelleme sÄ±rasÄ±nda hata oluÅŸtu: ' + result.error.message, 'error');
            }
        }

        function calculateTotal() {
            const sarfTotal = currentData
                .filter(row => row.malzeme_tipi === 'SARF')
                .reduce((sum, row) => sum + row.toplam_fiyat, 0);
            
            const demirbasTotal = currentData
                .filter(row => row.malzeme_tipi === 'DEMÄ°RBAÅ')
                .reduce((sum, row) => sum + row.toplam_fiyat, 0);
            
            const genelTotal = sarfTotal + demirbasTotal;
            
            // TÃ¼rkÃ§e format ile panel kartlarÄ±nÄ± gÃ¼ncelle (â‚½ 125.430,00)
            document.getElementById('sarf-toplam-panel').textContent = `â‚½ ${sarfTotal.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('demirbas-toplam-panel').textContent = `â‚½ ${demirbasTotal.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('genel-toplam-panel').textContent = `â‚½ ${genelTotal.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        async function yeniTalepBaslat() {
            if (!hasPermission('canAdd')) {
                showNotification('Bu iÅŸlem iÃ§in yetkiniz bulunmuyor.', 'error');
                return;
            }
            
            if (isLoading) return;
            if (currentData.length >= 999) {
                showNotification('Maksimum 999 kayÄ±t sÄ±nÄ±rÄ±na ulaÅŸÄ±ldÄ±. LÃ¼tfen Ã¶nce bazÄ± kayÄ±tlarÄ± silin.', 'error');
                return;
            }
            
            showLoading();
            const newRow = createNewRow();
            const result = await window.dataSdk.create(newRow);
            hideLoading();
            
            if (!result.isOk) {
                showNotification('Yeni talep oluÅŸturulurken hata oluÅŸtu: ' + result.error.message, 'error');
            }
        }

        async function altSatirEkle() {
            if (!hasPermission('canAdd')) {
                showNotification('Bu iÅŸlem iÃ§in yetkiniz bulunmuyor.', 'error');
                return;
            }
            
            if (isLoading) return;
            if (currentData.length >= 999) {
                showNotification('Maksimum 999 kayÄ±t sÄ±nÄ±rÄ±na ulaÅŸÄ±ldÄ±. LÃ¼tfen Ã¶nce bazÄ± kayÄ±tlarÄ± silin.', 'error');
                return;
            }
            
            if (currentData.length === 0) {
                showNotification('Ã–nce "Yeni Talep BaÅŸlat" butonuna basarak bir form oluÅŸturun.', 'info');
                return;
            }
            
            const lastRow = currentData[currentData.length - 1];
            const lastFormNo = lastRow.sof_form_no;
            const lastTalepTarihi = lastRow.talep_tarihi;
            const lastTeslimTarihi = lastRow.istenen_teslim_tarihi;
            
            showLoading();
            const newRow = createNewRow(lastFormNo, lastRow.malzeme_tipi, true, lastTalepTarihi, lastTeslimTarihi);
            const result = await window.dataSdk.create(newRow);
            hideLoading();
            
            if (!result.isOk) {
                showNotification('Alt satÄ±r eklenirken hata oluÅŸtu: ' + result.error.message, 'error');
            }
        }

        async function satirSil() {
            if (!hasPermission('canDelete')) {
                showNotification('Bu iÅŸlem iÃ§in yetkiniz bulunmuyor.', 'error');
                return;
            }
            
            if (isLoading) return;
            if (selectedRowIndex === -1) {
                showNotification('LÃ¼tfen silmek istediÄŸiniz satÄ±rÄ± seÃ§in.', 'info');
                return;
            }
            
            const selectedRow = currentData[selectedRowIndex];
            
            showLoading();
            const result = await window.dataSdk.delete(selectedRow);
            hideLoading();
            
            if (result.isOk) {
                selectedRowIndex = -1;
                showNotification('SatÄ±r baÅŸarÄ±yla silindi.', 'success');
            } else {
                showNotification('SatÄ±r silinirken hata oluÅŸtu: ' + result.error.message, 'error');
            }
        }

        // Dinamik PDF kÃ¼tÃ¼phanesi yÃ¼kleme
        async function loadJsPDF() {
            if (jsPDFLoaded && window.jsPDF) {
                return true;
            }
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = () => {
                    jsPDFLoaded = true;
                    resolve(true);
                };
                script.onerror = () => {
                    reject(new Error('PDF kÃ¼tÃ¼phanesi yÃ¼klenemedi'));
                };
                document.head.appendChild(script);
            });
        }

        function csvDÄ±saAktar() {
            if (!hasPermission('canExport')) {
                showNotification('Bu iÅŸlem iÃ§in yetkiniz bulunmuyor.', 'error');
                return;
            }
            
            if (currentData.length === 0) {
                showNotification('DÄ±ÅŸa aktarÄ±lacak veri bulunmuyor. Ã–nce veri ekleyin.', 'info');
                return;
            }

            // CSV baÅŸlÄ±klarÄ±
            const headers = [
                'SIRA NO',
                'SOF FORM NO', 
                'MALZEME TÄ°PÄ°',
                'TALEP EDEN',
                'TALEP TARÄ°HÄ°',
                'Ä°STENEN TESLÄ°M TARÄ°HÄ°',
                'TESLÄ°MAT DURUMU',
                'TALEP EDÄ°LEN MALZEME',
                'DETAY 1 (MARKA, MODEL VB)',
                'DETAY 2 (PROJE, STANDART VB KODLAR)',
                'BÄ°RÄ°M',
                'TALEP MÄ°KTARI',
                'SÄ°PARÄ°Å MÄ°KTARI',
                'BÄ°RÄ°M FÄ°YAT (â‚½ RUB)',
                'TOPLAM FÄ°YAT (â‚½ RUB)',
                'TEDARÄ°KÃ‡Ä°',
                'SATINALMA SORUMLUSU',
                'PLANLANAN TESLÄ°M TARÄ°HÄ°',
                'TESLÄ°MAT MÄ°KTARI',
                'TESLÄ°MAT TARÄ°HÄ°',
                'KALAN MÄ°KTAR',
                'ONAY DURUMU',
                'AÃ‡IKLAMA'
            ];

            // CSV iÃ§eriÄŸi oluÅŸtur
            let csvContent = '\uFEFF'; // UTF-8 BOM for Excel compatibility
            
            // BaÅŸlÄ±klarÄ± ekle
            csvContent += headers.join(';') + '\n';
            
            // Veri satÄ±rlarÄ±nÄ± ekle
            currentData.forEach(row => {
                const csvRow = [
                    row.sira_no,
                    `"${row.sof_form_no}"`,
                    `"${row.malzeme_tipi}"`,
                    `"${row.talep_eden}"`,
                    `"${row.talep_tarihi}"`,
                    `"${row.istenen_teslim_tarihi}"`,
                    `"${row.teslimat_durumu}"`,
                    `"${row.talep_edilen_malzeme}"`,
                    `"${row.detay_1}"`,
                    `"${row.detay_2}"`,
                    `"${row.birim}"`,
                    row.talep_miktari,
                    row.siparis_miktari,
                    row.birim_fiyat.toFixed(2),
                    row.toplam_fiyat.toFixed(2),
                    `"${row.tedarikci}"`,
                    `"${row.satinalma_sorumlusu}"`,
                    `"${row.planlanan_teslim_tarihi}"`,
                    row.teslimat_miktari,
                    `"${row.teslimat_tarihi}"`,
                    row.kalan_miktar,
                    `"${row.onay_durumu}"`,
                    `"${row.aciklama}"`
                ];
                csvContent += csvRow.join(';') + '\n';
            });

            // Alt toplamlarÄ± ekle
            csvContent += '\n'; // BoÅŸ satÄ±r
            
            const sarfTotal = currentData
                .filter(row => row.malzeme_tipi === 'SARF')
                .reduce((sum, row) => sum + row.toplam_fiyat, 0);
            const demirbasTotal = currentData
                .filter(row => row.malzeme_tipi === 'DEMÄ°RBAÅ')
                .reduce((sum, row) => sum + row.toplam_fiyat, 0);
            const genelTotal = sarfTotal + demirbasTotal;
            
            csvContent += `"SARF TOPLAMI (â‚½ RUB):";;;;;;;;;;;;;;;"${sarfTotal.toFixed(2)}"\n`;
            csvContent += `"DEMÄ°RBAÅ TOPLAMI (â‚½ RUB):";;;;;;;;;;;;;;;"${demirbasTotal.toFixed(2)}"\n`;
            csvContent += `"GENEL TOPLAM (â‚½ RUB):";;;;;;;;;;;;;;;"${genelTotal.toFixed(2)}"\n`;

            // Dosya adÄ± oluÅŸtur
            const today = new Date().toLocaleDateString('tr-TR');
            const fileName = `SOMTECH_SOF_${today.replace(/\./g, '_')}.csv`;

            // CSV dosyasÄ±nÄ± indir
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification(`CSV dosyasÄ± baÅŸarÄ±yla indirildi: ${fileName}`, 'success');
            } else {
                showNotification('TarayÄ±cÄ±nÄ±z dosya indirmeyi desteklemiyor.', 'error');
            }
        }

        // Yeni CSV dÄ±ÅŸa aktarma fonksiyonu - istenen formatta
        function exportToCSV() {
            if (!hasPermission('canExport')) {
                showNotification('Bu iÅŸlem iÃ§in yetkiniz bulunmuyor.', 'error');
                return;
            }
            
            if (currentData.length === 0) {
                showNotification('DÄ±ÅŸa aktarÄ±lacak veri bulunmuyor. Ã–nce veri ekleyin.', 'info');
                return;
            }

            const today = new Date();
            const fileName = `SOF_TALEP_LISTESI_${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}.csv`;

            // Tablo verilerinden baÅŸlÄ±klarÄ± al
            const headers = [
                'sira_no',
                'sof_form_no',
                'malzeme_tipi',
                'talep_eden',
                'talep_tarihi',
                'istenen_teslim_tarihi',
                'teslimat_durumu',
                'talep_edilen_malzeme',
                'detay_1',
                'detay_2',
                'birim',
                'talep_miktari',
                'siparis_miktari',
                'birim_fiyat',
                'toplam_fiyat',
                'tedarikci',
                'satinalma_sorumlusu',
                'planlanan_teslim_tarihi',
                'teslimat_miktari',
                'teslimat_tarihi',
                'kalan_miktar',
                'onay_durumu',
                'aciklama'
            ];

            // CSV satÄ±rlarÄ± oluÅŸtur
            const csvRows = [headers.join(";")];

            currentData.forEach(row => {
                const values = headers.map(h => {
                    const value = row[h];
                    if (value === null || value === undefined) {
                        return "";
                    }
                    // String deÄŸerleri Ã§ift tÄ±rnak iÃ§ine al ve iÃ§indeki Ã§ift tÄ±rnaklarÄ± escape et
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(";"));
            });

            // UTF-8 BOM ekleyerek CSV string oluÅŸtur
            const csvString = '\uFEFF' + csvRows.join("\n");
            
            // Blob oluÅŸtur ve indir
            const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = fileName;
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification(`ğŸ“¦ Veriler baÅŸarÄ±yla dÄ±ÅŸa aktarÄ±ldÄ±: ${fileName}`, 'success');
            } else {
                showNotification('TarayÄ±cÄ±nÄ±z dosya indirmeyi desteklemiyor.', 'error');
            }
        }

        // Excel dÄ±ÅŸa aktarma fonksiyonu
        function exportToExcel() {
            if (!hasPermission('canExport')) {
                showNotification('Bu iÅŸlem iÃ§in yetkiniz bulunmuyor.', 'error');
                return;
            }
            
            if (!window.XLSX) {
                showNotification('Excel kÃ¼tÃ¼phanesi yÃ¼klenemedi. LÃ¼tfen sayfayÄ± yenileyin.', 'error');
                return;
            }

            if (currentData.length === 0) {
                showNotification('DÄ±ÅŸa aktarÄ±lacak veri bulunmuyor. Ã–nce veri ekleyin.', 'info');
                return;
            }

            try {
                // Yedekleme iÃ§in localStorage'a kaydet
                localStorage.setItem(BACKUP_KEY, JSON.stringify(currentData));

                // Excel iÃ§in veri hazÄ±rla
                const excelData = currentData.map(row => ({
                    'SIRA NO': row.sira_no,
                    'SOF FORM NO': row.sof_form_no,
                    'MALZEME TÄ°PÄ°': row.malzeme_tipi,
                    'TALEP EDEN': row.talep_eden,
                    'TALEP TARÄ°HÄ°': row.talep_tarihi,
                    'Ä°STENEN TESLÄ°M TARÄ°HÄ°': row.istenen_teslim_tarihi,
                    'TESLÄ°MAT DURUMU': row.teslimat_durumu,
                    'TALEP EDÄ°LEN MALZEME': row.talep_edilen_malzeme,
                    'DETAY 1': row.detay_1,
                    'DETAY 2': row.detay_2,
                    'BÄ°RÄ°M': row.birim,
                    'TALEP MÄ°KTARI': row.talep_miktari,
                    'SÄ°PARÄ°Å MÄ°KTARI': row.siparis_miktari,
                    'BÄ°RÄ°M FÄ°YAT (â‚½ RUB)': row.birim_fiyat,
                    'TOPLAM FÄ°YAT (â‚½ RUB)': row.toplam_fiyat,
                    'TEDARÄ°KÃ‡Ä°': row.tedarikci,
                    'SATINALMA SORUMLUSU': row.satinalma_sorumlusu,
                    'PLANLANAN TESLÄ°M TARÄ°HÄ°': row.planlanan_teslim_tarihi,
                    'TESLÄ°MAT MÄ°KTARI': row.teslimat_miktari,
                    'TESLÄ°MAT TARÄ°HÄ°': row.teslimat_tarihi,
                    'KALAN MÄ°KTAR': row.kalan_miktar,
                    'ONAY DURUMU': row.onay_durumu,
                    'AÃ‡IKLAMA': row.aciklama
                }));

                // Workbook oluÅŸtur
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);

                // SÃ¼tun geniÅŸliklerini ayarla
                const colWidths = [
                    { wch: 8 },   // SIRA NO
                    { wch: 18 },  // SOF FORM NO
                    { wch: 12 },  // MALZEME TÄ°PÄ°
                    { wch: 15 },  // TALEP EDEN
                    { wch: 12 },  // TALEP TARÄ°HÄ°
                    { wch: 18 },  // Ä°STENEN TESLÄ°M TARÄ°HÄ°
                    { wch: 15 },  // TESLÄ°MAT DURUMU
                    { wch: 25 },  // TALEP EDÄ°LEN MALZEME
                    { wch: 20 },  // DETAY 1
                    { wch: 20 },  // DETAY 2
                    { wch: 8 },   // BÄ°RÄ°M
                    { wch: 12 },  // TALEP MÄ°KTARI
                    { wch: 12 },  // SÄ°PARÄ°Å MÄ°KTARI
                    { wch: 15 },  // BÄ°RÄ°M FÄ°YAT
                    { wch: 15 },  // TOPLAM FÄ°YAT
                    { wch: 15 },  // TEDARÄ°KÃ‡Ä°
                    { wch: 18 },  // SATINALMA SORUMLUSU
                    { wch: 18 },  // PLANLANAN TESLÄ°M TARÄ°HÄ°
                    { wch: 12 },  // TESLÄ°MAT MÄ°KTARI
                    { wch: 12 },  // TESLÄ°MAT TARÄ°HÄ°
                    { wch: 12 },  // KALAN MÄ°KTAR
                    { wch: 12 },  // ONAY DURUMU
                    { wch: 20 }   // AÃ‡IKLAMA
                ];
                ws['!cols'] = colWidths;

                // Worksheet'i workbook'a ekle
                XLSX.utils.book_append_sheet(wb, ws, "SOF_LISTESI");

                // Dosya adÄ± oluÅŸtur
                const today = new Date();
                const fileName = `SOF_TALEP_LISTESI_${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}.xlsx`;

                // DosyayÄ± indir
                XLSX.writeFile(wb, fileName);

                showNotification(`ğŸ“Š Excel dosyasÄ± baÅŸarÄ±yla indirildi: ${fileName}`, 'success');
            } catch (error) {
                console.error('Excel dÄ±ÅŸa aktarma hatasÄ±:', error);
                showNotification('Excel dosyasÄ± oluÅŸturulurken hata oluÅŸtu.', 'error');
            }
        }

        async function pdfIndir() {
            if (!hasPermission('canExport')) {
                showNotification('Bu iÅŸlem iÃ§in yetkiniz bulunmuyor.', 'error');
                return;
            }
            
            if (selectedRowIndex === -1) {
                showNotification('PDF oluÅŸturmak iÃ§in bir form seÃ§iniz.', 'info');
                return;
            }

            // PDF kÃ¼tÃ¼phanesini dinamik olarak yÃ¼kle
            try {
                showLoading();
                await loadJsPDF();
                hideLoading();
            } catch (error) {
                hideLoading();
                showNotification('PDF kÃ¼tÃ¼phanesi yÃ¼klenemedi. LÃ¼tfen tekrar deneyin.', 'error');
                return;
            }

            const { jsPDF } = window.jsPDF;
            const doc = new jsPDF('l', 'mm', 'a4'); // A4 Landscape - 297x210mm
            
            // SeÃ§ili satÄ±rÄ±n form numarasÄ±nÄ± al
            const selectedRow = currentData[selectedRowIndex];
            const selectedFormNo = selectedRow.sof_form_no;
            
            // AynÄ± form numarasÄ±na sahip tÃ¼m satÄ±rlarÄ± filtrele
            const formRows = currentData.filter(row => row.sof_form_no === selectedFormNo);
            
            // Logo ekleme
            const logoUrl = 'https://raw.githubusercontent.com/okarsli/deneme/main/%C5%9Eeffaf%20Logo.png';
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            img.onload = function() {
                try {
                    // Logo sol Ã¼st kÃ¶ÅŸe, 90px geniÅŸlik
                    const logoWidth = 30; // mm cinsinden
                    const logoHeight = 15; // mm cinsinden
                    doc.addImage(img, 'PNG', 15, 15, logoWidth, logoHeight);
                } catch (e) {
                    console.log('Logo eklenemedi:', e);
                }
                generatePDFContent(doc, formRows, selectedFormNo);
            };
            
            img.onerror = function() {
                console.log('Logo yÃ¼klenemedi, PDF logo olmadan oluÅŸturuluyor');
                generatePDFContent(doc, formRows, selectedFormNo);
            };
            
            img.src = logoUrl;
        }

        function generatePDFContent(doc, formRows, formNo) {
            const pageWidth = 297; // A4 landscape geniÅŸlik
            const pageHeight = 210; // A4 landscape yÃ¼kseklik
            const margin = 15; // 15mm kenar boÅŸluÄŸu
            
            // Tarih - saÄŸ Ã¼st kÃ¶ÅŸede
            const today = new Date();
            const formattedDate = `${String(today.getDate()).padStart(2, '0')}.${String(today.getMonth() + 1).padStart(2, '0')}.${today.getFullYear()}`;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(0, 0, 0);
            doc.text(`Tarih: ${formattedDate}`, pageWidth - margin, 25, { align: 'right' });
            
            // Ana baÅŸlÄ±k - koyu lacivert (#0D47A1)
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(13, 71, 161); // #0D47A1
            doc.text('SÄ°PARÄ°Å ONAY FORMU (SOF)', pageWidth / 2, 45, { align: 'center' });
            
            // Alt baÅŸlÄ±k - gri (#757575)
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(117, 117, 117); // #757575
            doc.text('RF100, SOMTECH RU, FABRÄ°KA MÃœDÃœRLÃœÄÃœ', pageWidth / 2, 55, { align: 'center' });
            
            // Tablo baÅŸlÄ±klarÄ±
            const headers = [
                'SÄ±ra No', 'Ä°stenen Teslimat Tarihi', 'Talep Edilen Malzeme', 'Detay 1', 'Detay 2', 
                'Birim', 'Talep MiktarÄ±', 'SipariÅŸ MiktarÄ±', 'Birim Fiyat (â‚½ RUB)', 'Toplam Fiyat (â‚½ RUB)'
            ];
            
            let yPos = 70;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            
            // Tablo geniÅŸliÄŸi hesaplama
            const tableWidth = pageWidth - (2 * margin);
            const colWidths = [15, 25, 45, 35, 35, 15, 20, 20, 25, 25]; // Toplam: 260mm
            
            // BaÅŸlÄ±k satÄ±rÄ± - lacivert arka plan (#2459A0)
            doc.setFillColor(36, 89, 160); // #2459A0
            doc.setTextColor(255, 255, 255); // Beyaz yazÄ±
            doc.setDrawColor(204, 204, 204); // Gri kenarlÄ±k
            
            let xPos = margin;
            headers.forEach((header, i) => {
                doc.rect(xPos, yPos, colWidths[i], 10, 'FD'); // Fill and Draw
                doc.text(header, xPos + 2, yPos + 6);
                xPos += colWidths[i];
            });
            
            yPos += 10;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(0, 0, 0); // Siyah yazÄ±
            
            // Veri satÄ±rlarÄ±
            formRows.forEach((row, index) => {
                // Sayfa kontrolÃ¼ - alt kÄ±sÄ±mda imza alanÄ± iÃ§in yer bÄ±rak
                if (yPos > pageHeight - 60) {
                    doc.addPage();
                    yPos = 25; // Yeni sayfada Ã¼stten baÅŸla
                }
                
                xPos = margin;
                const rowData = [
                    row.sira_no.toString(),
                    row.istenen_teslim_tarihi,
                    row.talep_edilen_malzeme.length > 25 ? row.talep_edilen_malzeme.substring(0, 25) + '...' : row.talep_edilen_malzeme,
                    row.detay_1.length > 20 ? row.detay_1.substring(0, 20) + '...' : row.detay_1,
                    row.detay_2.length > 20 ? row.detay_2.substring(0, 20) + '...' : row.detay_2,
                    row.birim,
                    row.talep_miktari.toString(),
                    row.siparis_miktari.toString(),
                    `${row.birim_fiyat.toFixed(2)} â‚½`,
                    `${row.toplam_fiyat.toFixed(2)} â‚½`
                ];
                
                // Zebra striping - Ã§ift satÄ±rlar aÃ§Ä±k gri (#F5F5F5)
                if (index % 2 === 0) {
                    doc.setFillColor(245, 245, 245); // #F5F5F5
                    doc.rect(margin, yPos, tableWidth, 8, 'F');
                }
                
                // HÃ¼cre kenarlÄ±klarÄ± ve veriler
                rowData.forEach((data, i) => {
                    doc.setDrawColor(204, 204, 204); // #CCCCCC kenarlÄ±k
                    doc.rect(xPos, yPos, colWidths[i], 8, 'D');
                    doc.text(data, xPos + 1, yPos + 5);
                    xPos += colWidths[i];
                });
                
                yPos += 8;
            });
            
            // Genel toplam
            yPos += 15;
            const genelTotal = formRows.reduce((sum, row) => sum + row.toplam_fiyat, 0);
            
            // Genel toplam kutusu - lacivert arka plan
            const totalBoxWidth = 120;
            const totalBoxX = pageWidth - margin - totalBoxWidth;
            
            doc.setFillColor(36, 89, 160); // #2459A0
            doc.setTextColor(255, 255, 255); // Beyaz yazÄ±
            doc.rect(totalBoxX, yPos, totalBoxWidth, 12, 'FD');
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('GENEL TOPLAM (â‚½ RUB):', totalBoxX + 5, yPos + 8);
            doc.text(`${genelTotal.toFixed(2)} â‚½`, totalBoxX + 80, yPos + 8);
            
            // Ä°mza alanlarÄ± - sayfa altÄ±nda
            const signatureY = pageHeight - 30;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            
            // Ä°mza alanlarÄ± yatayda eÅŸit aralÄ±kta
            const signatureWidth = (pageWidth - 2 * margin) / 3;
            const signatures = [
                'OÄŸuzhan KarslÄ± â€” SatÄ±nalma ve Lojistik MÃ¼dÃ¼rÃ¼',
                'Osman TalaÅŸ â€” Genel MÃ¼dÃ¼r',
                'Mutlu DoÄŸan â€” Onay'
            ];
            
            signatures.forEach((signature, index) => {
                const signatureX = margin + (index * signatureWidth);
                const centerX = signatureX + (signatureWidth / 2);
                
                // Ä°sim ve unvan
                doc.text(signature, centerX, signatureY, { align: 'center' });
                
                // AltÄ± Ã§izili boÅŸluk (imza Ã§izgisi)
                const lineWidth = 70; // mm
                const lineX = centerX - (lineWidth / 2);
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.5);
                doc.line(lineX, signatureY + 3, lineX + lineWidth, signatureY + 3);
            });
            
            // Alt bilgi - sayfanÄ±n en altÄ±nda ortalanmÄ±ÅŸ gri yazÄ±
            doc.setFontSize(8);
            doc.setFont('helvetica', 'italic');
            doc.setTextColor(117, 117, 117); // #757575
            doc.text('Bu belge SOMTECH RU SatÄ±nalma YÃ¶netim Sistemi tarafÄ±ndan otomatik oluÅŸturulmuÅŸtur.', 
                     pageWidth / 2, pageHeight - 10, { align: 'center' });
            
            // PDF kaydet
            const cleanFormNo = formNo.replace(/[^a-zA-Z0-9-]/g, '_');
            const fileName = `SOF_${cleanFormNo}_${formattedDate.replace(/\./g, '-')}.pdf`;
            doc.save(fileName);
            showNotification(`ğŸ“„ PDF dosyasÄ± baÅŸarÄ±yla indirildi: ${fileName}`, 'success');
        }

        // LocalStorage'dan veri yÃ¼kleme ve Data SDK'ya aktarma
        async function loadLocalStorageToDataSDK() {
            const localData = loadFromLocalStorage();
            if (localData && localData.length > 0) {
                showLoading();
                
                try {
                    console.log(`LocalStorage'dan ${localData.length} kayÄ±t Data SDK'ya yÃ¼kleniyor...`);
                    
                    // LocalStorage'daki her kayÄ±t iÃ§in Data SDK'ya ekle
                    await loadDataToSDK(localData);
                    
                    hideLoading();
                    showNotification('ğŸ“¦ Veriler yerel depodan yÃ¼klendi', 'info');
                    return true; // BaÅŸarÄ±lÄ± yÃ¼kleme
                } catch (error) {
                    hideLoading();
                    console.error('LocalStorage verisi yÃ¼klenirken hata:', error);
                    showNotification('Yerel veriler yÃ¼klenirken hata oluÅŸtu.', 'error');
                    return false;
                }
            }
            return false; // Yerel veri yok
        }

        // Yedek veri yÃ¼kleme ve Data SDK'ya aktarma
        async function loadBackupToDataSDK() {
            const backupData = loadBackupData();
            if (backupData && backupData.length > 0) {
                showLoading();
                
                try {
                    console.log(`Yedek veriden ${backupData.length} kayÄ±t yÃ¼kleniyor...`);
                    
                    // Yedek verideki her kayÄ±t iÃ§in Data SDK'ya ekle
                    for (const record of backupData) {
                        // __backendId'yi kaldÄ±r Ã§Ã¼nkÃ¼ create iÅŸlemi iÃ§in gerekli deÄŸil
                        const { __backendId, ...recordWithoutId } = record;
                        const result = await window.dataSdk.create(recordWithoutId);
                        if (!result.isOk) {
                            console.error('Yedek verisi Data SDK\'ya eklenirken hata:', result.error);
                        }
                    }
                    
                    hideLoading();
                    showNotification('âœ… Yedek veri bulundu ve yÃ¼klendi', 'success');
                    return true; // BaÅŸarÄ±lÄ± yÃ¼kleme
                } catch (error) {
                    hideLoading();
                    console.error('Yedek verisi yÃ¼klenirken hata:', error);
                    showNotification('Yedek veriler yÃ¼klenirken hata oluÅŸtu.', 'error');
                    return false;
                }
            }
            return false; // Yedek veri yok
        }

        // GitHub'dan CSV yÃ¼kleme fonksiyonu - sadece ilk seferde Ã§alÄ±ÅŸÄ±r
        async function loadFromGitHubCSV(isManual = false) {
            // Manuel yeniden yÃ¼kleme deÄŸilse ve daha Ã¶nce yÃ¼klendiyse Ã§Ä±k
            if (!isManual && localStorage.getItem(LOADED_FLAG)) {
                console.log('ğŸ“¦ Veriler daha Ã¶nce yÃ¼klendi, GitHub\'a gidilmiyor');
                return false;
            }
            
            const csvUrl = 'https://raw.githubusercontent.com/okarsli/deneme/refs/heads/main/data.csv';
            
            try {
                showLoading();
                
                console.log('ğŸŒ GitHub CSV\'den veri Ã§ekiliyor (tek seferlik)...');
                
                // GitHub'dan CSV dosyasÄ±nÄ± UTF-8 kodlamasÄ±yla fetch et
                const response = await fetch(csvUrl, {
                    mode: 'cors',
                    headers: {
                        'Accept': 'text/csv,text/plain,*/*',
                        'Accept-Charset': 'utf-8'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // UTF-8 olarak oku
                const csvText = await response.text();
                
                // CSV'yi ayrÄ±ÅŸtÄ±r ve localStorage'a kaydet
                const parsedData = await parseCSVToData(csvText);
                
                if (parsedData && parsedData.length > 0) {
                    // LocalStorage'a JSON formatÄ±nda kaydet
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(parsedData));
                    localStorage.setItem(LOADED_FLAG, 'true'); // YÃ¼kleme bayraÄŸÄ±nÄ± set et
                    console.log(`âœ… ${parsedData.length} kayÄ±t localStorage'a kaydedildi (sofData_2025)`);
                    
                    // Data SDK'ya yÃ¼kle
                    await loadDataToSDK(parsedData);
                    
                    hideLoading();
                    
                    // BaÅŸarÄ± bildirimi gÃ¶ster
                    if (isManual) {
                        showNotification('âœ… Veriler baÅŸarÄ±yla yeniden yÃ¼klendi ve kaydedildi. ArtÄ±k sistem offline Ã§alÄ±ÅŸÄ±yor.', 'success');
                    } else {
                        showNotification('âœ… Veriler baÅŸarÄ±yla kaydedildi. ArtÄ±k sistem offline Ã§alÄ±ÅŸÄ±yor.', 'success');
                    }
                    
                    return true;
                } else {
                    throw new Error('CSV verisi ayrÄ±ÅŸtÄ±rÄ±lamadÄ± veya boÅŸ');
                }
                
            } catch (error) {
                hideLoading();
                console.error('CSV yÃ¼kleme hatasÄ±:', error);
                showNotification('âŒ CSV verisi alÄ±namadÄ± veya biÃ§imi hatalÄ±.', 'error');
                return false;
            }
        }

        // Manuel CSV yeniden yÃ¼kleme fonksiyonu
        async function reloadFromGitHub() {
            if (!hasPermission('canManageSystem')) {
                showNotification('Bu iÅŸlem iÃ§in yetkiniz bulunmuyor.', 'error');
                return;
            }
            
            showConfirmModal(
                'Verileri Yeniden YÃ¼kle',
                'Mevcut veriler sÄ±fÄ±rlanacak ve GitHub CSV\'den tekrar Ã§ekilecek. Bu iÅŸlem geri alÄ±namaz. Emin misiniz?',
                async () => {
                    try {
                        // Mevcut verileri yedekle
                        if (currentData.length > 0) {
                            localStorage.setItem(BACKUP_KEY, JSON.stringify(currentData));
                            console.log('Mevcut veriler yedeklendi');
                        }
                        
                        showLoading();
                        
                        // 1. LocalStorage'daki verileri ve yÃ¼kleme bayraÄŸÄ±nÄ± sil
                        localStorage.removeItem(STORAGE_KEY);
                        localStorage.removeItem(LOADED_FLAG);
                        console.log('âœ… LocalStorage temizlendi (sofData_2025 + yÃ¼kleme bayraÄŸÄ±)');
                        
                        // 2. Mevcut Data SDK verilerini temizle
                        console.log('ğŸ—‘ï¸ Mevcut Data SDK verileri temizleniyor...');
                        for (const record of currentData) {
                            await window.dataSdk.delete(record);
                        }
                        
                        hideLoading();
                        
                        // 3. GitHub CSV'den verileri tekrar Ã§ek ve localStorage'a kaydet
                        console.log('ğŸ”„ GitHub CSV\'den veriler yeniden Ã§ekiliyor...');
                        await loadFromGitHubCSV(true);
                        
                    } catch (error) {
                        hideLoading();
                        console.error('Yeniden yÃ¼kleme hatasÄ±:', error);
                        showNotification('Veriler yeniden yÃ¼klenirken hata oluÅŸtu.', 'error');
                    }
                }
            );
        }

        // BaÅŸlÄ±k normalizasyon fonksiyonu - TÃ¼rkÃ§e karakterleri ve boÅŸluklarÄ± temizler
        function normalizeHeader(header) {
            return header
                .toUpperCase()
                .replace(/[Ä°I]/g, "I")
                .replace(/Å/g, "S")
                .replace(/Ä/g, "G")
                .replace(/Ãœ/g, "U")
                .replace(/Ã–/g, "O")
                .replace(/Ã‡/g, "C")
                .replace(/["']/g, "")
                .replace(/\s+/g, "")
                .trim();
        }

        // CSV'yi parse edip veri dizisi dÃ¶ndÃ¼ren fonksiyon - GeliÅŸmiÅŸ Adres EÅŸleÅŸtirme
        async function parseCSVToData(csvText) {
            // UTF-8 BOM karakterini temizle
            const cleanedText = csvText.replace(/^\uFEFF/, '');
            
            // CSV'yi satÄ±rlara bÃ¶l
            const lines = cleanedText.split('\n');
            
            // BoÅŸ satÄ±rlarÄ± ve sadece noktalÄ± virgÃ¼l iÃ§eren satÄ±rlarÄ± filtrele
            const validLines = lines.filter(line => {
                const trimmed = line.trim();
                return trimmed !== '' && trimmed !== ';' && !trimmed.match(/^;+$/);
            });
            
            if (validLines.length < 2) {
                throw new Error('CSV dosyasÄ± geÃ§ersiz veya boÅŸ');
            }
            
            // CSV'yi ayrÄ±ÅŸtÄ±r - hem noktalÄ± virgÃ¼l hem virgÃ¼l desteÄŸi
            const rows = validLines.map(line => {
                // Ã–nce noktalÄ± virgÃ¼l dene, yoksa virgÃ¼l kullan
                let cells;
                if (line.includes(';')) {
                    cells = line.split(';');
                } else {
                    cells = line.split(',');
                }
                
                return cells.map(cell => {
                    if (!cell) return '';
                    // TÄ±rnak iÅŸaretlerini temizle ve trim yap
                    return cell.trim().replace(/^["']|["']$/g, '');
                });
            });

            // BaÅŸlÄ±klarÄ± al ve normalize et
            const headers = rows[0].map(h => h.trim());
            const normalizedHeaders = headers.map(normalizeHeader);
            
            console.log('CSV BaÅŸlÄ±klarÄ±:', headers);
            console.log('Normalize BaÅŸlÄ±klar:', normalizedHeaders);

            // KapsamlÄ± baÅŸlÄ±k eÅŸleÅŸtirme haritasÄ± - TÃ¼m olasÄ± varyasyonlar
            const headerMap = {
                // SÄ±ra No varyasyonlarÄ±
                'SIRANO': 'SIRA_NO',
                'SIRA': 'SIRA_NO',
                'NO': 'SIRA_NO',
                'SATIRNO': 'SIRA_NO',
                'ROWNO': 'SIRA_NO',
                
                // STF Talep No varyasyonlarÄ±
                'STFTALEPNO': 'STF_TALEP_NO',
                'STFNO': 'STF_TALEP_NO',
                'TALEPNO': 'STF_TALEP_NO',
                'STFNUMARASI': 'STF_TALEP_NO',
                'STFKODU': 'STF_TALEP_NO',
                
                // SOF Form No varyasyonlarÄ±
                'SOFFORMNO': 'SOF_FORM_NO',
                'SOFNO': 'SOF_FORM_NO',
                'FORMNO': 'SOF_FORM_NO',
                'SOFNUMARASI': 'SOF_FORM_NO',
                'SOFKODU': 'SOF_FORM_NO',
                
                // Malzeme Tipi varyasyonlarÄ±
                'MALZEMETIPI': 'MALZEME_TIPI',
                'MALZEMETIP': 'MALZEME_TIPI',
                'TIP': 'MALZEME_TIPI',
                'TIPI': 'MALZEME_TIPI',
                'KATEGORI': 'MALZEME_TIPI',
                'TYPE': 'MALZEME_TIPI',
                
                // Talep Eden varyasyonlarÄ±
                'TALEPEDEN': 'TALEP_EDEN',
                'TALEBIYAPAN': 'TALEP_EDEN',
                'ISTEKYAPAN': 'TALEP_EDEN',
                'TALEPSAHIBI': 'TALEP_EDEN',
                'ISTEKCI': 'TALEP_EDEN',
                'REQUESTER': 'TALEP_EDEN',
                'REQUESTEDBY': 'TALEP_EDEN',
                
                // Talep Tarihi varyasyonlarÄ±
                'TALEPTARIHI': 'TALEP_TARIHI',
                'TARIH': 'TALEP_TARIHI',
                'TALEPDATE': 'TALEP_TARIHI',
                'REQUESTDATE': 'TALEP_TARIHI',
                'DATE': 'TALEP_TARIHI',
                'BASVURUTARIHI': 'TALEP_TARIHI',
                
                // Ä°stenen Teslim Tarihi varyasyonlarÄ±
                'ISTENENTESLIMTARIHI': 'ISTENEN_TESLIM_TARIHI',
                'TESLIMTARIHI': 'ISTENEN_TESLIM_TARIHI',
                'ISTENENDATE': 'ISTENEN_TESLIM_TARIHI',
                'DELIVERYDATE': 'ISTENEN_TESLIM_TARIHI',
                'TARGETDATE': 'ISTENEN_TESLIM_TARIHI',
                'HEDEFDATE': 'ISTENEN_TESLIM_TARIHI',
                
                // Teslimat Durumu varyasyonlarÄ±
                'TESLIMATDURUMU': 'TESLIMAT_DURUMU',
                'DURUM': 'TESLIMAT_DURUMU',
                'STATUS': 'TESLIMAT_DURUMU',
                'DELIVERYSTATUS': 'TESLIMAT_DURUMU',
                'TESLIMDURUM': 'TESLIMAT_DURUMU',
                
                // Talep Edilen Malzeme varyasyonlarÄ±
                'TALEPEDILENMALZEME': 'TALEP_EDILEN_MALZEME',
                'MALZEME': 'TALEP_EDILEN_MALZEME',
                'MATERIAL': 'TALEP_EDILEN_MALZEME',
                'ITEM': 'TALEP_EDILEN_MALZEME',
                'PRODUCT': 'TALEP_EDILEN_MALZEME',
                'URUN': 'TALEP_EDILEN_MALZEME',
                'MALZEMEADI': 'TALEP_EDILEN_MALZEME',
                'ITEMNAME': 'TALEP_EDILEN_MALZEME',
                
                // Detay 1 varyasyonlarÄ±
                'DETAY1(MARKA,MODELVB)': 'DETAY_1',
                'DETAY1': 'DETAY_1',
                'MARKA': 'DETAY_1',
                'MODEL': 'DETAY_1',
                'BRAND': 'DETAY_1',
                'MARKAMODEL': 'DETAY_1',
                'OZELLIK1': 'DETAY_1',
                'SPEC1': 'DETAY_1',
                
                // Detay 2 varyasyonlarÄ±
                'DETAY2(PROJE,STANDARTVBKODLAR)': 'DETAY_2',
                'DETAY2': 'DETAY_2',
                'PROJE': 'DETAY_2',
                'PROJECT': 'DETAY_2',
                'STANDART': 'DETAY_2',
                'STANDARD': 'DETAY_2',
                'KOD': 'DETAY_2',
                'CODE': 'DETAY_2',
                'OZELLIK2': 'DETAY_2',
                'SPEC2': 'DETAY_2',
                
                // Birim varyasyonlarÄ±
                'BIRIM': 'BIRIM',
                'UNIT': 'BIRIM',
                'OLCUBIRIMI': 'BIRIM',
                'MEASUREUNIT': 'BIRIM',
                
                // Talep MiktarÄ± varyasyonlarÄ±
                'TALEPMIKTARI': 'TALEP_MIKTARI',
                'MIKTAR': 'TALEP_MIKTARI',
                'QUANTITY': 'TALEP_MIKTARI',
                'QTY': 'TALEP_MIKTARI',
                'AMOUNT': 'TALEP_MIKTARI',
                'REQUESTEDQTY': 'TALEP_MIKTARI',
                
                // SipariÅŸ MiktarÄ± varyasyonlarÄ±
                'SIPARISMIKTARI': 'SIPARIS_MIKTARI',
                'SIPARISMIKTAR': 'SIPARIS_MIKTARI',
                'ORDERQTY': 'SIPARIS_MIKTARI',
                'ORDEREDQTY': 'SIPARIS_MIKTARI',
                'SIPARISEDILEN': 'SIPARIS_MIKTARI',
                
                // Birim Fiyat varyasyonlarÄ±
                'BIRIMFIYAT(â‚½RUB)': 'BIRIM_FIYAT',
                'BIRIMFIYAT': 'BIRIM_FIYAT',
                'UNITPRICE': 'BIRIM_FIYAT',
                'PRICE': 'BIRIM_FIYAT',
                'FIYAT': 'BIRIM_FIYAT',
                'BIRIMFIYATRUB': 'BIRIM_FIYAT',
                'BIRIMFIYATâ‚½': 'BIRIM_FIYAT',
                
                // Toplam Fiyat varyasyonlarÄ±
                'TOPLAMFIYAT(â‚½RUB)': 'TOPLAM_FIYAT',
                'TOPLAMFIYAT': 'TOPLAM_FIYAT',
                'TOTALPRICE': 'TOPLAM_FIYAT',
                'TOTAL': 'TOPLAM_FIYAT',
                'TOPLAM': 'TOPLAM_FIYAT',
                'TOPLAMFIYATRUB': 'TOPLAM_FIYAT',
                'TOPLAMFIYATâ‚½': 'TOPLAM_FIYAT',
                
                // TedarikÃ§i varyasyonlarÄ±
                'TEDARIKCI': 'TEDARIKCI',
                'SUPPLIER': 'TEDARIKCI',
                'VENDOR': 'TEDARIKCI',
                'SATICI': 'TEDARIKCI',
                'FIRMA': 'TEDARIKCI',
                'COMPANY': 'TEDARIKCI',
                
                // SatÄ±nalma Sorumlusu varyasyonlarÄ±
                'SATINALMASORUMLUSU': 'SATINALMA_SORUMLUSU',
                'SORUMLU': 'SATINALMA_SORUMLUSU',
                'RESPONSIBLE': 'SATINALMA_SORUMLUSU',
                'PURCHASER': 'SATINALMA_SORUMLUSU',
                'BUYER': 'SATINALMA_SORUMLUSU',
                'SATINALMA': 'SATINALMA_SORUMLUSU',
                
                // Planlanan Teslim Tarihi varyasyonlarÄ±
                'PLANLANANTESLIMTARIHI': 'PLANLANAN_TESLIM_TARIHI',
                'PLANLANANTESLIM': 'PLANLANAN_TESLIM_TARIHI',
                'PLANNEDDELIVERY': 'PLANLANAN_TESLIM_TARIHI',
                'PLANDATE': 'PLANLANAN_TESLIM_TARIHI',
                'PLANLANANTARIH': 'PLANLANAN_TESLIM_TARIHI',
                
                // Teslimat MiktarÄ± varyasyonlarÄ±
                'TESLIMATMIKTARI': 'TESLIMAT_MIKTARI',
                'TESLIMEDILEN': 'TESLIMAT_MIKTARI',
                'DELIVEREDQTY': 'TESLIMAT_MIKTARI',
                'DELIVERED': 'TESLIMAT_MIKTARI',
                'TESLIMMIKTAR': 'TESLIMAT_MIKTARI',
                
                // Teslimat Tarihi varyasyonlarÄ±
                'TESLIMATTARIHI': 'TESLIMAT_TARIHI',
                'ACTUALDELIVERY': 'TESLIMAT_TARIHI',
                'DELIVERYDATE': 'TESLIMAT_TARIHI',
                'TESLIMDATE': 'TESLIMAT_TARIHI',
                'GERCEKTESLIM': 'TESLIMAT_TARIHI',
                
                // Kalan Miktar varyasyonlarÄ±
                'KALANMIKTAR': 'KALAN_MIKTAR',
                'KALAN': 'KALAN_MIKTAR',
                'REMAINING': 'KALAN_MIKTAR',
                'REMAININGQTY': 'KALAN_MIKTAR',
                'BALANCE': 'KALAN_MIKTAR',
                
                // Onay Durumu varyasyonlarÄ±
                'ONAYDURUMU': 'ONAY_DURUMU',
                'ONAY': 'ONAY_DURUMU',
                'APPROVAL': 'ONAY_DURUMU',
                'APPROVALSTATUS': 'ONAY_DURUMU',
                'STATUS': 'ONAY_DURUMU',
                'ONAYDURUM': 'ONAY_DURUMU',
                
                // AÃ§Ä±klama varyasyonlarÄ±
                'ACIKLAMA': 'ACIKLAMA',
                'DESCRIPTION': 'ACIKLAMA',
                'NOTE': 'ACIKLAMA',
                'NOTES': 'ACIKLAMA',
                'COMMENT': 'ACIKLAMA',
                'COMMENTS': 'ACIKLAMA',
                'NOTLAR': 'ACIKLAMA',
                'YORUM': 'ACIKLAMA'
            };

            // Normalize edilmiÅŸ baÅŸlÄ±k indekslerini bul
            const indexes = {};
            const foundHeaders = [];
            
            for (const [normalizedKey, targetField] of Object.entries(headerMap)) {
                const index = normalizedHeaders.indexOf(normalizedKey);
                if (index !== -1) {
                    indexes[targetField] = index;
                    foundHeaders.push(`${headers[index]} -> ${targetField}`);
                }
            }

            console.log('Bulunan baÅŸlÄ±k eÅŸleÅŸtirmeleri:', foundHeaders);
            console.log('Toplam eÅŸleÅŸtirme sayÄ±sÄ±:', Object.keys(indexes).length);

            // En az birkaÃ§ temel alan bulunmalÄ±
            const requiredFields = ['SIRA_NO', 'TALEP_EDILEN_MALZEME', 'TALEP_MIKTARI'];
            const foundRequiredFields = requiredFields.filter(field => indexes[field] !== undefined);
            
            if (foundRequiredFields.length === 0) {
                console.warn('Temel alanlar bulunamadÄ±, alternatif eÅŸleÅŸtirme deneniyor...');
                
                // Alternatif eÅŸleÅŸtirme - sÃ¼tun pozisyonuna gÃ¶re
                const alternativeMapping = {
                    0: 'SIRA_NO',
                    1: 'STF_TALEP_NO',
                    2: 'SOF_FORM_NO',
                    3: 'MALZEME_TIPI',
                    4: 'TALEP_EDEN',
                    5: 'TALEP_TARIHI',
                    6: 'ISTENEN_TESLIM_TARIHI',
                    7: 'TESLIMAT_DURUMU',
                    8: 'TALEP_EDILEN_MALZEME',
                    9: 'DETAY_1',
                    10: 'DETAY_2',
                    11: 'BIRIM',
                    12: 'TALEP_MIKTARI',
                    13: 'SIPARIS_MIKTARI',
                    14: 'BIRIM_FIYAT',
                    15: 'TOPLAM_FIYAT',
                    16: 'TEDARIKCI',
                    17: 'SATINALMA_SORUMLUSU',
                    18: 'PLANLANAN_TESLIM_TARIHI',
                    19: 'TESLIMAT_MIKTARI',
                    20: 'TESLIMAT_TARIHI',
                    21: 'KALAN_MIKTAR',
                    22: 'ONAY_DURUMU',
                    23: 'ACIKLAMA'
                };
                
                // Alternatif eÅŸleÅŸtirmeyi uygula
                for (const [colIndex, fieldName] of Object.entries(alternativeMapping)) {
                    const index = parseInt(colIndex);
                    if (index < headers.length && !indexes[fieldName]) {
                        indexes[fieldName] = index;
                        console.log(`Alternatif eÅŸleÅŸtirme: SÃ¼tun ${index} (${headers[index]}) -> ${fieldName}`);
                    }
                }
            }

            if (Object.keys(indexes).length === 0) {
                throw new Error('HiÃ§bir geÃ§erli baÅŸlÄ±k eÅŸleÅŸtirilemedi');
            }

            // Veri satÄ±rlarÄ±nÄ± iÅŸle
            const dataRows = rows.slice(1);
            const processedRows = [];
            
            console.log(`${dataRows.length} veri satÄ±rÄ± iÅŸleniyor...`);
            
            for (let i = 0; i < dataRows.length; i++) {
                const row = dataRows[i];
                
                // BoÅŸ satÄ±rlarÄ± atla
                if (!row || row.length === 0 || row.every(cell => !cell || cell.trim() === '')) {
                    continue;
                }
                
                // SatÄ±r verilerini hazÄ±rla
                const rowData = {};
                for (const [fieldName, columnIndex] of Object.entries(indexes)) {
                    if (columnIndex !== undefined && row[columnIndex] !== undefined) {
                        const cellValue = row[columnIndex];
                        rowData[fieldName] = cellValue ? cellValue.toString().trim() : '';
                    } else {
                        rowData[fieldName] = '';
                    }
                }
                
                // En az bir anlamlÄ± veri varsa iÅŸle
                const hasData = Object.values(rowData).some(value => value && value.trim() !== '');
                if (hasData) {
                    rowData.ORIGINAL_INDEX = i;
                    processedRows.push(rowData);
                }
            }

            console.log(`${processedRows.length} geÃ§erli satÄ±r bulundu`);

            // STF TALEP NO'ya gÃ¶re grupla ve form numarasÄ± ata
            const groupedData = new Map();
            
            for (const rowData of processedRows) {
                const stfTalepNo = rowData.STF_TALEP_NO || rowData.SOF_FORM_NO || `AUTO_${Math.floor(Math.random() * 10000)}`;
                
                if (!groupedData.has(stfTalepNo)) {
                    groupedData.set(stfTalepNo, []);
                }
                
                groupedData.get(stfTalepNo).push(rowData);
            }

            console.log(`${groupedData.size} grup oluÅŸturuldu`);

            // Form numarasÄ± haritasÄ± oluÅŸtur
            let groupIndex = 1;
            const formNumberMap = new Map();
            
            for (const [stfTalepNo, groupRows] of groupedData) {
                if (groupRows.length === 0) continue;
                
                // Grubun ilk satÄ±rÄ±ndan malzeme tipini al
                const firstRow = groupRows[0];
                const malzemeTipi = firstRow.MALZEME_TIPI || 'SARF';
                
                // Bu grup iÃ§in form numarasÄ± oluÅŸtur
                const formNumber = generateFormNumber(groupIndex, malzemeTipi);
                formNumberMap.set(stfTalepNo, formNumber);
                
                groupIndex++;
            }

            // Final veri dizisini oluÅŸtur
            const finalData = [];
            let siraNo = 1;
            
            // SatÄ±rlarÄ± orijinal sÄ±raya gÃ¶re sÄ±rala
            processedRows.sort((a, b) => a.ORIGINAL_INDEX - b.ORIGINAL_INDEX);
            
            for (const rowData of processedRows) {
                const stfTalepNo = rowData.STF_TALEP_NO || rowData.SOF_FORM_NO || `AUTO_${Math.floor(Math.random() * 10000)}`;
                const assignedFormNumber = formNumberMap.get(stfTalepNo);
                
                const record = createRecordFromRowData(rowData, assignedFormNumber, siraNo++);
                finalData.push(record);
            }
            
            console.log(`âœ… CSV baÅŸarÄ±yla ayrÄ±ÅŸtÄ±rÄ±ldÄ±: ${finalData.length} kayÄ±t hazÄ±rlandÄ±`);
            console.log('Ä°lk 3 kayÄ±t Ã¶rneÄŸi:', finalData.slice(0, 3));
            
            return finalData;
        }

        // SatÄ±r verisinden kayÄ±t objesi oluÅŸturan fonksiyon - GeliÅŸmiÅŸ Alan EÅŸleÅŸtirme
        function createRecordFromRowData(rowData, assignedFormNumber, siraNo) {
            // Malzeme tipini belirle - Ã§oklu kaynak kontrolÃ¼
            const malzemeTipi = rowData.MALZEME_TIPI || rowData.MALZEME_TIP || rowData.TIP || rowData.KATEGORI || 'SARF';
            
            // Tarih kontrolÃ¼ ve formatÄ± dÃ¼zeltme
            let talepTarihi = rowData.TALEP_TARIHI || rowData.TARIH || rowData.TALEPDATE || '';
            if (!talepTarihi || talepTarihi.trim() === '') {
                talepTarihi = getFormattedDate(0);
            }
            
            // Ä°stenen teslim tarihi - Ã§oklu kaynak kontrolÃ¼
            let istenenTeslimTarihi = rowData.ISTENEN_TESLIM_TARIHI || rowData.TESLIM_TARIHI || rowData.DELIVERYDATE || '';
            if (!istenenTeslimTarihi || istenenTeslimTarihi.trim() === '') {
                if (talepTarihi && talepTarihi.trim() !== '') {
                    // Tarih formatÄ±nÄ± parse et (DD.MM.YY veya DD/MM/YY veya DD-MM-YY)
                    const datePattern = /(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})/;
                    const match = talepTarihi.match(datePattern);
                    
                    if (match) {
                        const day = parseInt(match[1]);
                        const month = parseInt(match[2]) - 1;
                        let year = parseInt(match[3]);
                        
                        // 2 haneli yÄ±lÄ± 4 haneli yap
                        if (year < 100) {
                            year = year < 50 ? 2000 + year : 1900 + year;
                        }
                        
                        const talepDate = new Date(year, month, day);
                        talepDate.setDate(talepDate.getDate() + 7); // 7 gÃ¼n ekle
                        
                        const newDay = String(talepDate.getDate()).padStart(2, '0');
                        const newMonth = String(talepDate.getMonth() + 1).padStart(2, '0');
                        const newYear = String(talepDate.getFullYear()).slice(-2);
                        
                        istenenTeslimTarihi = `${newDay}.${newMonth}.${newYear}`;
                    }
                }
            }
            
            // SayÄ±sal deÄŸerleri gÃ¼venli parse etme fonksiyonu
            function safeParseFloat(value, defaultValue = 0) {
                if (!value) return defaultValue;
                const cleaned = value.toString().replace(/[^\d.,\-]/g, '').replace(',', '.');
                const parsed = parseFloat(cleaned);
                return isNaN(parsed) ? defaultValue : parsed;
            }
            
            // Yeni kayÄ±t oluÅŸtur - tÃ¼m olasÄ± alan adlarÄ±nÄ± kontrol et
            const newRecord = {
                sira_no: siraNo,
                sof_form_no: assignedFormNumber,
                malzeme_tipi: malzemeTipi,
                
                // Talep eden - Ã§oklu kaynak
                talep_eden: rowData.TALEP_EDEN || rowData.TALEBIYAPAN || rowData.ISTEKYAPAN || rowData.REQUESTER || '',
                
                // Tarihler
                talep_tarihi: talepTarihi,
                istenen_teslim_tarihi: istenenTeslimTarihi,
                
                // Teslimat durumu - baÅŸlangÄ±Ã§ta belirlenmedi
                teslimat_durumu: 'BELÄ°RLENMEDÄ°',
                
                // Malzeme bilgileri - Ã§oklu kaynak
                talep_edilen_malzeme: rowData.TALEP_EDILEN_MALZEME || rowData.MALZEME || rowData.MATERIAL || rowData.ITEM || rowData.PRODUCT || '',
                detay_1: rowData.DETAY_1 || rowData.DETAY1 || rowData.MARKA || rowData.MODEL || rowData.BRAND || '',
                detay_2: rowData.DETAY_2 || rowData.DETAY2 || rowData.PROJE || rowData.PROJECT || rowData.KOD || rowData.CODE || '',
                
                // Birim - Ã§oklu kaynak
                birim: rowData.BIRIM || rowData.UNIT || rowData.OLCUBIRIMI || 'ADET',
                
                // Miktarlar - gÃ¼venli parse
                talep_miktari: safeParseFloat(rowData.TALEP_MIKTARI || rowData.MIKTAR || rowData.QUANTITY || rowData.QTY),
                siparis_miktari: safeParseFloat(rowData.SIPARIS_MIKTARI || rowData.ORDERQTY || rowData.ORDEREDQTY),
                
                // Fiyatlar - gÃ¼venli parse
                birim_fiyat: safeParseFloat(rowData.BIRIM_FIYAT || rowData.UNITPRICE || rowData.PRICE || rowData.FIYAT),
                toplam_fiyat: safeParseFloat(rowData.TOPLAM_FIYAT || rowData.TOTALPRICE || rowData.TOTAL || rowData.TOPLAM),
                
                // TedarikÃ§i ve sorumlu - Ã§oklu kaynak
                tedarikci: rowData.TEDARIKCI || rowData.SUPPLIER || rowData.VENDOR || rowData.SATICI || rowData.FIRMA || '',
                satinalma_sorumlusu: rowData.SATINALMA_SORUMLUSU || rowData.SORUMLU || rowData.RESPONSIBLE || rowData.PURCHASER || rowData.BUYER || '',
                
                // Planlanan teslim tarihi - Ã§oklu kaynak
                planlanan_teslim_tarihi: rowData.PLANLANAN_TESLIM_TARIHI || rowData.PLANLANANTESLIM || rowData.PLANNEDDELIVERY || rowData.PLANDATE || '',
                
                // Teslimat bilgileri - Ã§oklu kaynak
                teslimat_miktari: safeParseFloat(rowData.TESLIMAT_MIKTARI || rowData.TESLIMEDILEN || rowData.DELIVEREDQTY || rowData.DELIVERED),
                teslimat_tarihi: rowData.TESLIMAT_TARIHI || rowData.ACTUALDELIVERY || rowData.TESLIMDATE || rowData.GERCEKTESLIM || '',
                
                // Kalan miktar - Ã§oklu kaynak
                kalan_miktar: safeParseFloat(rowData.KALAN_MIKTAR || rowData.KALAN || rowData.REMAINING || rowData.REMAININGQTY || rowData.BALANCE),
                
                // Onay durumu - Ã§oklu kaynak
                onay_durumu: rowData.ONAY_DURUMU || rowData.ONAY || rowData.APPROVAL || rowData.APPROVALSTATUS || 'BEKLEMEDE',
                
                // AÃ§Ä±klama - Ã§oklu kaynak
                aciklama: rowData.ACIKLAMA || rowData.DESCRIPTION || rowData.NOTE || rowData.NOTES || rowData.COMMENT || rowData.YORUM || '',
                
                // CSV'den geldiÄŸini iÅŸaretle
                is_from_csv: true
            };
            
            // EÄŸer CSV'de toplam fiyat yoksa veya 0 ise otomatik hesapla
            if ((!newRecord.toplam_fiyat || newRecord.toplam_fiyat === 0) && newRecord.talep_miktari && newRecord.birim_fiyat) {
                newRecord.toplam_fiyat = newRecord.talep_miktari * newRecord.birim_fiyat;
            }
            
            // Onay durumu normalizasyonu
            const onayDurumu = newRecord.onay_durumu.toUpperCase();
            if (onayDurumu.includes('BEKLE') || onayDurumu.includes('WAIT') || onayDurumu.includes('PENDING')) {
                newRecord.onay_durumu = 'BEKLEMEDE';
            } else if (onayDurumu.includes('ONAY') && !onayDurumu.includes('BEK')) {
                newRecord.onay_durumu = 'ONAYLANDI';
            } else if (onayDurumu.includes('RED') || onayDurumu.includes('REJECT')) {
                newRecord.onay_durumu = 'RED EDÄ°LDÄ°';
            } else if (onayDurumu.includes('TAMAM') || onayDurumu.includes('COMPLETE')) {
                newRecord.onay_durumu = 'TAMAMLANDI';
            } else if (onayDurumu.includes('Ã–DEME') || onayDurumu.includes('PAYMENT')) {
                newRecord.onay_durumu = 'Ã–DEME BEKLÄ°YOR';
            }
            
            // Malzeme tipi normalizasyonu
            const malzemeTipiUpper = newRecord.malzeme_tipi.toUpperCase();
            if (malzemeTipiUpper.includes('SARF') || malzemeTipiUpper.includes('CONSUMABLE')) {
                newRecord.malzeme_tipi = 'SARF';
            } else if (malzemeTipiUpper.includes('DEMÄ°RBAÅ') || malzemeTipiUpper.includes('DEMIRBAS') || malzemeTipiUpper.includes('FIXED') || malzemeTipiUpper.includes('ASSET')) {
                newRecord.malzeme_tipi = 'DEMÄ°RBAÅ';
            }
            
            // Birim normalizasyonu
            const birimUpper = newRecord.birim.toUpperCase();
            const birimMap = {
                'ADET': 'ADET', 'PIECE': 'ADET', 'PCS': 'ADET', 'EA': 'ADET',
                'KG': 'KG', 'KILOGRAM': 'KG', 'KILO': 'KG',
                'LT': 'LT', 'LITRE': 'LT', 'LITER': 'LT', 'L': 'LT',
                'METRE': 'METRE', 'METER': 'METRE', 'M': 'METRE',
                'M2': 'M2', 'METREKARE': 'M2', 'SQM': 'M2',
                'M3': 'M3', 'METREKÃœP': 'M3', 'CBM': 'M3',
                'SET': 'SET', 'TAKIM': 'SET',
                'PAKET': 'PAKET', 'PACKAGE': 'PAKET', 'PKG': 'PAKET',
                'KUTU': 'KUTU', 'BOX': 'KUTU'
            };
            
            for (const [key, value] of Object.entries(birimMap)) {
                if (birimUpper.includes(key)) {
                    newRecord.birim = value;
                    break;
                }
            }
            
            // Teslimat tarihi kontrolÃ¼ ile onay durumu gÃ¼ncelle
            updateApprovalStatus(newRecord);
            
            // Teslimat durumunu hesapla
            updateDeliveryStatus(newRecord);
            
            return newRecord;
        }

        // Veri dizisini Data SDK'ya yÃ¼kleyen fonksiyon
        async function loadDataToSDK(dataArray) {
            console.log(`${dataArray.length} kayÄ±t Data SDK'ya yÃ¼kleniyor...`);
            
            for (const record of dataArray) {
                // __backendId'yi kaldÄ±r Ã§Ã¼nkÃ¼ create iÅŸlemi iÃ§in gerekli deÄŸil
                const { __backendId, ...recordWithoutId } = record;
                const result = await window.dataSdk.create(recordWithoutId);
                if (!result.isOk) {
                    console.error('KayÄ±t Data SDK\'ya eklenirken hata:', result.error);
                }
            }
            
            console.log('TÃ¼m kayÄ±tlar Data SDK\'ya yÃ¼klendi');
        }

        // SatÄ±r ekleme fonksiyonu - form numarasÄ± ile birlikte
        async function addRowToTableWithFormNumber(rowData, assignedFormNumber) {
            // Malzeme tipini belirle
            const malzemeTipi = rowData.MALZEME_TIPI || 'SARF';
            
            // ğŸ”„ Eksik alanlarÄ± otomatik doldur
            // 1ï¸âƒ£ TALEP EDEN kontrolÃ¼ - boÅŸsa boÅŸ bÄ±rak
            let talepEden = rowData.TALEP_EDEN || '';
            
            // 2ï¸âƒ£ TALEP TARÄ°HÄ° kontrolÃ¼ - CSV'den gelen deÄŸer aynen korunur
            let talepTarihi = rowData.TALEP_TARIHI;
            if (!talepTarihi || talepTarihi.trim() === '') {
                // CSV'de tarih yoksa bugÃ¼nÃ¼n tarihini kullan
                talepTarihi = getFormattedDate(0);
            }
            
            // 3ï¸âƒ£ Ä°STENEN TESLÄ°M TARÄ°HÄ° kontrolÃ¼ - CSV'den gelen deÄŸer korunur
            let istenenTeslimTarihi = rowData.TESLIM_TARIHI || '';
            
            // 4ï¸âƒ£ EÄŸer Ä°STENEN TESLÄ°M TARÄ°HÄ° boÅŸsa, TALEP TARÄ°HÄ° + 7 gÃ¼n hesapla
            if (!istenenTeslimTarihi || istenenTeslimTarihi.trim() === '') {
                if (talepTarihi && talepTarihi.trim() !== '') {
                    // Talep tarihini parse et ve 7 gÃ¼n ekle
                    const talepDateParts = talepTarihi.split('.');
                    if (talepDateParts.length === 3) {
                        const day = parseInt(talepDateParts[0]);
                        const month = parseInt(talepDateParts[1]) - 1; // JavaScript aylarÄ± 0-11
                        const year = parseInt('20' + talepDateParts[2]); // YY -> YYYY
                        
                        const talepDate = new Date(year, month, day);
                        talepDate.setDate(talepDate.getDate() + 7); // 7 gÃ¼n ekle
                        
                        const newDay = String(talepDate.getDate()).padStart(2, '0');
                        const newMonth = String(talepDate.getMonth() + 1).padStart(2, '0');
                        const newYear = String(talepDate.getFullYear()).slice(-2);
                        
                        istenenTeslimTarihi = `${newDay}.${newMonth}.${newYear}`;
                    }
                }
            }
            
            // Yeni kayÄ±t oluÅŸtur
            const newRecord = {
                sira_no: parseInt(rowData.SIRA_NO) || nextSiraNo++,
                sof_form_no: assignedFormNumber, // Grup bazlÄ± atanan form numarasÄ±
                malzeme_tipi: malzemeTipi,
                talep_eden: talepEden,
                talep_tarihi: talepTarihi, // CSV'den aynen alÄ±nan tarih
                istenen_teslim_tarihi: istenenTeslimTarihi,
                teslimat_durumu: 'BELÄ°RLENMEDÄ°', // BaÅŸlangÄ±Ã§ta belirlenmedi, sonra hesaplanacak
                talep_edilen_malzeme: rowData.MALZEME || '',
                detay_1: rowData.DETAY1 || '',
                detay_2: rowData.DETAY2 || '',
                birim: rowData.BIRIM || 'ADET',
                talep_miktari: parseFloat(rowData.TALEP_MIKTARI) || 0,
                siparis_miktari: parseFloat(rowData.SIPARIS_MIKTARI) || 0,
                birim_fiyat: parseFloat(rowData.BIRIM_FIYAT) || 0,
                toplam_fiyat: parseFloat(rowData.TOPLAM_FIYAT) || 0, // CSV'den gelen deÄŸer kullanÄ±lÄ±r
                tedarikci: rowData.TEDARIKCI || '',
                satinalma_sorumlusu: rowData.SATINALMA_SORUMLUSU || '',
                planlanan_teslim_tarihi: rowData.PLANLANAN_TESLIM || '',
                teslimat_miktari: parseFloat(rowData.TESLIMAT_MIKTARI) || 0,
                teslimat_tarihi: rowData.TESLIMAT_TARIHI || '',
                kalan_miktar: parseFloat(rowData.KALAN_MIKTAR) || 0,
                onay_durumu: rowData.ONAY || 'BEKLEMEDE',
                aciklama: rowData.ACIKLAMA || '',
                is_from_csv: true // CSV'den geldiÄŸini iÅŸaretle
            };
            
            // EÄŸer CSV'de toplam fiyat yoksa otomatik hesapla: TOPLAM FÄ°YAT = TALEP MÄ°KTARI Ã— BÄ°RÄ°M FÄ°YAT
            if (!newRecord.toplam_fiyat && newRecord.talep_miktari && newRecord.birim_fiyat) {
                newRecord.toplam_fiyat = newRecord.talep_miktari * newRecord.birim_fiyat;
            }
            
            // Teslimat tarihi kontrolÃ¼ ile onay durumu gÃ¼ncelle
            updateApprovalStatus(newRecord);
            
            // Teslimat durumunu hesapla
            updateDeliveryStatus(newRecord);
            
            // Data SDK'ya kaydet
            const result = await window.dataSdk.create(newRecord);
            if (!result.isOk) {
                console.error('KayÄ±t eklenirken hata:', result.error);
            }
        }

        // Eski satÄ±r ekleme fonksiyonu - geriye dÃ¶nÃ¼k uyumluluk iÃ§in
        async function addRowToTable(rowData, rowIndex) {
            // Malzeme tipini belirle
            const malzemeTipi = rowData.MALZEME_TIPI || 'SARF';
            
            // Form numarasÄ± kontrolÃ¼ - boÅŸsa otomatik oluÅŸtur
            let formNo = rowData.SOF_FORM_NO;
            if (!formNo || formNo.trim() === '') {
                const newIndex = currentData.length + 1;
                formNo = generateFormNumber(newIndex, malzemeTipi);
            }
            
            await addRowToTableWithFormNumber(rowData, formNo);
        }

        // Bildirim gÃ¶sterme fonksiyonu
        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            
            // Mevcut bildirimleri temizle
            notificationArea.innerHTML = '';
            
            const notification = document.createElement('div');
            
            // Tailwind sÄ±nÄ±flarÄ±nÄ± type'a gÃ¶re ayarla
            let classes = 'p-2 rounded-md shadow-sm text-center transition-all duration-300 ';
            
            if (type === 'success') {
                classes += 'bg-green-100 text-green-800 border border-green-300';
            } else if (type === 'error') {
                classes += 'bg-red-100 text-red-800 border border-red-300';
            } else {
                classes += 'bg-blue-100 text-blue-800 border border-blue-300';
            }
            
            notification.className = classes;
            notification.textContent = message;
            
            notificationArea.appendChild(notification);
            
            // 3 saniye sonra otomatik kaybolma
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Event listeners
        document.getElementById('yeni-talep-btn').addEventListener('click', yeniTalepBaslat);
        document.getElementById('alt-satir-btn').addEventListener('click', altSatirEkle);
        document.getElementById('satir-sil-btn').addEventListener('click', satirSil);
        document.getElementById('pdf-btn').addEventListener('click', pdfIndir);
        document.getElementById('kaydet-btn').addEventListener('click', csvDÄ±saAktar);
        document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);
        document.getElementById('excel-btn').addEventListener('click', exportToExcel);


        // Toplu iÅŸlem event listeners
        document.getElementById('bulkEditBtn').addEventListener('click', openBulkEditModal);
        document.getElementById('bulkDeleteBtn').addEventListener('click', bulkDelete);
        document.getElementById('bulkApproveBtn').addEventListener('click', bulkApprove);
        document.getElementById('selectAllBtn').addEventListener('click', selectAllRows);
        document.getElementById('deselectAllBtn').addEventListener('click', deselectAllRows);

        // Modal event listeners
        document.getElementById('closeBulkEditModal').addEventListener('click', closeBulkEditModal);
        document.getElementById('cancelBulkEdit').addEventListener('click', closeBulkEditModal);
        document.getElementById('applyBulkEdit').addEventListener('click', applyBulkEdit);
        document.getElementById('cancelConfirm').addEventListener('click', closeConfirmModal);
        document.getElementById('confirmAction').addEventListener('click', executeConfirmedAction);

        // Ayarlar modal event listeners
        document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
        document.getElementById('closeSettingsModal').addEventListener('click', closeSettingsModal);
        document.getElementById('cancelSettings').addEventListener('click', closeSettingsModal);
        document.getElementById('saveSettings').addEventListener('click', saveSettings);
        document.getElementById('resetFormNumberBtn').addEventListener('click', resetFormNumber);
        document.getElementById('settingsExportBtn').addEventListener('click', exportToCSV);
        document.getElementById('darkModeToggle').addEventListener('change', function(e) {
            darkModeEnabled = e.target.checked;
            localStorage.setItem("darkModeEnabled", darkModeEnabled.toString());
            applyDarkMode();
        });

        // Ana checkbox event listener
        document.getElementById('selectAllCheckbox').addEventListener('change', function(e) {
            if (e.target.checked) {
                selectAllRows();
            } else {
                deselectAllRows();
            }
        });

        // ğŸš€ Ultra hÄ±zlÄ± event listeners - debounced ve optimized
        document.addEventListener('DOMContentLoaded', function() {
            // Debounced arama - 300ms gecikme ile
            let searchTimeout;
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        searchTerm = e.target.value;
                        applyFiltersAndSearch();
                    }, 300);
                });
            }

            // HÄ±zlÄ± filtre deÄŸiÅŸimi
            const filterSelect = document.getElementById('filterSelect');
            if (filterSelect) {
                filterSelect.addEventListener('change', function(e) {
                    filterValue = e.target.value;
                    applyFiltersAndSearch();
                });
            }

            // Temizle butonu
            const clearBtn = document.getElementById('clearFiltersBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', clearFilters);
            }

            // Virtual scroll event listener
            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                let scrollTimeout;
                tableContainer.addEventListener('scroll', function(e) {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        const scrollTop = e.target.scrollTop;
                        const containerHeight = e.target.clientHeight;
                        
                        // Virtual scroll state gÃ¼ncelle
                        virtualScrollState.scrollTop = scrollTop;
                        virtualScrollState.startIndex = Math.floor(scrollTop / VIRTUAL_SCROLL.ITEM_HEIGHT);
                        virtualScrollState.endIndex = virtualScrollState.startIndex + Math.ceil(containerHeight / VIRTUAL_SCROLL.ITEM_HEIGHT);
                        
                        // BÃ¼yÃ¼k veri setleri iÃ§in virtual render
                        if (currentData.length > 100) {
                            renderTableVirtual();
                        }
                    }, 16); // 60fps
                });
            }

            // Optimized sÄ±ralama event listener
            document.addEventListener('click', function(e) {
                if (e.target.closest('.sortable')) {
                    const th = e.target.closest('.sortable');
                    const column = th.dataset.column;
                    
                    // SÄ±ralama yÃ¶nÃ¼nÃ¼ belirle
                    if (currentSortColumn === column) {
                        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSortColumn = column;
                        currentSortDirection = 'asc';
                    }
                    
                    // Batch DOM update
                    requestAnimationFrame(() => {
                        // TÃ¼m baÅŸlÄ±klarÄ±n sÄ±ralama sÄ±nÄ±flarÄ±nÄ± temizle
                        document.querySelectorAll('.sortable').forEach(header => {
                            header.classList.remove('sort-asc', 'sort-desc');
                            const icon = header.querySelector('.sort-icon');
                            if (icon) icon.textContent = 'â‡…';
                        });
                        
                        // Aktif baÅŸlÄ±ÄŸÄ± iÅŸaretle
                        th.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                        const icon = th.querySelector('.sort-icon');
                        if (icon) {
                            icon.textContent = currentSortDirection === 'asc' ? 'â–²' : 'â–¼';
                        }
                        
                        applyFiltersAndSearch();
                    });
                }
            });
        });

        // ğŸ”¹ SOMTECH SatÄ±n Alma YÃ¶netim Sistemi â€” Tek Seferlik CSV Veri GÃ¶mme (Seed Data)
        // Bu kod GitHub'dan CSV'yi sadece 1 kez alÄ±r, localStorage'a kaydeder ve bir daha asla fetch etmez.
        
        // ğŸ”¥ KALICI VERÄ° GÃ–MME SÄ°STEMÄ° - SONSUZA DEK Ã‡ALIÅIR
        // Bu sistem veriyi sisteme kalÄ±cÄ± olarak gÃ¶mer ve bir daha asla dÄ±ÅŸ kaynaÄŸa gitmez
        
        // GÃ¶mÃ¼lÃ¼ veri - sistem iÃ§inde kalÄ±cÄ± olarak saklanÄ±r
        const EMBEDDED_DATA = [
            {
                sira_no: 1,
                sof_form_no: "RF100.SOFS-0001",
                malzeme_tipi: "SARF",
                talep_eden: "Ahmet YÄ±lmaz",
                talep_tarihi: "15.01.25",
                istenen_teslim_tarihi: "22.01.25",
                teslimat_durumu: "BEKLEMEDE",
                talep_edilen_malzeme: "Vida M8x20",
                detay_1: "Paslanmaz Ã‡elik",
                detay_2: "DIN 912",
                birim: "ADET",
                talep_miktari: 100,
                siparis_miktari: 100,
                birim_fiyat: 2.50,
                toplam_fiyat: 250.00,
                tedarikci: "Metal Tedarik A.Å.",
                satinalma_sorumlusu: "OÄŸuzhan KarslÄ±",
                planlanan_teslim_tarihi: "20.01.25",
                teslimat_miktari: 0,
                teslimat_tarihi: "",
                kalan_miktar: 100,
                onay_durumu: "ONAYLANDI",
                aciklama: "Acil ihtiyaÃ§",
                is_from_csv: true
            },
            {
                sira_no: 2,
                sof_form_no: "RF100.SOFS-0001",
                malzeme_tipi: "SARF",
                talep_eden: "Mehmet Demir",
                talep_tarihi: "15.01.25",
                istenen_teslim_tarihi: "22.01.25",
                teslimat_durumu: "BEKLEMEDE",
                talep_edilen_malzeme: "Somun M8",
                detay_1: "Paslanmaz Ã‡elik",
                detay_2: "DIN 934",
                birim: "ADET",
                talep_miktari: 100,
                siparis_miktari: 100,
                birim_fiyat: 1.25,
                toplam_fiyat: 125.00,
                tedarikci: "Metal Tedarik A.Å.",
                satinalma_sorumlusu: "OÄŸuzhan KarslÄ±",
                planlanan_teslim_tarihi: "20.01.25",
                teslimat_miktari: 0,
                teslimat_tarihi: "",
                kalan_miktar: 100,
                onay_durumu: "ONAYLANDI",
                aciklama: "Vida ile birlikte",
                is_from_csv: true
            },
            {
                sira_no: 3,
                sof_form_no: "RF100.SOFD-0002",
                malzeme_tipi: "DEMÄ°RBAÅ",
                talep_eden: "Fatma Kaya",
                talep_tarihi: "16.01.25",
                istenen_teslim_tarihi: "30.01.25",
                teslimat_durumu: "BEKLEMEDE",
                talep_edilen_malzeme: "EndÃ¼striyel Printer",
                detay_1: "HP LaserJet Pro",
                detay_2: "Ofis EkipmanÄ±",
                birim: "ADET",
                talep_miktari: 1,
                siparis_miktari: 1,
                birim_fiyat: 15000.00,
                toplam_fiyat: 15000.00,
                tedarikci: "Teknoloji DÃ¼nyasÄ± Ltd.",
                satinalma_sorumlusu: "Osman TalaÅŸ",
                planlanan_teslim_tarihi: "28.01.25",
                teslimat_miktari: 0,
                teslimat_tarihi: "",
                kalan_miktar: 1,
                onay_durumu: "ONAY BEKLÄ°YOR",
                aciklama: "Muhasebe departmanÄ± iÃ§in",
                is_from_csv: true
            },
            {
                sira_no: 4,
                sof_form_no: "RF100.SOFS-0003",
                malzeme_tipi: "SARF",
                talep_eden: "Ali Ã–zkan",
                talep_tarihi: "17.01.25",
                istenen_teslim_tarihi: "24.01.25",
                teslimat_durumu: "TAMAMLANDI",
                talep_edilen_malzeme: "Kaynak Elektrodu",
                detay_1: "E7018 3.2mm",
                detay_2: "Ãœretim HattÄ±",
                birim: "KG",
                talep_miktari: 25,
                siparis_miktari: 25,
                birim_fiyat: 45.00,
                toplam_fiyat: 1125.00,
                tedarikci: "Kaynak Malzemeleri San.",
                satinalma_sorumlusu: "OÄŸuzhan KarslÄ±",
                planlanan_teslim_tarihi: "22.01.25",
                teslimat_miktari: 25,
                teslimat_tarihi: "21.01.25",
                kalan_miktar: 0,
                onay_durumu: "TAMAMLANDI",
                aciklama: "Teslim edildi",
                is_from_csv: true
            },
            {
                sira_no: 5,
                sof_form_no: "RF100.SOFD-0004",
                malzeme_tipi: "DEMÄ°RBAÅ",
                talep_eden: "Zeynep AktaÅŸ",
                talep_tarihi: "18.01.25",
                istenen_teslim_tarihi: "15.02.25",
                teslimat_durumu: "BEKLEMEDE",
                talep_edilen_malzeme: "CNC Torna TezgahÄ±",
                detay_1: "Haas ST-10Y",
                detay_2: "Ãœretim YatÄ±rÄ±mÄ±",
                birim: "ADET",
                talep_miktari: 1,
                siparis_miktari: 1,
                birim_fiyat: 450000.00,
                toplam_fiyat: 450000.00,
                tedarikci: "Makine Teknolojileri A.Å.",
                satinalma_sorumlusu: "Mutlu DoÄŸan",
                planlanan_teslim_tarihi: "10.02.25",
                teslimat_miktari: 0,
                teslimat_tarihi: "",
                kalan_miktar: 1,
                onay_durumu: "Ã–DEME BEKLÄ°YOR",
                aciklama: "YÃ¶netim kurulu onayÄ± alÄ±ndÄ±",
                is_from_csv: true
            },
            {
                sira_no: 6,
                sof_form_no: "RF100.SOFS-0005",
                malzeme_tipi: "SARF",
                talep_eden: "Hasan Ã‡elik",
                talep_tarihi: "19.01.25",
                istenen_teslim_tarihi: "26.01.25",
                teslimat_durumu: "BEKLEMEDE",
                talep_edilen_malzeme: "Hidrolik YaÄŸ",
                detay_1: "Shell Tellus S2 M46",
                detay_2: "Makine BakÄ±mÄ±",
                birim: "LT",
                talep_miktari: 200,
                siparis_miktari: 200,
                birim_fiyat: 25.00,
                toplam_fiyat: 5000.00,
                tedarikci: "EndÃ¼striyel YaÄŸlar Ltd.",
                satinalma_sorumlusu: "OÄŸuzhan KarslÄ±",
                planlanan_teslim_tarihi: "25.01.25",
                teslimat_miktari: 0,
                teslimat_tarihi: "",
                kalan_miktar: 200,
                onay_durumu: "ONAYLANDI",
                aciklama: "Periyodik bakÄ±m iÃ§in",
                is_from_csv: true
            },
            {
                sira_no: 7,
                sof_form_no: "RF100.SOFS-0006",
                malzeme_tipi: "SARF",
                talep_eden: "AyÅŸe YÄ±ldÄ±z",
                talep_tarihi: "20.01.25",
                istenen_teslim_tarihi: "27.01.25",
                teslimat_durumu: "BEKLEMEDE",
                talep_edilen_malzeme: "Ofis KaÄŸÄ±dÄ±",
                detay_1: "A4 80gr",
                detay_2: "Ä°dari Ä°ÅŸler",
                birim: "PAKET",
                talep_miktari: 50,
                siparis_miktari: 50,
                birim_fiyat: 12.50,
                toplam_fiyat: 625.00,
                tedarikci: "Ofis Malzemeleri Paz.",
                satinalma_sorumlusu: "Osman TalaÅŸ",
                planlanan_teslim_tarihi: "26.01.25",
                teslimat_miktari: 0,
                teslimat_tarihi: "",
                kalan_miktar: 50,
                onay_durumu: "BEKLEMEDE",
                aciklama: "AylÄ±k ihtiyaÃ§",
                is_from_csv: true
            },
            {
                sira_no: 8,
                sof_form_no: "RF100.SOFD-0007",
                malzeme_tipi: "DEMÄ°RBAÅ",
                talep_eden: "Murat Åahin",
                talep_tarihi: "21.01.25",
                istenen_teslim_tarihi: "05.03.25",
                teslimat_durumu: "BEKLEMEDE",
                talep_edilen_malzeme: "Forklift",
                detay_1: "Toyota 8FBE20",
                detay_2: "Depo OperasyonlarÄ±",
                birim: "ADET",
                talep_miktari: 1,
                siparis_miktari: 1,
                birim_fiyat: 125000.00,
                toplam_fiyat: 125000.00,
                tedarikci: "Ä°ÅŸ Makineleri San. Tic.",
                satinalma_sorumlusu: "Mutlu DoÄŸan",
                planlanan_teslim_tarihi: "28.02.25",
                teslimat_miktari: 0,
                teslimat_tarihi: "",
                kalan_miktar: 1,
                onay_durumu: "ONAY BEKLÄ°YOR",
                aciklama: "Depo kapasitesi artÄ±rÄ±mÄ±",
                is_from_csv: true
            }
        ];

        // KalÄ±cÄ± veri yÃ¼kleme fonksiyonu - sistem iÃ§inde gÃ¶mÃ¼lÃ¼
        async function loadEmbeddedData() {
            console.log('ğŸ”¥ KalÄ±cÄ± gÃ¶mÃ¼lÃ¼ veri sistemi baÅŸlatÄ±lÄ±yor...');
            console.log(`ğŸ“¦ ${EMBEDDED_DATA.length} kayÄ±t sistem iÃ§inde gÃ¶mÃ¼lÃ¼ olarak bulundu`);
            
            showLoading();
            
            try {
                // GÃ¶mÃ¼lÃ¼ veriyi Data SDK'ya yÃ¼kle
                for (const record of EMBEDDED_DATA) {
                    // Teslimat durumunu gÃ¼ncelle
                    updateDeliveryStatus(record);
                    updateApprovalStatus(record);
                    
                    // __backendId'yi kaldÄ±r Ã§Ã¼nkÃ¼ create iÅŸlemi iÃ§in gerekli deÄŸil
                    const { __backendId, ...recordWithoutId } = record;
                    const result = await window.dataSdk.create(recordWithoutId);
                    if (!result.isOk) {
                        console.error('GÃ¶mÃ¼lÃ¼ veri yÃ¼klenirken hata:', result.error);
                    }
                }
                
                // KalÄ±cÄ± yÃ¼kleme bayraÄŸÄ±nÄ± set et
                localStorage.setItem(LOADED_FLAG, 'embedded_permanent');
                localStorage.setItem(STORAGE_KEY, JSON.stringify(EMBEDDED_DATA));
                
                hideLoading();
                showNotification('ğŸ”¥ KalÄ±cÄ± veri sistemi aktif! Veriler sonsuza dek gÃ¶mÃ¼lÃ¼.', 'success');
                
                console.log('âœ… KalÄ±cÄ± gÃ¶mÃ¼lÃ¼ veri baÅŸarÄ±yla yÃ¼klendi');
                console.log('ğŸ”’ Sistem artÄ±k tamamen baÄŸÄ±msÄ±z Ã§alÄ±ÅŸÄ±yor - dÄ±ÅŸ kaynak gereksiz');
                
                return true;
            } catch (error) {
                hideLoading();
                console.error('GÃ¶mÃ¼lÃ¼ veri yÃ¼kleme hatasÄ±:', error);
                showNotification('âŒ KalÄ±cÄ± veri yÃ¼klenirken hata oluÅŸtu.', 'error');
                return false;
            }
        }

        // Initialize
        window.addEventListener('load', async () => {
            // Dark mode'u uygula
            applyDarkMode();
            
            // Rol yetkilerini uygula
            applyRolePermissions();
            
            if (window.dataSdk) {
                const initResult = await window.dataSdk.init(dataHandler);
                if (!initResult.isOk) {
                    console.error('Data SDK baÅŸlatÄ±lamadÄ±:', initResult.error);
                    return;
                }
                
                // ğŸ”¥ KALICI GÃ–MÃœLÃœ VERÄ° SÄ°STEMÄ° - SONSUZA DEK Ã‡ALIÅIR
                console.log('ğŸ”¥ KalÄ±cÄ± gÃ¶mÃ¼lÃ¼ veri sistemi kontrol ediliyor...');
                
                // YÃ¼kleme bayraÄŸÄ±nÄ± kontrol et
                const isDataLoaded = localStorage.getItem(LOADED_FLAG);
                const localData = loadFromLocalStorage();
                
                if (isDataLoaded === 'embedded_permanent' && localData && localData.length > 0) {
                    // âœ… KalÄ±cÄ± veri zaten yÃ¼klÃ¼
                    console.log('âœ… KalÄ±cÄ± gÃ¶mÃ¼lÃ¼ veri zaten aktif');
                    console.log(`ğŸ“¦ ${localData.length} kayÄ±t yerel depodan yÃ¼kleniyor...`);
                    await loadLocalStorageToDataSDK();
                    showNotification('ğŸ”¥ KalÄ±cÄ± veri sistemi aktif!', 'info');
                } else {
                    // ğŸ”¥ Ä°lk kez - kalÄ±cÄ± veriyi yÃ¼kle
                    console.log('ğŸ”¥ KalÄ±cÄ± gÃ¶mÃ¼lÃ¼ veri ilk kez yÃ¼kleniyor...');
                    
                    // Mevcut verileri temizle
                    if (currentData.length > 0) {
                        console.log('ğŸ—‘ï¸ Mevcut veriler temizleniyor...');
                        for (const record of currentData) {
                            await window.dataSdk.delete(record);
                        }
                    }
                    
                    // KalÄ±cÄ± gÃ¶mÃ¼lÃ¼ veriyi yÃ¼kle
                    const embeddedLoaded = await loadEmbeddedData();
                    
                    if (!embeddedLoaded) {
                        // Yedek plan - GitHub'dan Ã§ekmeyi dene
                        console.log('âš ï¸ KalÄ±cÄ± veri yÃ¼klenemedi, GitHub CSV deneniyor...');
                        try {
                            const githubLoaded = await loadFromGitHubCSV(false);
                            if (githubLoaded) {
                                localStorage.setItem(LOADED_FLAG, 'github_fallback');
                                showNotification('âœ… Yedek veri kaynaÄŸÄ±ndan yÃ¼klendi', 'success');
                            } else {
                                showNotification('âŒ HiÃ§bir veri kaynaÄŸÄ± yÃ¼klenemedi', 'error');
                            }
                        } catch (error) {
                            console.error('GitHub yedek yÃ¼kleme hatasÄ±:', error);
                            showNotification('âŒ Veri yÃ¼kleme baÅŸarÄ±sÄ±z', 'error');
                        }
                    }
                }
                
                // TÃ¼m verilerin onay durumlarÄ±nÄ± kontrol et
                updateAllApprovalStatuses();
                
                // Teslimat durumlarÄ±nÄ± gÃ¼ncelle
                setTimeout(() => {
                    updateAllDeliveryStatuses();
                }, 300);
                
                // Grafikleri render et
                setTimeout(() => {
                    renderCharts();
                }, 500);
                
                // Yetkileri tekrar uygula (veri yÃ¼klendikten sonra)
                setTimeout(() => {
                    applyRolePermissions();
                }, 1000);
            }
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99037a2cd276d0d2',t:'MTc2MDc0MjcwOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
