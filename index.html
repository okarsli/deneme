<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SOMTECH â€” SOF v1.8.4 (MultiLang + RoleControl + Loader)</title>
<style>
  :root{
    --bg:#0f1115; --fg:#eaeaea; --muted:#9aa0aa; --accent:#22d3ee;
    --glass:rgba(255,255,255,0.06); --bdr:rgba(255,255,255,0.12);
    --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --info:#60a5fa;
    --navw:240px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:Segoe UI,system-ui,Roboto,Arial,sans-serif}
  a{color:var(--accent);text-decoration:none}
  /* Loader */
  #loader{
    position:fixed;inset:0;background:rgba(6,8,12,.9);backdrop-filter:blur(8px);
    display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;gap:18px;
  }
  .ring{
    width:88px;height:88px;border-radius:50%;border:4px solid rgba(34,211,238,.25);
    border-top-color:var(--accent);animation:spin 1s linear infinite;box-shadow:0 0 22px rgba(34,211,238,.25);
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .loader-brand{display:flex;align-items:center;gap:10px}
  .loader-brand img{width:42px;height:42px;border-radius:12px}
  .loader-sub{color:#9aa0aa}
  .loader-sign{font-style:italic;color:#7c8694}
  /* Sidebar */
  .sidebar{
    position:fixed;left:16px;top:16px;bottom:16px;width:var(--navw);
    background:var(--glass);border:1px solid var(--bdr);border-radius:18px;
    padding:14px;backdrop-filter:blur(12px);box-shadow:0 0 18px rgba(34,211,238,.08);
    display:flex;flex-direction:column;gap:12px;z-index:10;
  }
  .logo{
    display:flex;align-items:center;gap:10px;justify-content:center;
    padding:8px;border-bottom:1px solid var(--bdr); position:relative; z-index:11;
  }
  .logo img.markimg{
    width:40px;height:40px;object-fit:contain;border-radius:10px;
    filter: drop-shadow(0 0 8px rgba(34,211,238,.5));
    background:#0c1118;
  }
  .logo h1{font-size:14px;color:var(--accent);margin:0;white-space:nowrap}
  .nav{display:flex;flex-direction:column;gap:6px;margin-top:6px}
  .nav a{
    display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;color:var(--fg);
    border:1px solid transparent;
  }
  .nav a:hover{background:rgba(255,255,255,.06);border-color:var(--bdr)}
  .nav a.active{background:rgba(34,211,238,.12);border-color:#22d3ee88;box-shadow:0 0 0 2px rgba(34,211,238,.25) inset}
  .grow{flex:1}
  .nav-footer{font-size:12px;color:var(--muted);text-align:center;padding-top:6px;border-top:1px solid var(--bdr)}
  /* Header controls */
  .topbar{
    position:sticky;top:0;z-index:5;
    margin-left:calc(var(--navw) + 32px);
    background:var(--glass);backdrop-filter:blur(10px);border-bottom:1px solid var(--bdr);
    display:flex;justify-content:flex-end;gap:10px;align-items:center;padding:10px 16px;
  }
  select,.btn{background:#0e1a1c;border:1px solid var(--bdr);color:var(--fg);border-radius:10px;padding:8px 10px;font-weight:600}
  .btn{cursor:pointer}
  .flag{cursor:pointer;font-size:18px;line-height:1}
  /* Main content */
  main{max-width:1200px;margin-left:calc(var(--navw) + 32px);padding:18px 16px}
  .card{background:var(--glass);border:1px solid var(--bdr);border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 0 12px rgba(34,211,238,.06)}
  h2{margin:0 0 12px 0;font-size:18px;color:var(--accent)}
  .muted{color:var(--muted);font-size:12px}
  /* Summary cards */
  .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  .kpi{background:#0e1a1c;border:1px solid var(--bdr);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:6px}
  .kpi .label{font-size:12px;color:#9aa0aa}
  .kpi .value{font-size:20px;font-weight:800}
  /* Tables */
  table{width:100%;border-collapse:collapse;table-layout:fixed}
  th,td{padding:10px 12px;border-bottom:1px solid var(--bdr);text-align:left;vertical-align:middle;font-size:14px}
  th{color:var(--accent);font-weight:700}
  tr:hover{background:rgba(255,255,255,.03)}
  .status-pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800}
  .st-wait{background:rgba(245,158,11,.15);color:#f59e0b}
  .st-acc{background:rgba(34,197,94,.15);color:#22c55e}
  .st-pay{background:rgba(96,165,250,.15);color:#60a5fa}
  .st-done{background:rgba(148,163,184,.2);color:#cbd5e1}
  .st-rej{background:rgba(239,68,68,.18);color:#ef4444}
  .row-toggle{cursor:pointer;color:var(--accent);font-weight:900;text-align:center}
  .details-row{display:none}
  /* Subtable alignment improvements */
  .subwrap{background:#14161a;border-top:1px solid #22d3ee55;border-bottom:1px solid #22d3ee55;border-radius:10px;margin-top:6px}
  .sub{width:100%}
  .subhead th{font-size:13px}
  .sub td{border-bottom:1px solid #1e2025}
  .sub tr:last-child td{border-bottom:none}
  .sub th:nth-child(1), .sub td:nth-child(1){width:22%}
  .sub th:nth-child(2), .sub td:nth-child(2){width:8%;text-align:center}
  .sub th:nth-child(3), .sub td:nth-child(3){width:8%;text-align:center}
  .sub th:nth-child(4), .sub td:nth-child(4){width:26%}
  .sub th:nth-child(5), .sub td:nth-child(5){width:24%}
  .sub th:nth-child(6), .sub td:nth-child(6){width:12%;text-align:center}
  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50}
  .sheet{width:min(1000px,92vw);max-height:86vh;overflow:auto;background:#0c1016;border:1px solid var(--bdr);border-radius:16px;padding:16px}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .timeline{border-left:2px solid var(--accent);margin-left:10px;padding-left:12px}
  footer{text-align:center;color:#9aa0aa;padding:12px;border-top:1px solid var(--bdr);margin-top:10px}
  /* Responsive */
  @media (max-width:980px){
    .sidebar{position:fixed;transform:translateX(-120%);transition:.3s;left:12px;right:auto}
    .sidebar.open{transform:none}
    .topbar{margin-left:12px}
    main{margin-left:12px}
    .menu-btn{display:inline-block}
    .grid{grid-template-columns:repeat(2,minmax(0,1fr))}
  }
  @media (max-width:640px){
    .grid{grid-template-columns:1fr}
  }
  .menu-btn{display:none;margin-right:auto}
  .disabled{opacity:.55;pointer-events:none;filter:grayscale(.3)}
</style>
</head>
<body>

<!-- Loader -->
<div id="loader">
  <div class="loader-brand">
    <img src="https://i.hizliresim.com/ot1wnpw.png" alt="SOMTECH" />
    <h2 style="margin:0;color:#22d3ee">SOMTECH â€” SOF</h2>
  </div>
  <div class="ring"></div>
  <div class="loader-sub" data-i18n="connecting">Sisteme baÄŸlanÄ±yorâ€¦</div>
  <div class="loader-sign">System engineered with precision by <b>Karsli</b> âš™ï¸</div>
</div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="logo">
    <a href="https://somtech.ru" target="_blank" title="SOMTECH">
      <img class="markimg" src="https://i.hizliresim.com/ot1wnpw.png" alt="SOMTECH Logo" />
    </a>
    <h1>SOMTECH â€” SOF</h1>
  </div>
  <nav class="nav" id="navLinks">
    <a href="#sec-summary" data-section="sec-summary">ğŸ  <span data-i18n="summary">Ã–zet</span></a>
    <a href="#sec-ledger" class="active" data-section="sec-ledger">ğŸ·ï¸ <span data-i18n="ledger">SatÄ±n Alma Defteri</span></a>
    <a href="#sec-mine" data-section="sec-mine">ğŸ“¦ <span data-i18n="mine">Taleplerim</span></a>
    <a href="#sec-approvals" data-section="sec-approvals">ğŸ›¡ï¸ <span data-i18n="approvals">Onaylar</span></a>
    <a href="#sec-payments" data-section="sec-payments">ğŸ’° <span data-i18n="payments">Ã–demeler</span></a>
    <a href="#sec-proc" data-section="sec-proc">ğŸ›’ <span data-i18n="procurement">SatÄ±n Alma</span></a>
  </nav>
  <div class="grow"></div>
  <div class="nav-footer">v1.8.4 â€¢ MultiLang + RoleControl + Loader</div>
</aside>

<!-- Topbar -->
<div class="topbar">
  <button class="btn menu-btn" onclick="toggleSidebar()">â˜°</button>
  <span class="muted" data-i18n="language">Dil</span>
  <span id="flag-tr" class="flag" title="TÃ¼rkÃ§e">ğŸ‡¹ğŸ‡·</span>
  <span id="flag-ru" class="flag" title="Ğ ÑƒÑÑĞºĞ¸Ğ¹">ğŸ‡·ğŸ‡º</span>
  <span id="flag-en" class="flag" title="English">ğŸ‡¬ğŸ‡§</span>
  <button class="btn" id="themeBtn" title="Tema">ğŸŒ™</button>
  <span class="muted" data-i18n="role">Rol</span>
  <select id="roleSel">
    <option>Birim KullanÄ±cÄ±sÄ±</option>
    <option>MÃ¼dÃ¼r</option>
    <option>Muhasebe</option>
    <option>SatÄ±n Alma</option>
    <option>Admin</option>
  </select>
</div>

<main>
  <!-- Summary -->
  <section class="card" id="sec-summary">
    <h2>ğŸ  <span data-i18n="summary">Ã–zet</span></h2>
    <div class="grid">
      <div class="kpi"><div class="label" data-i18n="totalRequests">Toplam Talep SayÄ±sÄ±</div><div class="value" id="kpi-total">0</div></div>
      <div class="kpi"><div class="label" data-i18n="pendingApprovals">Onay Bekleyen SayÄ±sÄ±</div><div class="value" id="kpi-approve">0</div></div>
      <div class="kpi"><div class="label" data-i18n="pendingPayments">Ã–deme Bekleyen SayÄ±sÄ±</div><div class="value" id="kpi-pay">0</div></div>
      <div class="kpi"><div class="label" data-i18n="lastAction">Son Ä°ÅŸlem Tarihi</div><div class="value" id="kpi-last">â€”</div></div>
      <div class="kpi"><div class="label" data-i18n="totalFixed">Toplam DemirbaÅŸ Adedi</div><div class="value" id="kpi-demirbas">0</div></div>
      <div class="kpi"><div class="label" data-i18n="totalConsumable">Toplam Sarf Adedi</div><div class="value" id="kpi-sarf">0</div></div>
    </div>
  </section>

  <!-- Ledger -->
  <section class="card" id="sec-ledger">
    <h2>ğŸ“˜ <span data-i18n="ledger">SatÄ±n Alma Defteri</span></h2>
    <table>
      <thead><tr>
        <th style="width:6%"></th>
        <th style="width:20%" data-i18n="sofno">SOF No</th>
        <th style="width:15%" data-i18n="status">Durum</th>
        <th style="width:18%" data-i18n="mainType">Ana TÃ¼r</th>
        <th style="width:10%" data-i18n="items">Kalem</th>
        <th style="width:16%" data-i18n="due">Termin</th>
        <th style="width:15%" data-i18n="dsType">DemirbaÅŸ/Sarf</th>
      </tr></thead>
      <tbody id="ledgerBody"></tbody>
    </table>
    <div class="muted" style="margin-top:6px" data-i18n="rowHint">SatÄ±ra tÄ±klayÄ±p alt detaylarÄ± aÃ§abilirsiniz.</div>
  </section>

  <!-- Mine -->
  <section class="card" id="sec-mine">
    <h2>ğŸ“¦ <span data-i18n="mine">Taleplerim</span></h2>
    <table><thead><tr>
      <th data-i18n="sofno">SOF No</th><th data-i18n="material">Malzeme</th><th data-i18n="quantity">Miktar</th><th data-i18n="status">Durum</th>
    </tr></thead><tbody id="mineBody"></tbody></table>
  </section>

  <!-- Approvals -->
  <section class="card" id="sec-approvals">
    <h2>ğŸ›¡ï¸ <span data-i18n="approvals">Onaylar</span></h2>
    <table><thead><tr>
      <th data-i18n="sofno">SOF No</th><th data-i18n="items">Kalem</th><th data-i18n="mainType">Ana TÃ¼r</th><th data-i18n="action">Ä°ÅŸlem</th>
    </tr></thead><tbody id="approvalsBody"></tbody></table>
  </section>

  <!-- Payments -->
  <section class="card" id="sec-payments">
    <h2>ğŸ’° <span data-i18n="payments">Ã–demeler</span></h2>
    <table><thead><tr>
      <th data-i18n="sofno">SOF No</th><th data-i18n="amount">Tutar (â‚½)</th><th data-i18n="vendor">TedarikÃ§i</th><th data-i18n="proforma">Ã–n Fatura</th><th data-i18n="action">Ä°ÅŸlem</th>
    </tr></thead><tbody id="paymentsBody"></tbody></table>
  </section>

  <!-- Procurement -->
  <section class="card" id="sec-proc">
    <h2>ğŸ›’ <span data-i18n="procurement">SatÄ±n Alma</span></h2>
    <table>
      <thead><tr>
        <th data-i18n="sofno">SOF No</th><th data-i18n="amount">Tutar (â‚½)</th><th data-i18n="vendor">TedarikÃ§i</th><th data-i18n="due">Termin</th><th data-i18n="proforma">Ã–n Fatura</th><th data-i18n="note">AÃ§Ä±klama</th><th data-i18n="save">Kaydet</th>
      </tr></thead>
      <tbody id="procBody"></tbody>
    </table>
  </section>

  <footer>System engineered with precision by <b>Karsli</b> âš™ï¸ â€” v1.8.4</footer>
</main>

<!-- Timeline Modal -->
<div id="tlModal" class="modal" onclick="closeModal(event)">
  <div class="sheet">
    <h3>ğŸ“ˆ <span data-i18n="timeline">SÃ¼reÃ§ Takibi</span> â€” <span id="tlSof"></span></h3>
    <div class="timeline" id="tlBody"></div>
    <div class="right"><button class="btn" onclick="modalHide()" data-i18n="close">Kapat</button></div>
  </div>
</div>

<!-- PDF Modal -->
<div id="pdfModal" class="modal" onclick="pdfClose(event)">
  <div class="sheet" style="width:min(1100px,92vw);height:min(86vh,900px)">
    <h3>ğŸ“„ <span data-i18n="proformaView">Ã–n Fatura GÃ¶rÃ¼ntÃ¼leme</span></h3>
    <embed id="pdfViewer" type="application/pdf" width="100%" height="80%">
    <div class="right"><button class="btn" onclick="pdfHide()" data-i18n="close">Kapat</button></div>
  </div>
</div>

<script>
function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('open'); }

// SPA Navigation
document.querySelectorAll('#navLinks a').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    const target = a.getAttribute('href').substring(1);
    switchSection(target);
    document.querySelectorAll('#navLinks a').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    history.replaceState(null,'','#'+target);
  });
});

function switchSection(id){
  document.querySelectorAll('main > section').forEach(sec=>sec.style.display='none');
  const el = document.getElementById(id);
  if(el){ el.style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); }
}

// Preserve active on load if hash present
window.addEventListener('load', ()=>{
  const hash = location.hash ? location.hash.substring(1) : 'sec-ledger';
  switchSection(hash);
  document.querySelectorAll('#navLinks a').forEach(x=>{
    if(x.getAttribute('href') === '#'+hash) x.classList.add('active'); else x.classList.remove('active');
  });
});

// ==== App State (keep previous data, no deletion) ====
const app = { 
  role: localStorage.getItem('sof_role') || 'Birim KullanÄ±cÄ±sÄ±', 
  theme: localStorage.getItem('sof_theme') || 'dark', 
  lang: localStorage.getItem('sof_lang') || 'tr',
  requests: [] 
};
const $ = s => document.querySelector(s);
function ts(){ return new Date().toLocaleString(); }
function persist(){ localStorage.setItem('sof_state_v184', JSON.stringify(app)); }
function load(){ 
  const raw184=localStorage.getItem('sof_state_v184'); 
  const raw183=localStorage.getItem('sof_state_v183'); 
  const raw182=localStorage.getItem('sof_state_v182'); 
  const src = raw184 || raw183 || raw182;
  if(src){ try{ Object.assign(app, JSON.parse(src)); }catch(e){} } 
}

function seed(){
  // do not overwrite if data exists
  if((app.requests||[]).length) return;
  // same seed as previous + safe to extend in future
  app.requests = [
    { sof:'SMT-SOFD-0003', typeDS:'D', anaTur:'Mobilya',
      lines:[
        {item:'Masa', qty:1, unit:'adet', info:'DoÄŸal ahÅŸap', note:'Ã‡alÄ±ÅŸma masasÄ±', link:''},
        {item:'Sandalye', qty:1, unit:'adet', info:'Ergonomik', note:'Ofis sandalyesi', link:''},
        {item:'Klavye', qty:1, unit:'adet', info:'Mekanik', note:'USB kablolu', link:''}
      ],
      status:'OnaylandÄ±',
      procurement:{fiyat:120000, tedarikci:'SomTech', termin:'2025-10-25', onFatura:'Proforma_0003.pdf', aciklama:'Set alÄ±mÄ±'},
      history:[{step:'Onay Bekliyor',at:ts(),by:'Birim'},{step:'OnaylandÄ±',at:ts(),by:'MÃ¼dÃ¼r'}],
      createdBy:'Birim KullanÄ±cÄ±sÄ±'
    },
    { sof:'SMT-SOFS-0002', typeDS:'S', anaTur:'Elektrik',
      lines:[{item:'Cat6 Kablo', qty:50, unit:'mt', info:'LSZH', note:'Turuncu', link:''}],
      status:'Ã–deme Bekliyor',
      procurement:{fiyat:8500, tedarikci:'Koryon', termin:'2025-10-28', onFatura:'Koryon_pre.pdf', aciklama:''},
      history:[{step:'Onay Bekliyor',at:ts(),by:'Birim'},{step:'OnaylandÄ±',at:ts(),by:'MÃ¼dÃ¼r'},{step:'SatÄ±n Alma',at:ts(),by:'SatÄ±n Alma'},{step:'Ã–deme Bekliyor',at:ts(),by:'SatÄ±n Alma'}],
      createdBy:'Birim KullanÄ±cÄ±sÄ±'
    }
  ];
  persist();
}

// Theme
function applyTheme(){
  document.getElementById('themeBtn').textContent = app.theme==='dark' ? 'ğŸŒ™' : 'â˜€ï¸';
  document.body.style.background = app.theme==='dark' ? '#0f1115' : '#f6f7fb';
  document.body.style.color = app.theme==='dark' ? '#eaeaea' : '#222';
}
document.getElementById('themeBtn').onclick = ()=>{ app.theme=app.theme==='dark'?'light':'dark'; localStorage.setItem('sof_theme',app.theme); applyTheme(); };

function setRole(r){ app.role=r; localStorage.setItem('sof_role',r); applyRoleMenu(); renderAll(); }
document.getElementById('roleSel').addEventListener('change', (e)=> setRole(e.target.value));

// Role-based navigation + permission
function applyRoleMenu(){
  const role = app.role;
  const show = id => { const el = document.querySelector(`[data-section="${id}"]`); if(el) el.style.display='flex'; };
  const hide = id => { const el = document.querySelector(`[data-section="${id}"]`); if(el) el.style.display='none'; };

  // default hide all
  ['sec-summary','sec-ledger','sec-mine','sec-approvals','sec-payments','sec-proc'].forEach(id=>hide(id));

  // Everyone sees Summary + Ledger
  show('sec-summary'); show('sec-ledger');

  if(role==='Birim KullanÄ±cÄ±sÄ±'){ show('sec-mine'); }
  else if(role==='MÃ¼dÃ¼r'){ show('sec-approvals'); }
  else if(role==='Muhasebe'){ show('sec-payments'); }
  else if(role==='SatÄ±n Alma'){ show('sec-approvals'); show('sec-payments'); show('sec-proc'); }
  else { // Admin
    ['sec-mine','sec-approvals','sec-payments','sec-proc'].forEach(id=>show(id));
  }

  // If current hash points to hidden section, fallback to ledger
  const current = (location.hash||'#sec-ledger').substring(1);
  const currentLink = document.querySelector(`[data-section="${current}"]`);
  if(!currentLink || currentLink.style.display==='none'){
    switchSection('sec-ledger');
    document.querySelectorAll('#navLinks a').forEach(x=>x.classList.remove('active'));
    document.querySelector('[data-section="sec-ledger"]').classList.add('active');
  }

  // Permissions: make approvals/payments read-only for 'SatÄ±n Alma'
  const ro = (role==='SatÄ±n Alma');
  document.body.dataset.readonlyApprovals = ro ? '1' : '0';
}

// Render helpers
function pill(status){
  const cls = {'Onay Bekliyor':'st-wait','OnaylandÄ±':'st-acc','SatÄ±n Alma':'st-acc','Ã–deme Bekliyor':'st-pay','Ã–deme YapÄ±ldÄ±':'st-done','Reddedildi':'st-rej'}[status]||'st-wait';
  return `<span class="status-pill ${cls}">${status}</span>`;
}
function fmtDate(iso){ if(!iso) return 'â€”'; try{ const d=new Date(iso); return d.toLocaleDateString(); }catch(e){ return 'â€”'; }}

// Ledger
function renderLedger(){
  const body = document.getElementById('ledgerBody'); body.innerHTML='';
  app.requests.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="row-toggle" onclick="toggleDetails(${i})">â–¶</td>
      <td>${r.sof}</td><td>${pill(r.status)}</td><td>${r.anaTur||'â€”'}</td><td>${r.lines.length}</td>
      <td>${fmtDate(r.procurement?.termin)}</td><td>${r.typeDS==='D'?'DemirbaÅŸ':'Sarf'}</td>`;
    tr.ondblclick = ()=> openTimeline(r.sof);
    body.appendChild(tr);

    const dtr = document.createElement('tr');
    dtr.className='details-row'; dtr.id='det-'+i;
    dtr.innerHTML = `<td colspan="7"><div class="subwrap">
      <table class="sub">
        <thead class="subhead">
          <tr>
            <th data-i18n="material">Malzeme</th>
            <th data-i18n="quantityShort">Miktar</th>
            <th data-i18n="unit">Birim</th>
            <th data-i18n="detailInfo">Detay Bilgi</th>
            <th data-i18n="note">AÃ§Ä±klama</th>
            <th data-i18n="proformaOrLink">Ã–n Fatura / Link</th>
          </tr>
        </thead>
        <tbody>${r.lines.map(l=>`
          <tr><td>${l.item||''}</td><td style="text-align:center">${l.qty||''}</td><td style="text-align:center">${l.unit||''}</td><td>${l.info||''}</td><td>${l.note||''}</td>
              <td style="text-align:center">${r.procurement?.onFatura? `<a href="#" onclick="showPdf('${r.sof}')">ğŸ“„ ${r.procurement.onFatura}</a>` : (l.link? `<a href="${l.link}" target="_blank">ğŸ”— link</a>`:'â€”')}</td></tr>`).join('')}
        </tbody>
      </table></div></td>`;
    body.appendChild(dtr);
  });
}
function toggleDetails(idx){
  const row=document.getElementById('det-'+idx);
  const headerCell=document.getElementById('ledgerBody').children[idx*2].children[0];
  if(row.style.display==='table-row'){ row.style.display='none'; headerCell.textContent='â–¶'; }
  else{ row.style.display='table-row'; headerCell.textContent='â–¼'; }
}

// Mine
function renderMine(){
  const body=document.getElementById('mineBody'); body.innerHTML='';
  app.requests.filter(r=>r.createdBy===app.role).forEach(r=>{
    const l=r.lines[0]||{}; const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.sof}</td><td>${l.item||''}</td><td>${(l.qty||'')+' '+(l.unit||'')}</td><td>${pill(r.status)}</td>`;
    tr.ondblclick=()=>openTimeline(r.sof); body.appendChild(tr);
  });
}

// Approvals
function renderApprovals(){
  const body=document.getElementById('approvalsBody'); body.innerHTML='';
  app.requests.filter(r=>r.status==='Onay Bekliyor').forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.sof}</td><td>${r.lines.length}</td><td>${r.anaTur||'â€”'}</td>
      <td>
        <button class="btn ${document.body.dataset.readonlyApprovals==='1'?'disabled':''}" onclick="approve('${r.sof}')" data-i18n="approveBtn">âœ… Onayla</button>
        <button class="btn ${document.body.dataset.readonlyApprovals==='1'?'disabled':''}" onclick="rejectPrompt('${r.sof}')" data-i18n="rejectBtn">âŒ Reddet</button>
      </td>`;
    body.appendChild(tr);
  });
}

// Payments
function renderPayments(){
  const body=document.getElementById('paymentsBody'); body.innerHTML='';
  app.requests.filter(r=>r.status==='Ã–deme Bekliyor').forEach(r=>{
    const f=r.procurement||{}; const pf=f.onFatura? `<a href="#" onclick="showPdf('${r.sof}')">${f.onFatura}</a>`:'â€”';
    const ro = document.body.dataset.readonlyApprovals==='1';
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.sof}</td><td>${f.fiyat||0}</td><td>${f.tedarikci||'-'}</td><td>${pf}</td>
      <td><button class="btn ${ro?'disabled':''}" onclick="markPaid('${r.sof}')" data-i18n="markPaidBtn">ğŸ’¸ Ã–deme YapÄ±ldÄ±</button></td>`;
    body.appendChild(tr);
  });
}

// Procurement
function renderProc(){
  const body=document.getElementById('procBody'); body.innerHTML='';
  app.requests.filter(r=>r.status==='OnaylandÄ±' || r.status==='SatÄ±n Alma').forEach(r=>{
    const p=r.procurement||{};
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.sof}</td>
      <td><input type="number" step="0.01" value="${p.fiyat||''}" style="width:120px;background:#0e1a1c;border:1px solid var(--bdr);color:var(--fg);border-radius:10px;padding:6px"></td>
      <td><input value="${p.tedarikci||''}" style="width:160px;background:#0e1a1c;border:1px solid var(--bdr);color:var(--fg);border-radius:10px;padding:6px"></td>
      <td><input type="date" value="${p.termin||''}" style="background:#0e1a1c;border:1px solid var(--bdr);color:var(--fg);border-radius:10px;padding:6px"></td>
      <td><input type="file" accept="application/pdf" style="color:#cbd5e1"></td>
      <td><input value="${p.aciklama||''}" style="width:180px;background:#0e1a1c;border:1px solid var(--bdr);color:var(--fg);border-radius:10px;padding:6px"></td>
      <td><button class="btn" onclick="saveProc(this,'${r.sof}')" data-i18n="save">Kaydet</button></td>`;
    body.appendChild(tr);
  });
}

// Actions
function approve(sof){ if(document.body.dataset.readonlyApprovals==='1') return; const r=app.requests.find(x=>x.sof===sof); if(!r) return; r.status='OnaylandÄ±'; pushHistory(r,'OnaylandÄ±'); persist(); renderAll(); }
function rejectPrompt(sof){ if(document.body.dataset.readonlyApprovals==='1') return; const r=app.requests.find(x=>x.sof===sof); if(!r) return; const txt=prompt(i18n('rejectReason')); r.status='Reddedildi'; if(txt) r.rejectReason=txt; pushHistory(r,'Reddedildi'); persist(); renderAll(); }
function pushHistory(r, step){ r.history=r.history||[]; r.history.push({step,at:ts(),by:app.role}); }
function saveProc(btn, sof){
  const tr=btn.closest('tr'); const inputs=tr.querySelectorAll('input');
  const r=app.requests.find(x=>x.sof===sof); if(!r) return;
  r.procurement = {
    fiyat: parseFloat(inputs[0].value||'0'),
    tedarikci: inputs[1].value.trim(),
    termin: inputs[2].value,
    onFatura: inputs[3].files && inputs[3].files[0] ? inputs[3].files[0].name : (r.procurement?.onFatura||''),
    aciklama: inputs[4].value.trim()
  };
  r.status='Ã–deme Bekliyor'; pushHistory(r,'SatÄ±n Alma'); pushHistory(r,'Ã–deme Bekliyor');
  persist(); renderAll();
}
function markPaid(sof){ if(document.body.dataset.readonlyApprovals==='1') return; const r=app.requests.find(x=>x.sof===sof); if(!r) return; r.status='Ã–deme YapÄ±ldÄ±'; pushHistory(r,'Ã–deme YapÄ±ldÄ±'); persist(); renderAll(); }

// Timeline + PDF
function openTimeline(sof){
  const r=app.requests.find(x=>x.sof===sof); if(!r) return;
  document.getElementById('tlSof').textContent = sof;
  const tl=document.getElementById('tlBody'); tl.innerHTML='';
  (r.history||[]).forEach(h=>{
    const div=document.createElement('div'); div.className='t';
    div.innerHTML=`<b>${h.step}</b><div class="muted">${h.at} â€” ${h.by}${r.rejectReason && h.step==='Reddedildi' ? '<br><i>'+i18n('reason')+': '+r.rejectReason+'</i>':''}</div>`;
    tl.appendChild(div);
  });
  document.getElementById('tlModal').style.display='flex';
}
function modalHide(){ document.getElementById('tlModal').style.display='none'; }
function closeModal(e){ if(e.target.id==='tlModal') modalHide(); }

function showPdf(sof){
  const r=app.requests.find(x=>x.sof===sof); if(!r) return;
  const src = r.procurement?.onFatura ? 'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf' : 'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf';
  document.getElementById('pdfViewer').src = src;
  document.getElementById('pdfModal').style.display='flex';
}
function pdfHide(){ document.getElementById('pdfModal').style.display='none'; }
function pdfClose(e){ if(e.target.id==='pdfModal') pdfHide(); }

// Summary compute
function renderSummary(){
  const all=app.requests||[];
  $('#kpi-total').textContent = all.length;
  $('#kpi-approve').textContent = all.filter(r=>r.status==='Onay Bekliyor').length;
  $('#kpi-pay').textContent = all.filter(r=>r.status==='Ã–deme Bekliyor').length;
  const last = all.flatMap(r=> (r.history||[])).map(h=>h.at).sort().slice(-1)[0];
  $('#kpi-last').textContent = last || 'â€”';
  $('#kpi-demirbas').textContent = all.filter(r=>r.typeDS==='D').length;
  $('#kpi-sarf').textContent = all.filter(r=>r.typeDS==='S').length;
}

// i18n
const LANG = {
  tr: {
    connecting:"Sisteme baÄŸlanÄ±yorâ€¦", language:"Dil", role:"Rol", summary:"Ã–zet", ledger:"SatÄ±n Alma Defteri", mine:"Taleplerim",
    approvals:"Onaylar", payments:"Ã–demeler", procurement:"SatÄ±n Alma", sofno:"SOF No", status:"Durum", mainType:"Ana TÃ¼r", items:"Kalem", due:"Termin", dsType:"DemirbaÅŸ/Sarf",
    rowHint:"SatÄ±ra tÄ±klayÄ±p alt detaylarÄ± aÃ§abilirsiniz.", material:"Malzeme", quantity:"Miktar", quantityShort:"Miktar", unit:"Birim", detailInfo:"Detay Bilgi", note:"AÃ§Ä±klama",
    proforma:"Ã–n Fatura", proformaOrLink:"Ã–n Fatura / Link", action:"Ä°ÅŸlem", amount:"Tutar (â‚½)", vendor:"TedarikÃ§i", save:"Kaydet", timeline:"SÃ¼reÃ§ Takibi", close:"Kapat",
    proformaView:"Ã–n Fatura GÃ¶rÃ¼ntÃ¼leme", approveBtn:"âœ… Onayla", rejectBtn:"âŒ Reddet", markPaidBtn:"ğŸ’¸ Ã–deme YapÄ±ldÄ±", rejectReason:"Red sebebi (opsiyonel):",
    reason:"Sebep", totalRequests:"Toplam Talep SayÄ±sÄ±", pendingApprovals:"Onay Bekleyen SayÄ±sÄ±", pendingPayments:"Ã–deme Bekleyen SayÄ±sÄ±",
    lastAction:"Son Ä°ÅŸlem Tarihi", totalFixed:"Toplam DemirbaÅŸ Adedi", totalConsumable:"Toplam Sarf Adedi"
  },
  ru: {
    connecting:"ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº ÑĞ¸ÑÑ‚ĞµĞ¼Ğµâ€¦", language:"Ğ¯Ğ·Ñ‹Ğº", role:"Ğ Ğ¾Ğ»ÑŒ", summary:"Ğ¡Ğ²Ğ¾Ğ´ĞºĞ°", ledger:"Ğ–ÑƒÑ€Ğ½Ğ°Ğ» Ğ·Ğ°ĞºÑƒĞ¿Ğ¾Ğº", mine:"ĞœĞ¾Ğ¸ Ğ·Ğ°ÑĞ²ĞºĞ¸",
    approvals:"Ğ¡Ğ¾Ğ³Ğ»Ğ°ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ñ", payments:"ĞŸĞ»Ğ°Ñ‚ĞµĞ¶Ğ¸", procurement:"Ğ—Ğ°ĞºÑƒĞ¿ĞºĞ°", sofno:"ĞĞ¾Ğ¼ĞµÑ€ SOF", status:"Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ", mainType:"ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ", items:"ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸", due:"Ğ¡Ñ€Ğ¾Ğº", dsType:"ĞĞ¡/Ğ Ğ°ÑÑ…Ğ¾Ğ´",
    rowHint:"ĞšĞ»Ğ¸ĞºĞ½Ğ¸Ñ‚Ğµ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ¾ĞºĞµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸.", material:"ĞœĞ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»", quantity:"ĞšĞ¾Ğ»-Ğ²Ğ¾", quantityShort:"ĞšĞ¾Ğ»-Ğ²Ğ¾", unit:"Ğ•Ğ´.", detailInfo:"ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾", note:"ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ",
    proforma:"ĞŸÑ€Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ°", proformaOrLink:"ĞŸÑ€Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ° / Ğ¡ÑÑ‹Ğ»ĞºĞ°", action:"Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ", amount:"Ğ¡ÑƒĞ¼Ğ¼Ğ° (â‚½)", vendor:"ĞŸĞ¾ÑÑ‚Ğ°Ğ²Ñ‰Ğ¸Ğº", save:"Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ", timeline:"Ğ¥Ğ¾Ğ´ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ°", close:"Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ",
    proformaView:"ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ¿Ñ€Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ñ‹", approveBtn:"âœ… Ğ£Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ", rejectBtn:"âŒ ĞÑ‚ĞºĞ»Ğ¾Ğ½Ğ¸Ñ‚ÑŒ", markPaidBtn:"ğŸ’¸ ĞĞ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾", rejectReason:"ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ¾Ñ‚ĞºĞ°Ğ·Ğ° (Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾):",
    reason:"ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°", totalRequests:"Ğ’ÑĞµĞ³Ğ¾ Ğ·Ğ°ÑĞ²Ğ¾Ğº", pendingApprovals:"Ğ’ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğ¸ ÑƒÑ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ", pendingPayments:"Ğ’ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹",
    lastAction:"ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ", totalFixed:"Ğ’ÑĞµĞ³Ğ¾ ĞĞ¡", totalConsumable:"Ğ’ÑĞµĞ³Ğ¾ Ñ€Ğ°ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ñ…"
  },
  en: {
    connecting:"Connecting to the systemâ€¦", language:"Language", role:"Role", summary:"Summary", ledger:"Purchase Ledger", mine:"My Requests",
    approvals:"Approvals", payments:"Payments", procurement:"Procurement", sofno:"SOF No", status:"Status", mainType:"Main Type", items:"Items", due:"Due Date", dsType:"Fixed/Consumable",
    rowHint:"Click a row to expand details.", material:"Material", quantity:"Quantity", quantityShort:"Qty", unit:"Unit", detailInfo:"Detail Info", note:"Note",
    proforma:"Proforma", proformaOrLink:"Proforma / Link", action:"Action", amount:"Amount (â‚½)", vendor:"Vendor", save:"Save", timeline:"Process Timeline", close:"Close",
    proformaView:"View Proforma", approveBtn:"âœ… Approve", rejectBtn:"âŒ Reject", markPaidBtn:"ğŸ’¸ Mark Paid", rejectReason:"Rejection reason (optional):",
    reason:"Reason", totalRequests:"Total Requests", pendingApprovals:"Pending Approvals", pendingPayments:"Pending Payments",
    lastAction:"Last Action Time", totalFixed:"Total Fixed Assets", totalConsumable:"Total Consumables"
  }
};
function i18n(key){
  const dict = LANG[app.lang]||LANG.tr;
  return dict[key]||key;
}
function applyLang(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    el.textContent = i18n(key);
  });
  localStorage.setItem('sof_lang', app.lang);
}
document.getElementById('flag-tr').onclick = ()=>{ app.lang='tr'; applyLang(); };
document.getElementById('flag-ru').onclick = ()=>{ app.lang='ru'; applyLang(); };
document.getElementById('flag-en').onclick = ()=>{ app.lang='en'; applyLang(); };

function init(){
  load(); seed();
  document.getElementById('roleSel').value = app.role;
  applyTheme(); applyLang(); applyRoleMenu(); renderAll();
  // Loader hide
  setTimeout(()=>{ document.getElementById('loader').style.display='none'; }, 1000);
  // Default section if none
  if(!location.hash){ switchSection('sec-ledger'); document.querySelectorAll('#navLinks a').forEach(x=>x.classList.remove('active')); document.querySelector('[data-section="sec-ledger"]').classList.add('active'); }
}
function renderAll(){ renderSummary(); renderLedger(); renderMine(); renderApprovals(); renderPayments(); renderProc(); }
init();
</script>
</body>
</html>
